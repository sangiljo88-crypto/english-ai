<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>My English Coach</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js/+esm",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/",
    "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.7/modules/talkinghead.mjs"
  }
}
</script>
<style>
:root{
  --primary:#4F46E5;--primary-light:#818CF8;--primary-dark:#3730A3;
  --bg:#F8FAFC;--card:#FFFFFF;--text:#1E293B;--text-secondary:#64748B;
  --success:#10B981;--warning:#F59E0B;--danger:#EF4444;--info:#3B82F6;
  --xp-bar:#10B981;
  --radius:16px;--radius-sm:12px;--shadow:0 2px 12px rgba(0,0,0,0.08);
  --tab-height:72px;
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);
  min-height:100vh;min-height:100dvh;overflow-x:hidden;
  padding-bottom:calc(var(--tab-height) + var(--safe-bottom) + 8px);
}
button{font-family:inherit;cursor:pointer;border:none;outline:none;}
input,textarea{font-family:inherit;outline:none;}

/* === SPLASH === */
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#4F46E5,#7C3AED);
  display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;
  transition:opacity .6s,visibility .6s;}
#splash.hidden{opacity:0;visibility:hidden;pointer-events:none;}
#splash h1{font-size:28px;font-weight:800;margin-top:16px;}
#splash p{font-size:14px;opacity:.8;margin-top:4px;}
.splash-tree{font-size:64px;animation:splashPulse 1.5s infinite;}
@keyframes splashPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}

/* === ONBOARDING === */
#onboarding{position:fixed;inset:0;z-index:9998;background:#fff;display:none;flex-direction:column;}
#onboarding.active{display:flex;}
.onb-page{flex:1;display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center;}
.onb-page.active{display:flex;}
.onb-page .emoji{font-size:80px;margin-bottom:20px;}
.onb-page h2{font-size:22px;font-weight:700;margin-bottom:8px;}
.onb-page p{font-size:14px;color:var(--text-secondary);line-height:1.6;max-width:320px;}
.onb-dots{display:flex;gap:8px;justify-content:center;padding:16px;}
.onb-dots span{width:8px;height:8px;border-radius:50%;background:#E2E8F0;transition:.3s;}
.onb-dots span.active{background:var(--primary);width:24px;border-radius:4px;}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 28px;
  border-radius:var(--radius-sm);font-size:15px;font-weight:600;transition:.2s;gap:8px;}
.btn-primary{background:var(--primary);color:#fff;}
.btn-primary:hover{background:var(--primary-dark);}
.btn-primary:active{transform:scale(.97);}
.btn-secondary{background:#EEF2FF;color:var(--primary);}
.btn-outline{background:transparent;border:2px solid #E2E8F0;color:var(--text);}
.btn-outline.selected{border-color:var(--primary);background:#EEF2FF;color:var(--primary);}
.btn-sm{padding:10px 18px;font-size:13px;border-radius:10px;}
.btn-danger{background:var(--danger);color:#fff;}
.btn-full{width:100%;}

/* === API KEY INPUT === */
.api-input-wrap{width:100%;max-width:340px;margin:16px 0;}
.api-input-wrap input{width:100%;padding:14px 16px;border:2px solid #E2E8F0;border-radius:var(--radius-sm);
  font-size:14px;transition:.2s;}
.api-input-wrap input:focus{border-color:var(--primary);}
.api-input-wrap small{display:block;margin-top:6px;color:var(--text-secondary);font-size:11px;}

/* === HEADER === */
.app-header{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);
  backdrop-filter:blur(12px);padding:12px 16px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid #F1F5F9;}
.app-header .tree-icon{font-size:28px;}
.header-info{flex:1;}
.header-info h1{font-size:16px;font-weight:700;}
.header-info .level-badge{display:inline-block;font-size:11px;font-weight:600;
  padding:2px 8px;border-radius:20px;background:#EEF2FF;color:var(--primary);}
.xp-bar-wrap{height:6px;background:#E2E8F0;border-radius:3px;margin-top:4px;overflow:hidden;}
.xp-bar{height:100%;background:var(--xp-bar);border-radius:3px;transition:width .5s;}
.header-right{display:flex;gap:8px;align-items:center;}
.streak-badge{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600;color:var(--warning);}
.icon-btn{width:36px;height:36px;border-radius:50%;background:#F1F5F9;display:flex;
  align-items:center;justify-content:center;font-size:18px;transition:.2s;}
.icon-btn:active{transform:scale(.9);}

/* === TAB NAV === */
.tab-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(255,255,255,.95);backdrop-filter:blur(12px);
  border-top:1px solid #F1F5F9;
  display:flex;padding-bottom:var(--safe-bottom);height:calc(var(--tab-height) + var(--safe-bottom));}
.tab-nav button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;font-size:10px;font-weight:500;color:var(--text-secondary);background:none;transition:.2s;padding:8px 4px;}
.tab-nav button.active{color:var(--primary);}
.tab-nav button .tab-icon{font-size:22px;transition:.2s;}
.tab-nav button.active .tab-icon{transform:scale(1.1);}

/* === PAGES === */
.page{display:none;padding:16px;animation:fadeIn .3s;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}

/* === CARDS === */
.card{background:var(--card);border-radius:var(--radius);padding:20px;
  box-shadow:var(--shadow);margin-bottom:16px;transition:.2s;}
.card:active{transform:scale(.98);}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.card-header .card-emoji{font-size:32px;}
.card-header h3{font-size:15px;font-weight:700;}
.card-header p{font-size:12px;color:var(--text-secondary);}

/* === GROWTH TREE === */
.growth-tree{text-align:center;padding:24px 16px;}
.growth-tree .tree-visual{margin:16px 0;cursor:pointer;position:relative;
  animation:treeFloat 3s ease-in-out infinite;}
@keyframes treeFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.growth-tree-svg{width:160px;height:200px;margin:0 auto 8px;position:relative;}
.tree-glow{animation:treeGlow 2s ease-in-out infinite alternate;}
@keyframes treeGlow{from{filter:drop-shadow(0 0 4px rgba(79,70,229,.2));}to{filter:drop-shadow(0 0 12px rgba(79,70,229,.4));}}
.tree-xp-ring{transition:stroke-dashoffset 1s ease;}
.tree-info-popup{display:none;position:absolute;bottom:-60px;left:50%;transform:translateX(-50%);background:var(--card);padding:12px 16px;border-radius:var(--radius-sm);box-shadow:var(--shadow);font-size:12px;color:var(--text-secondary);white-space:nowrap;z-index:10;}
.tree-info-popup.show{display:block;animation:fadeIn .3s;}
.tree-sparkle{animation:sparkle 1.5s ease-in-out infinite alternate;}
@keyframes sparkle{0%{opacity:.4;transform:scale(.8);}100%{opacity:1;transform:scale(1.2);}}
.tree-sway{animation:treeSway 4s ease-in-out infinite;transform-origin:bottom center;}
@keyframes treeSway{0%,100%{transform:rotate(0);}25%{transform:rotate(1deg);}75%{transform:rotate(-1deg);}}
.growth-tree .level-name{font-size:20px;font-weight:800;color:var(--primary);}
.growth-tree .level-desc{font-size:13px;color:var(--text-secondary);margin-top:4px;}
.tree-stages{display:flex;justify-content:center;gap:12px;margin-top:16px;}
.tree-stages .stage{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:18px;background:#F1F5F9;opacity:.4;transition:.3s;}
.tree-stages .stage.reached{opacity:1;background:#EEF2FF;}
.tree-stages .stage.current{opacity:1;background:var(--primary);box-shadow:0 0 12px rgba(79,70,229,.4);}

/* === ACTIVITY GRID === */
.activity-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.activity-card{background:var(--card);border-radius:var(--radius);padding:16px;
  box-shadow:var(--shadow);text-align:center;cursor:pointer;transition:.2s;position:relative;overflow:hidden;}
.activity-card:active{transform:scale(.96);}
.activity-card .act-emoji{font-size:36px;margin-bottom:8px;}
.activity-card h4{font-size:13px;font-weight:700;margin-bottom:2px;}
.activity-card p{font-size:11px;color:var(--text-secondary);}
.activity-card.locked{opacity:.5;pointer-events:none;}
.activity-card.locked::after{content:'🔒';position:absolute;top:8px;right:8px;font-size:14px;}

/* === DIAGNOSTIC TEST === */
.diag-wrap{max-width:480px;margin:0 auto;}
.diag-progress{display:flex;gap:6px;margin-bottom:24px;}
.diag-progress .dp{flex:1;height:4px;border-radius:2px;background:#E2E8F0;transition:.3s;}
.diag-progress .dp.done{background:var(--success);}
.diag-progress .dp.current{background:var(--primary);}
.diag-question{text-align:center;padding:20px 0;}
.diag-question .q-num{font-size:12px;color:var(--text-secondary);margin-bottom:8px;}
.diag-question .q-text{font-size:18px;font-weight:700;margin-bottom:24px;line-height:1.5;}
.diag-options{display:flex;flex-direction:column;gap:10px;}
.diag-option{padding:16px;border:2px solid #E2E8F0;border-radius:var(--radius-sm);
  font-size:14px;text-align:left;background:#fff;transition:.2s;cursor:pointer;}
.diag-option:hover{border-color:var(--primary-light);background:#EEF2FF;}
.diag-option.selected{border-color:var(--primary);background:#EEF2FF;color:var(--primary);font-weight:600;}
.diag-option.correct{border-color:var(--success);background:#D1FAE5;color:#065F46;}
.diag-option.wrong{border-color:var(--danger);background:#FEE2E2;color:#991B1B;}

/* === FREE TALK / ORB === */
.orb-container{display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:60vh;padding:24px;}
.orb{width:140px;height:140px;border-radius:50%;position:relative;cursor:pointer;
  transition:all .5s;display:flex;align-items:center;justify-content:center;
  -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:manipulation;}
.orb-idle{background:radial-gradient(circle at 35% 35%,#818CF8,#4F46E5);
  box-shadow:0 0 40px rgba(79,70,229,.3);}
.orb-listening{background:radial-gradient(circle at 35% 35%,#FCA5A5,#EF4444);
  box-shadow:0 0 40px rgba(239,68,68,.4);animation:orbPulse 1s infinite;}
.orb-thinking{background:radial-gradient(circle at 35% 35%,#FDE68A,#F59E0B);
  box-shadow:0 0 40px rgba(245,158,11,.4);animation:orbSpin 1.5s linear infinite;}
.orb-speaking{background:radial-gradient(circle at 35% 35%,#6EE7B7,#10B981);
  box-shadow:0 0 40px rgba(16,185,129,.4);animation:orbPulse 1.2s infinite;}
@keyframes orbPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
@keyframes orbSpin{0%{box-shadow:0 0 40px rgba(245,158,11,.4);}
  50%{box-shadow:0 0 60px rgba(245,158,11,.6);}100%{box-shadow:0 0 40px rgba(245,158,11,.4);}}
.orb-emoji{font-size:48px;filter:brightness(0) invert(1);z-index:1;pointer-events:none;}
.orb-status{margin-top:20px;font-size:14px;font-weight:600;color:var(--text-secondary);}
.chat-messages{width:100%;max-width:480px;margin-top:24px;max-height:300px;
  overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding:0 4px;}
.chat-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;
  animation:msgIn .3s;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
.chat-msg.ai{background:#EEF2FF;color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;}
.chat-msg.user{background:var(--primary);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
.chat-msg .ko{display:block;font-size:12px;color:var(--text-secondary);margin-top:4px;}
.chat-msg.user .ko{color:rgba(255,255,255,.7);}
.chat-input-row{display:flex;gap:8px;width:100%;max-width:480px;margin-top:16px;}
.chat-input-row input{flex:1;padding:12px 16px;border:2px solid #E2E8F0;border-radius:var(--radius-sm);font-size:14px;}
.chat-input-row input:focus{border-color:var(--primary);}
.chat-input-row button{width:44px;height:44px;border-radius:50%;background:var(--primary);
  color:#fff;font-size:18px;flex-shrink:0;}

/* === ACTIVITY VIEW === */
.activity-view{display:none;position:fixed;inset:0;z-index:200;background:#fff;
  flex-direction:column;overflow-y:auto;}
.activity-view.active{display:flex;}
.activity-header{display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid #F1F5F9;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);position:sticky;top:0;z-index:10;}
.activity-header .back-btn{width:36px;height:36px;border-radius:50%;background:#F1F5F9;
  display:flex;align-items:center;justify-content:center;font-size:18px;}
.activity-header h2{flex:1;font-size:16px;font-weight:700;}
.activity-body{flex:1;padding:16px;display:flex;flex-direction:column;align-items:center;}

/* TPR Grid */
.tpr-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;width:100%;max-width:400px;margin-top:24px;}
.tpr-card{aspect-ratio:1;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  display:flex;align-items:center;justify-content:center;font-size:56px;cursor:pointer;
  transition:.2s;border:3px solid transparent;}
.tpr-card:active{transform:scale(.93);}
.tpr-card.correct{border-color:var(--success);background:#D1FAE5;animation:popCorrect .5s;}
.tpr-card.wrong{border-color:var(--danger);background:#FEE2E2;animation:popWrong .4s;}
@keyframes popCorrect{0%{transform:scale(.9);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
@keyframes popWrong{0%,100%{transform:translateX(0);}25%{transform:translateX(-8px);}75%{transform:translateX(8px);}}

/* Echo */
.echo-word{font-size:48px;font-weight:800;color:var(--primary);margin:24px 0;text-align:center;}
.echo-sub{font-size:14px;color:var(--text-secondary);margin-bottom:16px;}
.echo-result{font-size:16px;font-weight:600;margin:12px 0;min-height:24px;}
.echo-result.good{color:var(--success);}
.score-circle{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;margin:16px auto;border:6px solid #E2E8F0;transition:all .5s;}
.score-circle.perfect{border-color:var(--success);color:var(--success);background:#D1FAE5;}
.score-circle.good{border-color:var(--warning);color:var(--warning);background:#FEF3C7;}
.score-circle.retry{border-color:var(--danger);color:var(--danger);background:#FEE2E2;}
.echo-feedback{font-size:15px;font-weight:700;margin:8px 0;}
.echo-spoken{font-size:13px;color:var(--text-secondary);margin:4px 0;}
.echo-tries{font-size:12px;color:var(--text-secondary);margin:4px 0;}
.echo-btn-row{display:flex;gap:8px;justify-content:center;margin-top:12px;}

/* Session Progress */
.session-progress{position:relative;height:32px;background:#E2E8F0;border-radius:16px;margin:16px;overflow:hidden;}
.session-progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:16px;transition:width .5s;}
.session-progress-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:13px;font-weight:600;color:var(--text);}
.session-summary-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #F1F5F9;font-size:14px;}
.session-summary-row .s-label{color:var(--text-secondary);}
.session-summary-row .s-xp{font-weight:700;color:var(--primary);}
.session-summary-row.bonus .s-xp{color:var(--success);}
.session-total{font-size:32px;font-weight:900;color:var(--primary);margin:16px 0;}
.echo-result.retry{color:var(--warning);}

/* Chant */
.chant-line{font-size:20px;font-weight:700;text-align:center;margin:8px 0;padding:12px;
  border-radius:var(--radius-sm);transition:.3s;}
.chant-line.highlight{background:#EEF2FF;color:var(--primary);transform:scale(1.05);}

/* Mission Timer */
.mission-timer{font-size:48px;font-weight:800;color:var(--primary);margin:16px 0;}
.mission-timer.urgent{color:var(--danger);animation:timerPulse .5s infinite;}
@keyframes timerPulse{0%,100%{opacity:1;}50%{opacity:.5;}}

/* === VOICE MODE OVERLAY === */
.voice-mode-overlay{position:fixed;inset:0;z-index:500;
  background:linear-gradient(135deg,#1e1b4b 0%,#312e81 40%,#4338ca 100%);
  display:none;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity .3s;opacity:0;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
.voice-mode-overlay.active{display:flex;opacity:1;}
.voice-mode-overlay *{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;}

.voice-mode-close{position:absolute;top:calc(16px + env(safe-area-inset-top));right:16px;
  width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.15);
  color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:.2s;z-index:10;border:none;}
.voice-mode-close:hover{background:rgba(255,255,255,.25);}

.voice-level-badge{position:absolute;top:calc(20px + env(safe-area-inset-top));left:16px;
  background:rgba(255,255,255,.15);padding:6px 14px;border-radius:20px;
  font-size:12px;font-weight:600;color:rgba(255,255,255,.8);z-index:10;}

.voice-history{position:absolute;top:calc(70px + env(safe-area-inset-top));left:16px;right:16px;
  max-height:30vh;overflow-y:auto;display:flex;flex-direction:column;gap:8px;
  padding:0 4px;scrollbar-width:none;}
.voice-history::-webkit-scrollbar{display:none;}
.voice-history .v-msg{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.5;
  animation:msgIn .3s;max-width:85%;}
.voice-history .v-msg.ai{background:rgba(255,255,255,.12);color:rgba(255,255,255,.9);
  align-self:flex-start;border-bottom-left-radius:4px;}
.voice-history .v-msg.user{background:rgba(129,140,248,.3);color:#fff;
  align-self:flex-end;border-bottom-right-radius:4px;}
.voice-history .v-msg .ko{display:block;font-size:11px;color:rgba(255,255,255,.55);margin-top:3px;}

.voice-status-text{color:rgba(255,255,255,.7);font-size:14px;font-weight:500;margin-bottom:8px;
  text-align:center;transition:color .3s;}
.voice-subtitle{color:rgba(255,255,255,.5);font-size:12px;margin-bottom:32px;text-align:center;}

.voice-orb-wrapper{position:relative;display:flex;align-items:center;justify-content:center;
  width:180px;height:180px;margin-bottom:24px;cursor:pointer;
  -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:manipulation;}
.voice-orb-pulse{position:absolute;width:100%;height:100%;border-radius:50%;
  opacity:0;transition:opacity .3s;}
.voice-orb{width:140px;height:140px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;transition:all .5s;z-index:1;pointer-events:none;}

/* Voice orb states */
.voice-orb.v-idle{background:radial-gradient(circle at 35% 35%,#818CF8,#4F46E5);
  box-shadow:0 0 40px rgba(79,70,229,.4);}
.voice-orb.v-listening{background:radial-gradient(circle at 35% 35%,#FCA5A5,#EF4444);
  box-shadow:0 0 50px rgba(239,68,68,.5);animation:orbPulseRed 1s infinite;}
.voice-orb.v-thinking{background:radial-gradient(circle at 35% 35%,#FDE68A,#F59E0B);
  box-shadow:0 0 50px rgba(245,158,11,.5);animation:orbPulseYellow 1.5s infinite;}
.voice-orb.v-speaking{background:radial-gradient(circle at 35% 35%,#6EE7B7,#10B981);
  box-shadow:0 0 50px rgba(16,185,129,.5);animation:orbPulseGreen 1.2s infinite;}

@keyframes orbPulseRed{0%,100%{transform:scale(1);box-shadow:0 0 40px rgba(239,68,68,.4);}
  50%{transform:scale(1.06);box-shadow:0 0 60px rgba(239,68,68,.6);}}
@keyframes orbPulseYellow{0%,100%{transform:scale(1);box-shadow:0 0 40px rgba(245,158,11,.4);}
  50%{transform:scale(1.04);box-shadow:0 0 55px rgba(245,158,11,.6);}}
@keyframes orbPulseGreen{0%,100%{transform:scale(1);box-shadow:0 0 40px rgba(16,185,129,.4);}
  50%{transform:scale(1.05);box-shadow:0 0 55px rgba(16,185,129,.6);}}

.voice-orb-emoji{font-size:48px;filter:brightness(0) invert(1);z-index:1;pointer-events:none;}

.voice-transcript{color:rgba(255,255,255,.6);font-size:13px;text-align:center;
  min-height:20px;margin-top:16px;font-style:italic;padding:0 24px;}


/* Score display */
.score-display{font-size:14px;font-weight:600;color:var(--primary);padding:6px 14px;
  background:#EEF2FF;border-radius:20px;}

/* Stats page */
.stat-card{background:var(--card);border-radius:var(--radius);padding:20px;
  box-shadow:var(--shadow);margin-bottom:12px;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;}
.stat-row+.stat-row{border-top:1px solid #F1F5F9;}
.stat-label{font-size:13px;color:var(--text-secondary);}
.stat-value{font-size:15px;font-weight:700;}
.badge-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;}
.badge{width:56px;height:56px;border-radius:50%;background:#F1F5F9;display:flex;
  align-items:center;justify-content:center;font-size:24px;opacity:.3;transition:.3s;}
.badge.earned{opacity:1;background:#EEF2FF;box-shadow:0 2px 8px rgba(79,70,229,.15);}

/* Settings modal */
.modal-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.4);display:none;
  align-items:flex-end;justify-content:center;animation:fadeIn .2s;}
.modal-overlay.active{display:flex;}
.modal-sheet{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:480px;
  max-height:80vh;overflow-y:auto;padding:24px 16px calc(24px + var(--safe-bottom));
  animation:slideUp .3s;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:none;}}
.modal-handle{width:40px;height:4px;border-radius:2px;background:#E2E8F0;margin:0 auto 16px;}
.modal-sheet h2{font-size:18px;font-weight:700;margin-bottom:16px;}
.setting-item{display:flex;justify-content:space-between;align-items:center;
  padding:14px 0;border-bottom:1px solid #F1F5F9;}
.setting-item label{font-size:14px;font-weight:500;}
.toggle{width:48px;height:28px;border-radius:14px;background:#E2E8F0;position:relative;
  cursor:pointer;transition:.3s;}
.toggle.on{background:var(--primary);}
.toggle::after{content:'';width:22px;height:22px;border-radius:50%;background:#fff;
  position:absolute;top:3px;left:3px;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.15);}
.toggle.on::after{left:23px;}

/* Reward popup */
.reward-popup{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center;}
.reward-popup.active{display:flex;}
.reward-content{background:#fff;border-radius:var(--radius);padding:32px 24px;
  text-align:center;max-width:320px;width:90%;animation:rewardPop .5s;}
@keyframes rewardPop{0%{transform:scale(.5);opacity:0;}100%{transform:scale(1);opacity:1;}}
.reward-content .r-emoji{font-size:64px;margin-bottom:12px;}
.reward-content h3{font-size:20px;font-weight:800;margin-bottom:8px;}
.reward-content p{font-size:14px;color:var(--text-secondary);margin-bottom:16px;}
.xp-gain{font-size:24px;font-weight:800;color:var(--success);margin:8px 0;}

/* Session flow steps */
.session-step{text-align:center;padding:20px;max-width:420px;margin:0 auto;}
.session-step h3{font-size:18px;font-weight:700;margin-bottom:8px;}
.session-step p{font-size:14px;color:var(--text-secondary);line-height:1.6;}

/* Role play */
.rp-scenario{background:#EEF2FF;border-radius:var(--radius);padding:16px;margin-bottom:16px;
  text-align:center;width:100%;max-width:420px;}
.rp-scenario .rp-emoji{font-size:48px;margin-bottom:8px;}
.rp-scenario h4{font-size:15px;font-weight:700;}
.rp-scenario p{font-size:12px;color:var(--text-secondary);}

/* Scrollbar */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:2px;}

/* Responsive */
@media(min-width:768px){
  .page{max-width:600px;margin:0 auto;}
  .activity-grid{grid-template-columns:repeat(3,1fr);}
}

/* === CURRICULUM ROADMAP === */
.roadmap-toggle{display:flex;align-items:center;justify-content:space-between;background:var(--card);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);margin-bottom:12px;cursor:pointer;transition:.2s;}
.roadmap-toggle:active{transform:scale(.98);}
.roadmap-toggle h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
.roadmap-toggle .toggle-arrow{transition:transform .3s;font-size:14px;}
.roadmap-toggle .toggle-arrow.open{transform:rotate(180deg);}
.roadmap-container{max-height:0;overflow:hidden;transition:max-height .4s ease;}
.roadmap-container.open{max-height:2000px;}
.roadmap-timeline{position:relative;padding:8px 0 8px 28px;margin-left:20px;}
.roadmap-timeline::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--primary-light);}
.roadmap-node{position:relative;margin-bottom:20px;}
.roadmap-node::before{content:'';position:absolute;left:-28px;top:8px;width:16px;height:2px;background:var(--primary-light);}
.roadmap-dot{position:absolute;left:-36px;top:0;width:18px;height:18px;border-radius:50%;background:#E2E8F0;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid #E2E8F0;z-index:1;}
.roadmap-dot.completed{background:var(--success);border-color:var(--success);color:#fff;}
.roadmap-dot.current{width:28px;height:28px;left:-41px;top:-5px;background:var(--primary);border-color:var(--primary);color:#fff;font-size:13px;animation:roadmapPulse 2s infinite;}
.roadmap-dot.locked{background:#F1F5F9;border-color:#E2E8F0;color:var(--text-secondary);}
@keyframes roadmapPulse{0%,100%{box-shadow:0 0 0 0 rgba(79,70,229,.4);}50%{box-shadow:0 0 0 8px rgba(79,70,229,0);}}
.roadmap-label{font-size:14px;font-weight:600;cursor:pointer;padding:4px 0;}
.roadmap-label.completed{color:var(--success);}
.roadmap-label.current{color:var(--primary);font-size:15px;font-weight:700;}
.roadmap-label.locked{color:var(--text-secondary);opacity:.6;}
.roadmap-topics{max-height:0;overflow:hidden;transition:max-height .3s ease;margin-top:4px;}
.roadmap-topics.open{max-height:500px;}
.topic-item{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:12px;border-radius:8px;margin:2px 0;}
.topic-item.done{color:var(--success);background:#F0FDF4;}
.topic-item.pending{color:var(--text-secondary);background:#F8FAFC;}

/* === CONVERSATION REPORT === */
.conv-report-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;}
.conv-report-overlay.active{display:flex;}
.conv-report-card{background:#fff;border-radius:var(--radius);padding:24px 20px;max-width:380px;width:100%;max-height:85vh;overflow-y:auto;animation:rewardPop .4s;box-shadow:0 8px 32px rgba(0,0,0,.2);}
.conv-report-title{text-align:center;font-size:18px;font-weight:800;margin-bottom:16px;}
.conv-score-row{display:flex;align-items:center;gap:10px;margin:8px 0;font-size:13px;}
.conv-score-label{width:80px;font-weight:600;text-align:right;flex-shrink:0;}
.conv-score-bar-bg{flex:1;height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;}
.conv-score-bar{height:100%;border-radius:4px;transition:width .6s;}
.conv-score-val{width:28px;font-weight:700;font-size:12px;text-align:right;}
.conv-section{margin:12px 0;}
.conv-section h4{font-size:13px;font-weight:700;margin-bottom:6px;}
.conv-strength{background:#ECFDF5;border-left:3px solid #10B981;padding:8px 10px;border-radius:0 8px 8px 0;margin:4px 0;font-size:12px;color:#065F46;}
.conv-improve{background:#FFFBEB;border-left:3px solid #F59E0B;padding:8px 10px;border-radius:0 8px 8px 0;margin:4px 0;font-size:12px;color:#92400E;}
.conv-correction{background:#EEF2FF;border-radius:8px;padding:10px 12px;margin:8px 0;font-size:12px;}
.conv-correction s{color:var(--danger);}
.conv-correction strong{color:var(--success);}

/* === ACHIEVEMENT SYSTEM === */
.achievement-popup-overlay{position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
.achievement-popup-overlay.active{display:flex;}
.achievement-popup-card{background:#fff;border-radius:var(--radius);padding:32px 24px;text-align:center;max-width:320px;width:90%;animation:achievePop .6s;position:relative;overflow:hidden;}
@keyframes achievePop{0%{transform:scale(.3) rotate(-10deg);opacity:0;}60%{transform:scale(1.1) rotate(2deg);opacity:1;}100%{transform:scale(1) rotate(0);opacity:1;}}
.achievement-popup-card::before,.achievement-popup-card::after{content:'';position:absolute;width:8px;height:8px;border-radius:50%;animation:confettiFall 1.5s linear infinite;}
.achievement-popup-card::before{background:#F59E0B;left:20%;top:-10px;animation-delay:0s;}
.achievement-popup-card::after{background:#EF4444;right:25%;top:-10px;animation-delay:.3s;}
@keyframes confettiFall{0%{transform:translateY(-10px) rotate(0) scale(1);opacity:1;}100%{transform:translateY(350px) rotate(720deg) scale(.3);opacity:0;}}
.confetti-container{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.confetti-piece{position:absolute;width:6px;height:6px;border-radius:50%;animation:confettiFall 2s linear forwards;}
.achievement-emoji{font-size:64px;margin-bottom:8px;}
.achievement-name{font-size:20px;font-weight:800;color:var(--primary);margin:4px 0;}
.achievement-desc{font-size:13px;color:var(--text-secondary);margin-bottom:12px;}
.achievement-xp{font-size:18px;font-weight:800;color:var(--success);}
.ach-section{margin-top:20px;}
.ach-section h3{font-size:15px;font-weight:700;margin-bottom:12px;}
.ach-grid{display:flex;flex-direction:column;gap:10px;}
.ach-card{display:flex;align-items:center;gap:12px;background:var(--card);border-radius:var(--radius-sm);padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:.2s;}
.ach-card.locked{opacity:.5;filter:grayscale(.6);}
.ach-card .ach-emoji{font-size:28px;flex-shrink:0;}
.ach-card .ach-info{flex:1;min-width:0;}
.ach-card .ach-info h4{font-size:13px;font-weight:700;margin-bottom:2px;}
.ach-card .ach-info p{font-size:11px;color:var(--text-secondary);}
.ach-card .ach-info .ach-date{font-size:10px;color:var(--success);font-weight:600;}
.ach-progress-bar{height:4px;background:#E2E8F0;border-radius:2px;margin-top:4px;overflow:hidden;}
.ach-progress-bar .ach-fill{height:100%;background:var(--primary-light);border-radius:2px;transition:width .5s;}

/* === 3D AVATAR === */
#avatarContainer{position:relative;}
#avatarContainer canvas{border-radius:20px;}
.avatar-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:14px;font-weight:600;text-align:center;}
#avatarTapBtn{animation:avatarBtnPulse 2s ease-in-out infinite;}
#avatarTapBtn:active{transform:scale(.95);background:rgba(255,255,255,.25);}
#avatarTapBtn.listening{background:rgba(239,68,68,.4);border-color:rgba(239,68,68,.6);animation:avatarBtnPulse 1s ease-in-out infinite;}
#avatarTapBtn.thinking{background:rgba(245,158,11,.4);border-color:rgba(245,158,11,.6);animation:none;}
#avatarTapBtn.speaking{background:rgba(16,185,129,.4);border-color:rgba(16,185,129,.6);animation:none;}
@keyframes avatarBtnPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.3);}50%{box-shadow:0 0 0 12px rgba(255,255,255,0);}}
@media(max-width:480px){
  #avatarContainer{width:220px!important;height:280px!important;}
  #avatarTapBtn{padding:12px 24px;font-size:14px;}
  #avatarSelector{gap:6px!important;}
  #avatarSelector > div{padding:8px!important;font-size:12px;}
}
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash">
  <div class="splash-tree">🌱</div>
  <h1>My English Coach</h1>
  <p>AI 기반 영어 회화 학습</p>
</div>

<!-- ONBOARDING -->
<div id="onboarding">
  <div class="onb-page active" data-page="0">
    <div class="emoji">🌱</div>
    <h2>환영합니다!</h2>
    <p>My English Coach는 나무가 자라듯<br>당신의 영어 실력을 성장시켜 드려요 🌿</p>
  </div>
  <div class="onb-page" data-page="1">
    <div class="emoji">🎤</div>
    <h2>말하며 배워요</h2>
    <p>음성인식과 AI가 당신의 발음을 듣고<br>자연스럽게 코칭해 드립니다</p>
  </div>
  <div class="onb-page" data-page="2">
    <div class="emoji">🔑</div>
    <h2>API 키 설정</h2>
    <p>OpenAI API 키를 입력하면<br>AI 대화 기능을 사용할 수 있어요</p>
    <div class="api-input-wrap">
      <input type="password" id="apiKeyInput" placeholder="sk-... (OpenAI API Key)">
      <small>키는 브라우저에만 저장되며 외부로 전송되지 않습니다</small>
    </div>
  </div>
  <div class="onb-page" data-page="3">
    <div class="emoji">📝</div>
    <h2>레벨 진단</h2>
    <p>간단한 테스트로 현재 영어 수준을<br>파악하고 맞춤 학습을 시작합니다</p>
  </div>
  <div style="padding:16px;display:flex;flex-direction:column;gap:8px;">
    <div class="onb-dots" id="onbDots"></div>
    <button class="btn btn-primary btn-full" id="onbNextBtn">다음</button>
    <button class="btn btn-secondary btn-full" id="onbSkipBtn" style="display:none;">건너뛰기</button>
  </div>
</div>

<!-- DIAGNOSTIC TEST -->
<div id="diagnosticView" style="display:none;position:fixed;inset:0;z-index:9997;background:#fff;overflow-y:auto;">
  <div style="padding:16px;" class="diag-wrap">
    <div style="text-align:center;margin:24px 0 16px;">
      <div style="font-size:48px;">📝</div>
      <h2 style="font-size:20px;font-weight:800;">레벨 진단 테스트</h2>
      <p style="font-size:13px;color:var(--text-secondary);margin-top:4px;">영어 실력을 파악해볼게요!</p>
    </div>
    <div class="diag-progress" id="diagProgress"></div>
    <div id="diagContent"></div>
  </div>
</div>

<!-- MAIN APP -->
<header class="app-header" id="appHeader" style="display:none;">
  <div class="tree-icon" id="headerTree">🌱</div>
  <div class="header-info">
    <h1>My English Coach <span class="level-badge" id="headerLevel">Lv.0 SEED</span></h1>
    <div class="xp-bar-wrap"><div class="xp-bar" id="headerXpBar" style="width:0%"></div></div>
  </div>
  <div class="header-right">
    <div class="streak-badge">🔥 <span id="headerStreak">0</span></div>
    <button class="icon-btn" onclick="openSettings()">⚙️</button>
  </div>
</header>

<!-- STUDY REMINDER BANNER -->
<div id="studyReminderBanner" style="display:none;background:linear-gradient(135deg,#FEF3C7,#FDE68A);padding:10px 16px;text-align:center;font-size:13px;font-weight:600;color:#92400E;cursor:pointer;position:relative;z-index:50;" onclick="this.style.display='none';">
  ⏰ 오늘 아직 학습을 시작하지 않았어요! 지금 시작해볼까요? <span style="opacity:0.5;font-size:11px;">(닫기)</span>
</div>

<!-- HOME PAGE -->
<div class="page" id="pageHome">
  <div class="growth-tree">
    <div class="tree-visual" id="growthTreeVisual" onclick="toggleTreeInfo()"></div>
    <div class="tree-info-popup" id="treeInfoPopup"></div>
    <div class="level-name" id="growthLevelName">SEED</div>
    <div class="level-desc" id="growthLevelDesc">Pre-A1 · 듣고 반응하기</div>
    <div class="tree-stages" id="treeStages"></div>
  </div>
  <div class="card" onclick="startSession()">
    <div class="card-header">
      <div class="card-emoji">📚</div>
      <div><h3>오늘의 학습 시작</h3><p>맞춤 세션을 시작합니다</p></div>
    </div>
    <button class="btn btn-primary btn-full btn-sm">학습 시작하기</button>
  </div>
  <div class="card" id="dailyGoalCard">
    <div class="card-header">
      <div class="card-emoji">🎯</div>
      <div><h3>오늘의 목표</h3><p id="dailyGoalText">XP 0 / 50</p></div>
    </div>
    <div class="xp-bar-wrap" style="height:8px;"><div class="xp-bar" id="dailyXpBar" style="width:0%"></div></div>
  </div>
  <div class="card">
    <div class="card-header">
      <div class="card-emoji">📊</div>
      <div><h3>최근 학습</h3><p id="recentActivity">아직 학습 기록이 없어요</p></div>
    </div>
  </div>
  <div class="card" id="reviewCard" style="display:none;cursor:pointer;" onclick="startReviewSession()">
    <div class="card-header">
      <div class="card-emoji">📖</div>
      <div><h3>복습하기</h3><p id="reviewCardText">복습할 항목이 있어요!</p></div>
    </div>
    <button class="btn btn-primary btn-full btn-sm">복습 시작하기</button>
  </div>
</div>

<!-- ACTIVITIES PAGE -->
<div class="page" id="pageActivities">
  <h2 style="font-size:20px;font-weight:800;margin-bottom:16px;">학습 활동</h2>
  <!-- Curriculum Roadmap -->
  <div class="roadmap-toggle" onclick="toggleRoadmap()">
    <h3>📍 학습 로드맵</h3>
    <span class="toggle-arrow" id="roadmapArrow">▼</span>
  </div>
  <div class="roadmap-container" id="roadmapContainer">
    <div class="roadmap-timeline" id="roadmapTimeline"></div>
  </div>
  <div class="activity-grid" id="activityGrid"></div>
</div>

<!-- FREE TALK PAGE -->
<div class="page" id="pageFreeTalk">
  <div class="orb-container" id="orbContainer">
    <div class="orb orb-idle" id="talkOrb" role="button" tabindex="0">
      <span class="orb-emoji">🎤</span>
    </div>
    <div class="orb-status" id="orbStatus">탭하여 대화 시작</div>
    <div class="chat-messages" id="chatMessages"></div>
    <button class="btn btn-primary" style="width:100%;max-width:480px;margin-bottom:12px;font-size:15px;" onclick="openVoiceMode()">🎙️ 음성 대화 모드</button>
    <div class="chat-input-row">
      <input type="text" id="chatTextInput" placeholder="텍스트로 입력...">
      <button onclick="sendTextMessage()">📤</button>
    </div>
  </div>
</div>

<!-- STATS PAGE -->
<div class="page" id="pageStats">
  <h2 style="font-size:20px;font-weight:800;margin-bottom:16px;">학습 현황</h2>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">📈 통계</h3>
    <div class="stat-row"><span class="stat-label">총 XP</span><span class="stat-value" id="statTotalXp">0</span></div>
    <div class="stat-row"><span class="stat-label">현재 레벨</span><span class="stat-value" id="statLevel">Lv.0 SEED</span></div>
    <div class="stat-row"><span class="stat-label">총 학습 세션</span><span class="stat-value" id="statSessions">0</span></div>
    <div class="stat-row"><span class="stat-label">연속 학습일</span><span class="stat-value" id="statStreak">0일</span></div>
    <div class="stat-row"><span class="stat-label">정답률</span><span class="stat-value" id="statAccuracy">0%</span></div>
    <div class="stat-row"><span class="stat-label">총 학습 시간</span><span class="stat-value" id="statTime">0분</span></div>
  </div>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">🏅 배지</h3>
    <div class="badge-grid" id="badgeGrid"></div>
  </div>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">📅 학습 기록</h3>
    <div id="studyLog" style="font-size:13px;color:var(--text-secondary);">학습을 시작하면 기록이 표시됩니다.</div>
  </div>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">📊 주간 학습 그래프</h3>
    <div id="weeklyGraph" style="display:flex;align-items:flex-end;gap:6px;height:120px;margin:16px 0;"></div>
  </div>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">🎯 스킬 분석</h3>
    <div id="radarChart" style="display:flex;justify-content:center;margin:8px 0;"></div>
  </div>
  <div class="stat-card">
    <h3 style="font-size:15px;font-weight:700;margin-bottom:8px;">🔮 레벨 진행 예측</h3>
    <p id="levelPrediction" style="font-size:14px;color:var(--text-secondary);">데이터를 수집 중입니다...</p>
  </div>
  <!-- Achievements Section -->
  <div class="stat-card ach-section">
    <h3>🏅 도전 과제</h3>
    <div class="ach-grid" id="achievementGrid"></div>
  </div>
  <div style="margin-top:16px;">
    <button class="btn btn-danger btn-full btn-sm" onclick="resetAllData()">🗑️ 모든 데이터 초기화</button>
  </div>
</div>

<!-- ACTIVITY FULLSCREEN VIEW -->
<div class="activity-view" id="activityView">
  <div class="activity-header">
    <button class="back-btn" onclick="closeActivity()">←</button>
    <h2 id="actViewTitle">활동</h2>
    <div class="score-display" id="actViewScore">0 XP</div>
  </div>
  <div class="activity-body" id="actViewBody"></div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h2>⚙️ 설정</h2>
    <div style="margin-bottom:16px;">
      <label style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:block;">AI 코치 아바타</label>
      <div id="avatarSelector" style="display:flex;gap:8px;"></div>
      <p style="font-size:11px;color:var(--text-secondary);margin-top:6px;">음성 대화 모드에서 선택한 아바타가 표시됩니다</p>
    </div>
    <div class="setting-item">
      <label>API 키</label>
      <input type="password" id="settingsApiKey" placeholder="sk-..." style="width:180px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:12px;">
    </div>
    <div class="setting-item">
      <label>TTS 속도</label>
      <select id="settingsTtsSpeed" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;">
        <option value="0.7">느리게</option>
        <option value="1" selected>보통</option>
        <option value="1.3">빠르게</option>
      </select>
    </div>
    <div class="setting-item">
      <label>자동 TTS</label>
      <div class="toggle on" id="toggleAutoTts" onclick="toggleSetting(this)"></div>
    </div>
    <div class="setting-item">
      <label>한국어 번역 표시</label>
      <div class="toggle on" id="toggleKorean" onclick="toggleSetting(this)"></div>
    </div>
    <div class="setting-item">
      <label>레벨 수동 변경</label>
      <select id="settingsLevel" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;" onchange="manualLevelChange(this.value)">
        <option value="0">Lv.0 SEED</option>
        <option value="1">Lv.1 SPROUT</option>
        <option value="2">Lv.2 BLOOM</option>
        <option value="3">Lv.3 BRANCH</option>
        <option value="4">Lv.4 CANOPY</option>
        <option value="5">Lv.5 SKY</option>
      </select>
    </div>
    <div class="setting-item">
      <label>학습 알림 시간</label>
      <input type="time" id="settingsReminder" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;">
    </div>
    <button class="btn btn-primary btn-full" style="margin-top:16px;" onclick="saveSettings()">저장</button>
    <button class="btn btn-secondary btn-full" style="margin-top:8px;" onclick="closeSettings()">닫기</button>
  </div>
</div>

<!-- REWARD POPUP -->
<div class="reward-popup" id="rewardPopup">
  <div class="reward-content">
    <div class="r-emoji" id="rewardEmoji">⭐</div>
    <h3 id="rewardTitle">잘했어요!</h3>
    <div class="xp-gain" id="rewardXp">+10 XP</div>
    <p id="rewardMsg">계속 성장하고 있어요!</p>
    <button class="btn btn-primary" onclick="closeReward()">확인</button>
  </div>
</div>

<!-- VOICE MODE OVERLAY -->
<div class="voice-mode-overlay" id="voiceModeOverlay">
  <div class="voice-level-badge" id="voiceLevelBadge">Lv.0 SEED</div>
  <button class="voice-mode-close" onclick="closeVoiceMode()">✕</button>
  <div class="voice-history" id="voiceHistory"></div>
  <div class="voice-status-text" id="voiceStatusText">탭하여 대화 시작</div>
  <div class="voice-subtitle" id="voiceSubtitle">한 번 탭하면 자동으로 대화가 이어집니다</div>
  <div id="avatarContainer" style="width:280px;height:350px;margin:0 auto 8px;border-radius:20px;overflow:hidden;background:transparent;cursor:pointer;" onclick="handleOrbTap()"></div>
  <button id="avatarTapBtn" onclick="handleOrbTap()" style="display:flex;align-items:center;justify-content:center;gap:8px;margin:0 auto 12px;padding:14px 32px;border-radius:50px;background:rgba(255,255,255,.15);color:white;font-size:15px;font-weight:700;border:2px solid rgba(255,255,255,.3);cursor:pointer;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:all .3s;-webkit-user-select:none;user-select:none;"><span style="font-size:20px;">🎤</span> 탭하여 대화 시작</button>
  <div class="voice-orb-wrapper" id="voiceOrbWrapper" role="button" tabindex="0" style="display:none;">
    <div class="voice-orb-pulse" id="voiceOrbPulse"></div>
    <div class="voice-orb v-idle" id="voiceOrb">
      <span class="voice-orb-emoji">🎤</span>
    </div>
  </div>
  <div class="voice-transcript" id="voiceTranscript"></div>
  <button id="voiceLangToggle" onclick="toggleVoiceLang()" style="margin-top:12px;padding:8px 20px;border-radius:20px;background:rgba(129,140,248,.3);color:rgba(255,255,255,.8);font-size:13px;font-weight:600;border:1px solid rgba(255,255,255,.2);cursor:pointer;transition:.2s;-webkit-user-select:none;user-select:none;">🌐 한국어+영어</button>
</div>

<!-- CONVERSATION REPORT MODAL -->
<div class="conv-report-overlay" id="convReportOverlay">
  <div class="conv-report-card" id="convReportCard"></div>
</div>

<!-- ACHIEVEMENT POPUP -->
<div class="achievement-popup-overlay" id="achievePopupOverlay">
  <div class="achievement-popup-card" id="achievePopupCard">
    <div class="confetti-container" id="confettiContainer"></div>
    <div class="achievement-emoji" id="achieveEmoji">🏆</div>
    <div class="achievement-name" id="achieveName">도전 과제 달성!</div>
    <div class="achievement-desc" id="achieveDesc"></div>
    <div class="achievement-xp" id="achieveXp">+50 XP</div>
    <button class="btn btn-primary" style="margin-top:16px;" onclick="closeAchievementPopup()">확인</button>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="tab-nav" id="tabNav" style="display:none;">
  <button class="active" onclick="switchTab('home',this)"><span class="tab-icon">🏠</span>홈</button>
  <button onclick="switchTab('activities',this)"><span class="tab-icon">📖</span>활동</button>
  <button onclick="switchTab('freetalk',this)"><span class="tab-icon">💬</span>프리톡</button>
  <button onclick="switchTab('stats',this)"><span class="tab-icon">📊</span>학습현황</button>
</nav>

<script>
/* ==========================================
   MY ENGLISH COACH - FULL APPLICATION
   ========================================== */

// ===== TTS VOICE SELECTION =====
function getBestEnglishVoice() {
  const voices = speechSynthesis.getVoices();
  if(!voices.length) return null;
  
  // Priority: female English voices first, then any good English voice
  const tests = [
    // 1. Google female English (Chrome desktop/Android)
    v => v.name.includes('Google') && v.lang.startsWith('en') && /female|UK/i.test(v.name),
    // 2. iOS/macOS premium female voices
    v => ['Samantha','Karen','Moira','Tessa','Fiona','Victoria','Allison','Ava','Susan'].some(n => v.name.includes(n)) && v.lang.startsWith('en'),
    // 3. Any Google English voice
    v => v.name.includes('Google') && v.lang.startsWith('en'),
    // 4. Any female-sounding English voice (heuristic: avoid known male names)
    v => v.lang.startsWith('en') && !['Daniel','Alex','Tom','James','Fred','Ralph','Aaron','Albert','Bruce','Junior'].some(n => v.name.includes(n)) && ['en-US','en-GB','en-AU'].includes(v.lang),
    // 5. Any voice with "English" in name
    v => v.name.includes('English') && ['en-US','en-GB'].includes(v.lang),
    // 6. Fallback: any en-* voice
    v => v.lang.startsWith('en')
  ];
  for (const test of tests) {
    const found = voices.find(test);
    if (found) return found;
  }
  return null;
}

let bestVoice = null;
speechSynthesis.onvoiceschanged = () => { bestVoice = getBestEnglishVoice(); };

// ===== PRONUNCIATION SCORING =====
function getSimilarity(original, spoken) {
  const a = original.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();
  const b = spoken.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();
  if (a === b) return 100;
  const matrix = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b[i-1] === a[j-1]) matrix[i][j] = matrix[i-1][j-1];
      else matrix[i][j] = Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1);
    }
  }
  const dist = matrix[b.length][a.length];
  const maxLen = Math.max(a.length, b.length);
  if (maxLen === 0) return 100;
  return Math.round((1 - dist / maxLen) * 100);
}

// ===== CONSTANTS =====
const LEVELS = [
  {name:'SEED',label:'Pre-A1',emoji:'🌱',desc:'듣고 반응하기',xpNeeded:100},
  {name:'SPROUT',label:'A1',emoji:'🌿',desc:'단어/짧은 구문 따라 말하기',xpNeeded:300},
  {name:'BLOOM',label:'A2',emoji:'🌸',desc:'간단한 문장과 역할극',xpNeeded:600},
  {name:'BRANCH',label:'B1',emoji:'🌳',desc:'의견 표현과 자유 대화',xpNeeded:1200},
  {name:'CANOPY',label:'B2',emoji:'🌲',desc:'토론과 프레젠테이션',xpNeeded:2500},
  {name:'SKY',label:'C1+',emoji:'🌟',desc:'자유 발화와 전문 영역',xpNeeded:5000}
];

const ACTIVITIES = [
  {id:'tpr',name:'Listen & Act',emoji:'👆',desc:'듣고 그림 터치',minLevel:0},
  {id:'echo',name:'Echo',emoji:'🗣️',desc:'따라 말하기',minLevel:0},
  {id:'chant',name:'Chant',emoji:'🎵',desc:'패턴 문장 반복',minLevel:1},
  {id:'story',name:'Story',emoji:'📖',desc:'이야기 듣고 재구성',minLevel:1},
  {id:'roleplay',name:'Role Play',emoji:'🎭',desc:'상황별 대화',minLevel:2},
  {id:'freetalk',name:'Free Talk',emoji:'💬',desc:'AI와 자유 대화',minLevel:2},
  {id:'minilesson',name:'Mini Lesson',emoji:'🧪',desc:'CLIL 주제 학습',minLevel:3},
  {id:'mission',name:'Mission',emoji:'⚡',desc:'시간제한 챌린지',minLevel:1}
];

const BADGES = [
  {id:'first_session',name:'첫 학습',emoji:'🎉',desc:'첫 학습 완료'},
  {id:'streak_3',name:'3일 연속',emoji:'🔥',desc:'3일 연속 학습'},
  {id:'streak_7',name:'7일 연속',emoji:'💪',desc:'7일 연속 학습'},
  {id:'xp_100',name:'XP 100',emoji:'⭐',desc:'XP 100 달성'},
  {id:'xp_500',name:'XP 500',emoji:'🌟',desc:'XP 500 달성'},
  {id:'level_1',name:'새싹',emoji:'🌿',desc:'Lv.1 SPROUT 달성'},
  {id:'level_2',name:'개화',emoji:'🌸',desc:'Lv.2 BLOOM 달성'},
  {id:'level_3',name:'가지',emoji:'🌳',desc:'Lv.3 BRANCH 달성'},
  {id:'echo_10',name:'에코 마스터',emoji:'🗣️',desc:'에코 10회 완료'},
  {id:'freetalk_5',name:'수다쟁이',emoji:'💬',desc:'프리톡 5회'},
  {id:'daily_goal_3',name:'꾸준한 학습자',emoji:'📅',desc:'일일 목표 3일 연속 달성'}
];

// ===== CONTENT DATA (Lv.0~Lv.2) =====
const CONTENT = {
  tpr: {
    0: [
      {instruction:"Touch your head",options:['😀','🦶','✋','👤'],answer:0,emojis:['Head','Foot','Hand','Body'],audio:'Touch your head'},
      {instruction:"Where is the dog?",options:['🐱','🐶','🐟','🐦'],answer:1,emojis:['Cat','Dog','Fish','Bird'],audio:'Where is the dog?'},
      {instruction:"Show me the apple",options:['🍌','🍊','🍎','🍇'],answer:2,emojis:['Banana','Orange','Apple','Grape'],audio:'Show me the apple'},
      {instruction:"Point to the color red",options:['🔵','🟢','🟡','🔴'],answer:3,emojis:['Blue','Green','Yellow','Red'],audio:'Point to the color red'},
      {instruction:"Find the number three",options:['1️⃣','2️⃣','3️⃣','4️⃣'],answer:2,emojis:['One','Two','Three','Four'],audio:'Find the number three'},
      {instruction:"Touch your nose",options:['👁️','👃','👄','👂'],answer:1,emojis:['Eye','Nose','Mouth','Ear'],audio:'Touch your nose'},
      {instruction:"Where is the sun?",options:['🌙','⭐','☁️','☀️'],answer:3,emojis:['Moon','Star','Cloud','Sun'],audio:'Where is the sun?'},
      {instruction:"Show me the car",options:['🚗','✈️','🚢','🚂'],answer:0,emojis:['Car','Plane','Ship','Train'],audio:'Show me the car'},
      {instruction:"Find the happy face",options:['😢','😠','😀','😴'],answer:2,emojis:['Sad','Angry','Happy','Sleepy'],audio:'Find the happy face'},
      {instruction:"Point to the fish",options:['🐶','🐱','🐠','🐥'],answer:2,emojis:['Dog','Cat','Fish','Chick'],audio:'Point to the fish'}
    ],
    1: [
      {instruction:"Touch something you eat with",options:['🍽️','👟','📱','🎒'],answer:0,emojis:['Plate','Shoes','Phone','Bag'],audio:'Touch something you eat with'},
      {instruction:"Where do you sleep?",options:['🪑','🛏️','🚿','🚪'],answer:1,emojis:['Chair','Bed','Shower','Door'],audio:'Where do you sleep?'},
      {instruction:"Show me something cold",options:['☀️','🔥','🍦','🏖️'],answer:2,emojis:['Sun','Fire','Ice cream','Beach'],audio:'Show me something cold'},
      {instruction:"Find the biggest animal",options:['🐜','🐕','🐘','🐱'],answer:2,emojis:['Ant','Dog','Elephant','Cat'],audio:'Find the biggest animal'}
    ],
    2: [
      {instruction:"Which one is a vegetable?",options:['🥕','🍕','📱','🚗'],answer:0,emojis:['Carrot','Pizza','Phone','Car'],audio:'Which one is a vegetable?'},
      {instruction:"Find something you wear",options:['🎸','👟','📚','🍎'],answer:1,emojis:['Guitar','Sneakers','Books','Apple'],audio:'Find something you wear'},
      {instruction:"Which is a season?",options:['🏠','🎂','❄️','📺'],answer:2,emojis:['House','Cake','Winter','TV'],audio:'Which is a season?'},
      {instruction:"Point to the musical instrument",options:['🖥️','📖','🎸','🧹'],answer:2,emojis:['Computer','Book','Guitar','Broom'],audio:'Point to the musical instrument'},
      {instruction:"Where do you cook?",options:['🛏️','🍳','📐','🎮'],answer:1,emojis:['Bed','Kitchen','Ruler','Game'],audio:'Where do you cook?'}
    ]
  },
  echo: {
    0: [
      {word:'Hello',korean:'안녕하세요'},{word:'Apple',korean:'사과'},{word:'Dog',korean:'개'},
      {word:'Cat',korean:'고양이'},{word:'Water',korean:'물'},{word:'Book',korean:'책'},
      {word:'Sun',korean:'태양'},{word:'Moon',korean:'달'},{word:'Happy',korean:'행복한'},
      {word:'Red',korean:'빨간색'},{word:'Blue',korean:'파란색'},{word:'One',korean:'하나'},
      {word:'Two',korean:'둘'},{word:'Three',korean:'셋'},{word:'Mom',korean:'엄마'},
      {word:'Dad',korean:'아빠'},{word:'Head',korean:'머리'},{word:'Hand',korean:'손'},
      {word:'Fish',korean:'물고기'},{word:'Milk',korean:'우유'},{word:'Tree',korean:'나무'},
      {word:'Star',korean:'별'},{word:'Rain',korean:'비'},{word:'Snow',korean:'눈'},
      {word:'Big',korean:'큰'},{word:'Small',korean:'작은'}
    ],
    1: [
      {word:'Hello!',korean:'안녕!'},{word:'Thank you',korean:'감사합니다'},
      {word:'How are you?',korean:'어떻게 지내요?'},{word:'My name is...',korean:'제 이름은...'},
      {word:'Good morning',korean:'좋은 아침'},{word:'Goodbye',korean:'안녕히 가세요'},
      {word:'Yes, please',korean:'네, 부탁해요'},{word:'No, thank you',korean:'아니요, 괜찮아요'},
      {word:"I'm fine",korean:'저는 괜찮아요'},{word:'See you',korean:'또 봐요'},
      {word:'Excuse me',korean:'실례합니다'},{word:"I'm sorry",korean:'죄송합니다'},
      {word:'What time is it?',korean:'몇 시예요?'},{word:'I like music',korean:'나는 음악을 좋아해요'},
      {word:"Let's try",korean:'해봐요'},{word:'Can you help me?',korean:'도와줄 수 있어요?'},
      {word:'I understand',korean:'이해해요'},{word:'Say it again, please',korean:'다시 말해주세요'}
    ],
    2: [
      {word:'I wake up at seven',korean:'나는 7시에 일어나요'},
      {word:'I like pizza',korean:'나는 피자를 좋아해요'},
      {word:'Can I have water?',korean:'물 주시겠어요?'},
      {word:'Where is the bathroom?',korean:'화장실이 어디예요?'},
      {word:"It's sunny today",korean:'오늘 날씨가 좋아요'},
      {word:'I go to school',korean:'나는 학교에 가요'},
      {word:'I take the bus every day',korean:'나는 매일 버스를 타요'},
      {word:'What are your hobbies?',korean:'취미가 뭐예요?'},
      {word:'I have one brother',korean:'나는 형제가 한 명 있어요'},
      {word:'The weather is nice today',korean:'오늘 날씨가 좋아요'},
      {word:'Practice makes perfect',korean:'연습이 완벽을 만들어요'},
      {word:'Could you speak slower?',korean:'좀 더 천천히 말해주실래요?'}
    ]
  },
  chant: {
    1: [
      {pattern:'My name is ___',lines:['My name is Kim.','My name is Lee.','My name is Park.','My name is ___!'],korean:'제 이름은 ___입니다'},
      {pattern:'I like ___',lines:['I like apples.','I like bananas.','I like oranges.','I like ___!'],korean:'나는 ___을/를 좋아해요'},
      {pattern:'I can ___',lines:['I can run.','I can jump.','I can swim.','I can ___!'],korean:'나는 ___할 수 있어요'},
      {pattern:'Do you have ___?',lines:['Do you have a pen?','Do you have a sister?','Do you have a pet?','Do you have ___?'],korean:'___이/가 있나요?'}
    ],
    2: [
      {pattern:'I ___ every day',lines:['I eat breakfast every day.','I go to school every day.','I read books every day.','I ___ every day!'],korean:'나는 매일 ___해요'},
      {pattern:'Do you like ___?',lines:['Do you like coffee?','Do you like music?','Do you like sports?','Do you like ___?'],korean:'___을/를 좋아하나요?'},
      {pattern:'I want to ___',lines:['I want to travel.','I want to learn.','I want to play.','I want to ___!'],korean:'나는 ___하고 싶어요'},
      {pattern:'Have you ever ___?',lines:['Have you ever traveled abroad?','Have you ever tried sushi?','Have you ever seen snow?','Have you ever ___?'],korean:'___해 본 적 있나요?'}
    ]
  },
  story: {
    1: [
      {title:'The Hungry Cat',story:"A cat is hungry. The cat sees a fish. The cat eats the fish. The cat is happy!",
       questions:[{q:"What does the cat see?",options:['A dog','A fish','A bird'],answer:1}],
       korean:'고양이가 배가 고파요. 고양이가 물고기를 봐요. 고양이가 물고기를 먹어요. 고양이가 행복해요!'},
      {title:'Good Morning',story:"Tom wakes up. He brushes his teeth. He eats breakfast. He goes to school. Good morning, Tom!",
       questions:[{q:"What does Tom do first?",options:['Eat breakfast','Brush teeth','Go to school'],answer:1}],
       korean:'톰이 일어나요. 이를 닦아요. 아침을 먹어요. 학교에 가요. 좋은 아침이야, 톰!'},
      {title:'The Lost Ball',story:"A boy has a red ball. He plays in the park. The ball goes into the water. A duck brings the ball back. The boy is so happy! He says thank you to the duck.",
       questions:[{q:"Where does the ball go?",options:['Into a tree','Into the water','Into a house'],answer:1},{q:"Who brings the ball back?",options:['A dog','A girl','A duck'],answer:2}],
       korean:'소년에게 빨간 공이 있어요. 공원에서 놀아요. 공이 물에 빠져요. 오리가 공을 가져다줘요. 소년이 너무 기뻐요! 오리에게 고맙다고 해요.'}
    ],
    2: [
      {title:'Shopping Day',story:"Lisa goes to the store. She wants to buy apples and milk. The apples are two dollars. The milk is three dollars. She pays five dollars. She goes home and makes a smoothie.",
       questions:[{q:"How much does Lisa pay?",options:['$3','$5','$2'],answer:1},{q:"What does Lisa make?",options:['Cake','Soup','Smoothie'],answer:2}],
       korean:'리사가 가게에 가요. 사과와 우유를 사고 싶어요. 사과는 2달러, 우유는 3달러예요. 5달러를 내요. 집에 가서 스무디를 만들어요.'},
      {title:'The Birthday Party',story:"Today is Emma's birthday. She is seven years old. Her friends come to the party. They eat cake and play games. Emma gets a teddy bear from her best friend. It is the best birthday ever!",
       questions:[{q:"How old is Emma?",options:['Six','Seven','Eight'],answer:1},{q:"What does Emma get from her best friend?",options:['A book','A doll','A teddy bear'],answer:2}],
       korean:'오늘은 엠마의 생일이에요. 일곱 살이에요. 친구들이 파티에 와요. 케이크를 먹고 게임을 해요. 엠마는 친한 친구에게 곰 인형을 받아요. 최고의 생일이에요!'}
    ]
  },
  roleplay: {
    2: [
      {scenario:'카페에서 주문하기',emoji:'☕',aiRole:'바리스타',userRole:'손님',
       opening:"Hi! Welcome to Happy Cafe. What can I get for you today?",
       korean:'안녕하세요! Happy Cafe에 오신 걸 환영해요. 뭘 드릴까요?',
       hints:['I want a coffee, please.','Can I have a latte?','How much is it?']},
      {scenario:'길 묻기',emoji:'🗺️',aiRole:'행인',userRole:'여행자',
       opening:"Oh, you look lost. Can I help you?",
       korean:'길을 잃은 것 같네요. 도와드릴까요?',
       hints:['Where is the station?','How do I get to the park?','Is it far from here?']},
      {scenario:'음식 주문하기',emoji:'🍔',aiRole:'웨이터',userRole:'손님',
       opening:"Hello! Here is the menu. Are you ready to order?",
       korean:'안녕하세요! 메뉴판이에요. 주문하시겠어요?',
       hints:["I'd like a hamburger.","Can I have some water?","What do you recommend?"]},
      {scenario:'병원 방문하기',emoji:'🏥',aiRole:'의사',userRole:'환자',
       opening:"Good morning! What brings you here today? How are you feeling?",
       korean:'좋은 아침이에요! 오늘 어떻게 오셨어요? 어디가 불편하세요?',
       hints:['I have a headache.','My stomach hurts.','I feel tired.']},
      {scenario:'호텔 체크인',emoji:'🏨',aiRole:'프론트 직원',userRole:'투숙객',
       opening:"Welcome to Grand Hotel! Do you have a reservation?",
       korean:'그랜드 호텔에 오신 것을 환영합니다! 예약하셨나요?',
       hints:['I have a reservation under my name.','Can I have a room with a view?','What time is check-out?']}
    ]
  },
  mission: {
    1: [
      {title:'단어 스프린트',desc:'30초 안에 5개 단어 따라 말하기!',timeLimit:30,
       words:['Hello','Apple','Book','Cat','Sun'],type:'echo_sprint'},
      {title:'듣기 퀴즈',desc:'20초 안에 3문제 맞추기!',timeLimit:20,
       questions:[
         {audio:'Show me the apple',options:['🍎','🍌','🍊'],answer:0},
         {audio:'Where is the dog?',options:['🐱','🐶','🐟'],answer:1},
         {audio:'Point to blue',options:['🔴','🟢','🔵'],answer:2}
       ],type:'listen_quiz'},
      {title:'문장 만들기',desc:'25초 안에 단어를 조합해 문장을 완성하세요!',timeLimit:25,
       words:['I','like','to','eat','apples'],type:'sentence_build'},
      {title:'빠른 응답',desc:'20초 안에 4개 질문에 답하기!',timeLimit:20,
       questions:[
         {audio:'What color is the sky?',options:['🔴 Red','🔵 Blue','🟢 Green'],answer:1},
         {audio:'How many legs does a cat have?',options:['2','4','6'],answer:1},
         {audio:'What do you drink in the morning?',options:['🥤 Juice','☕ Coffee','🍕 Pizza'],answer:1},
         {audio:'Where do fish live?',options:['🌳 Tree','🏔️ Mountain','🌊 Water'],answer:2}
       ],type:'listen_quiz'}
    ]
  }
};

// ===== DIAGNOSTIC QUESTIONS =====
const DIAG_QUESTIONS = [
  {type:'listen',q:'다음 중 "apple"의 뜻은?',options:['바나나','사과','오렌지','포도'],answer:1,level:0},
  {type:'listen',q:'"How are you?"에 대한 올바른 답은?',options:["I'm fine.","I'm ten.","I'm Kim.","I'm school."],answer:0,level:1},
  {type:'grammar',q:'빈칸에 알맞은 것은?\n"She ___ to school every day."',options:['go','goes','going','gone'],answer:1,level:2},
  {type:'grammar',q:'올바른 문장은?',options:["I have been to Japan.","I have go to Japan.","I been to Japan.","I has been Japan."],answer:0,level:3},
  {type:'expression',q:'"Could you tell me the way to the station?"은 어떤 상황?',options:['음식 주문','길 물어보기','자기소개','전화 통화'],answer:1,level:2},
  {type:'grammar',q:'빈칸에 알맞은 것은?\n"If I ___ rich, I would travel."',options:['am','was','were','be'],answer:2,level:4},
  {type:'expression',q:'"I couldn\'t agree more"의 의미는?',options:['전혀 동의 못함','완전 동의','잘 모르겠음','생각 중'],answer:1,level:4},
  {type:'grammar',q:'알맞은 표현은?\n"Not only ___ intelligent, but also creative."',options:['she is','is she','she was','does she'],answer:1,level:5}
];

// ===== STATE =====
let state = {
  level: 0, xp: 0, totalXp: 0, streak: 0, lastStudyDate: null,
  sessions: 0, correctCount: 0, totalCount: 0, badges: [],
  dailyXp: 0, dailyDate: null, apiKey: '', settings: {ttsSpeed:1, autoTts:true, showKorean:true, reminderTime:''},
  studyLog: [], onboarded: false, diagnosed: false, activityCounts: {},
  studyTimeMs: 0, sessionsCompleted: 0,
  difficultyOffset: 0, consecutiveCorrect: 0, consecutiveWrong: 0,
  reviewQueue: [],
  skillScores: {listening:0, speaking:0, vocabulary:0, grammar:0, fluency:0},
  dailyGoalStreak: 0,
  completedTopics: [],
  conversationScores: [],
  achievements: {unlocked:[], progress:{}, dates:{}},
  dailySessions: 0, dailySessionDate: null,
  perfectEchoCount: 0, noGrammarErrorConvCount: 0
};

// ===== INIT =====
function init(){
  loadState();
  setTimeout(()=>{
    document.getElementById('splash').classList.add('hidden');
    if(!state.onboarded){
      showOnboarding();
    } else if(!state.diagnosed){
      startDiagnostic();
    } else {
      showApp();
    }
  },1500);
  bestVoice=getBestEnglishVoice();
  document.body.addEventListener('touchstart',()=>{speechSynthesis.speak(new SpeechSynthesisUtterance(''));},{once:true});
}

function loadState(){
  try{
    const saved=localStorage.getItem('myEnglishCoach');
    if(saved){
      const parsed=JSON.parse(saved);
      state={...state,...parsed};
      // check streak
      const today=new Date().toDateString();
      if(state.lastStudyDate){
        const last=new Date(state.lastStudyDate);
        const diff=Math.floor((new Date(today)-last)/(1000*60*60*24));
        if(diff>1) state.streak=0;
      }
      if(state.dailyDate!==today){state.dailyXp=0;state.dailyDate=today;}
    }
  }catch(e){console.error('Load error',e);}
}

function saveState(){
  try{localStorage.setItem('myEnglishCoach',JSON.stringify(state));}catch(e){}
}

// ===== ONBOARDING =====
let onbPage=0;
function showOnboarding(){
  const el=document.getElementById('onboarding');
  el.classList.add('active');
  buildOnbDots();
  updateOnbPage();
}

function buildOnbDots(){
  const dots=document.getElementById('onbDots');
  dots.innerHTML='';
  for(let i=0;i<4;i++){
    const s=document.createElement('span');
    if(i===0) s.classList.add('active');
    dots.appendChild(s);
  }
}

function updateOnbPage(){
  document.querySelectorAll('.onb-page').forEach((p,i)=>{
    p.classList.toggle('active',i===onbPage);
  });
  document.querySelectorAll('#onbDots span').forEach((d,i)=>{
    d.classList.toggle('active',i===onbPage);
  });
  const nextBtn=document.getElementById('onbNextBtn');
  const skipBtn=document.getElementById('onbSkipBtn');
  if(onbPage===2){
    nextBtn.textContent='다음';
    skipBtn.style.display='block';
    skipBtn.textContent='API 키 없이 계속';
  } else if(onbPage===3){
    nextBtn.textContent='진단 테스트 시작';
    skipBtn.style.display='block';
    skipBtn.textContent='건너뛰고 Lv.0 시작';
  } else {
    nextBtn.textContent='다음';
    skipBtn.style.display='none';
  }
}

document.getElementById('onbNextBtn').addEventListener('click',()=>{
  if(onbPage===2){
    const key=document.getElementById('apiKeyInput').value.trim();
    if(key) state.apiKey=key;
  }
  if(onbPage===3){
    state.onboarded=true;saveState();
    document.getElementById('onboarding').classList.remove('active');
    startDiagnostic();
    return;
  }
  onbPage++;
  updateOnbPage();
});

document.getElementById('onbSkipBtn').addEventListener('click',()=>{
  if(onbPage===2){
    onbPage++;updateOnbPage();
  } else if(onbPage===3){
    state.onboarded=true;state.diagnosed=true;state.level=0;saveState();
    document.getElementById('onboarding').classList.remove('active');
    showApp();
  }
});

// ===== DIAGNOSTIC TEST =====
let diagIdx=0, diagScore=0, diagAnswers=[];

function startDiagnostic(){
  diagIdx=0;diagScore=0;diagAnswers=[];
  const view=document.getElementById('diagnosticView');
  view.style.display='block';
  buildDiagProgress();
  showDiagQuestion();
}

function buildDiagProgress(){
  const bar=document.getElementById('diagProgress');
  bar.innerHTML='';
  for(let i=0;i<DIAG_QUESTIONS.length;i++){
    const d=document.createElement('div');
    d.className='dp'+(i===0?' current':'');
    bar.appendChild(d);
  }
}

function showDiagQuestion(){
  if(diagIdx>=DIAG_QUESTIONS.length){
    finishDiagnostic();return;
  }
  const q=DIAG_QUESTIONS[diagIdx];
  const cont=document.getElementById('diagContent');
  cont.innerHTML=`
    <div class="diag-question">
      <div class="q-num">문제 ${diagIdx+1} / ${DIAG_QUESTIONS.length}</div>
      <div class="q-text">${q.q.replace(/\n/g,'<br>')}</div>
    </div>
    <div class="diag-options" id="diagOptions">
      ${q.options.map((o,i)=>`<button class="diag-option" data-idx="${i}">${o}</button>`).join('')}
    </div>`;
  cont.querySelectorAll('.diag-option').forEach(btn=>{
    btn.addEventListener('click',()=>selectDiagAnswer(parseInt(btn.dataset.idx)));
  });
}

function selectDiagAnswer(idx){
  const q=DIAG_QUESTIONS[diagIdx];
  const opts=document.querySelectorAll('.diag-option');
  opts.forEach(o=>o.style.pointerEvents='none');
  opts[idx].classList.add(idx===q.answer?'correct':'wrong');
  if(idx!==q.answer) opts[q.answer].classList.add('correct');
  if(idx===q.answer) diagScore+=q.level+1;
  diagAnswers.push(idx===q.answer);

  // Update progress
  const bars=document.querySelectorAll('.diag-progress .dp');
  bars[diagIdx].classList.remove('current');
  bars[diagIdx].classList.add('done');
  
  setTimeout(()=>{
    diagIdx++;
    if(diagIdx<bars.length) bars[diagIdx].classList.add('current');
    showDiagQuestion();
  },1000);
}

function finishDiagnostic(){
  let level=0;
  if(diagScore>=20) level=5;
  else if(diagScore>=15) level=4;
  else if(diagScore>=10) level=3;
  else if(diagScore>=6) level=2;
  else if(diagScore>=3) level=1;
  else level=0;

  state.level=level;state.diagnosed=true;saveState();
  const lv=LEVELS[level];
  document.getElementById('diagContent').innerHTML=`
    <div style="text-align:center;padding:32px 0;">
      <div style="font-size:80px;margin-bottom:16px;">${lv.emoji}</div>
      <h2 style="font-size:24px;font-weight:800;">Lv.${level} ${lv.name}</h2>
      <p style="font-size:14px;color:var(--text-secondary);margin:8px 0;">${lv.label} · ${lv.desc}</p>
      <p style="font-size:13px;color:var(--text-secondary);margin:16px 0;">
        진단 점수: ${diagScore}점<br>
        정답: ${diagAnswers.filter(a=>a).length} / ${DIAG_QUESTIONS.length}
      </p>
      <button class="btn btn-primary btn-full" onclick="document.getElementById('diagnosticView').style.display='none';showApp();" style="margin-top:24px;">
        학습 시작하기 🚀
      </button>
    </div>`;
  document.getElementById('diagProgress').style.display='none';
}

// ===== MAIN APP =====
function showApp(){
  document.getElementById('appHeader').style.display='flex';
  document.getElementById('tabNav').style.display='flex';
  updateHeader();
  renderHome();
  renderActivities();
  renderStats();
  switchTab('home',document.querySelector('.tab-nav button'));
  checkStudyReminder();
}

function updateHeader(){
  const lv=LEVELS[state.level];
  document.getElementById('headerTree').textContent=lv.emoji;
  document.getElementById('headerLevel').textContent=`Lv.${state.level} ${lv.name}`;
  document.getElementById('headerStreak').textContent=state.streak;
  const xpInLevel=state.xp;
  const xpNeeded=lv.xpNeeded;
  const pct=Math.min(100,Math.round((xpInLevel/xpNeeded)*100));
  document.getElementById('headerXpBar').style.width=pct+'%';
}

function switchTab(tab,btn){
  document.querySelectorAll('.tab-nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const map={home:'pageHome',activities:'pageActivities',freetalk:'pageFreeTalk',stats:'pageStats'};
  document.getElementById(map[tab]).classList.add('active');
  if(tab==='stats') renderStats();
  if(tab==='freetalk') initFreeTalk();
}

// ===== GROWTH TREE SVG =====
function getTreeSVG(level, progress){
  const p=Math.max(0,Math.min(1,progress));
  const C=471;
  const offset=C-C*p;
  const COLORS=['#8B7355','#4ADE80','#F472B6','#22C55E','#166534','#EAB308'];
  const ringColor=COLORS[level]||COLORS[0];
  let tree='';

  if(level===0){
    const sproutH=8+p*20;
    const leafSize=p*6;
    tree=`
      <ellipse cx="80" cy="170" rx="50" ry="12" fill="#D2B48C" opacity=".6"/>
      <rect x="72" y="155" width="16" height="18" rx="6" fill="#8B7355"/>
      <rect x="78" y="${158-sproutH}" width="4" height="${sproutH}" rx="2" fill="#4ADE80" opacity="${(.3+p*.7).toFixed(2)}"/>
      ${p>0.3?`<ellipse cx="${80-leafSize}" cy="${155-sproutH+4}" rx="${leafSize}" ry="${leafSize*.6}" fill="#4ADE80" opacity="${p.toFixed(2)}"/>`:''}  
      ${p>0.6?`<ellipse cx="${80+leafSize}" cy="${155-sproutH+10}" rx="${leafSize*.8}" ry="${leafSize*.5}" fill="#86EFAC" opacity="${p.toFixed(2)}"/>`:''}  
    `;
  } else if(level===1){
    const h=40+p*20;
    const lS=8+p*6;
    tree=`
      <ellipse cx="80" cy="170" rx="45" ry="10" fill="#D2B48C" opacity=".5"/>
      <rect x="77" y="${170-h}" width="6" height="${h}" rx="3" fill="#22C55E"/>
      <ellipse cx="${68-p*4}" cy="${150-p*15}" rx="${lS}" ry="${lS*.55}" fill="#4ADE80" transform="rotate(-25 68 150)"/>
      <ellipse cx="${92+p*4}" cy="${142-p*12}" rx="${lS*.9}" ry="${lS*.5}" fill="#86EFAC" transform="rotate(20 92 142)"/>
      ${p>0.4?`<ellipse cx="75" cy="${132-p*14}" rx="${lS*.7}" ry="${lS*.4}" fill="#BBF7D0" transform="rotate(-15 75 132)"/>`:''}  
    `;
  } else if(level===2){
    const flowerR=4+p*5;
    tree=`
      <ellipse cx="80" cy="172" rx="40" ry="8" fill="#D2B48C" opacity=".4"/>
      <rect x="76" y="100" width="8" height="72" rx="4" fill="#22C55E"/>
      <ellipse cx="65" cy="125" rx="14" ry="8" fill="#4ADE80" transform="rotate(-20 65 125)"/>
      <ellipse cx="95" cy="118" rx="12" ry="7" fill="#86EFAC" transform="rotate(15 95 118)"/>
      <ellipse cx="72" cy="108" rx="10" ry="6" fill="#BBF7D0" transform="rotate(-10 72 108)"/>
      <circle cx="80" cy="92" r="${flowerR}" fill="#F9A8D4" opacity="${(.5+p*.5).toFixed(2)}"/>
      ${p>0.3?`<circle cx="68" cy="100" r="${flowerR*.7}" fill="#F472B6" opacity="${p.toFixed(2)}"/>`:''}  
      ${p>0.6?`<circle cx="92" cy="96" r="${flowerR*.6}" fill="#FBCFE8" opacity="${p.toFixed(2)}"/>`:''}  
      ${p>0.5?`<circle cx="80" cy="92" r="${flowerR*.3}" fill="#FDE68A"/>`:''}  
    `;
  } else if(level===3){
    const canopyR=28+p*12;
    tree=`
      <ellipse cx="80" cy="174" rx="35" ry="6" fill="#D2B48C" opacity=".3"/>
      <rect x="72" y="110" width="16" height="64" rx="4" fill="#92400E"/>
      <rect x="62" y="150" width="10" height="20" rx="3" fill="#92400E" transform="rotate(-20 67 160)"/>
      <rect x="88" y="148" width="8" height="18" rx="3" fill="#92400E" transform="rotate(15 92 157)"/>
      <circle cx="80" cy="${100-p*8}" r="${canopyR}" fill="#22C55E" class="tree-sway"/>
      <circle cx="68" cy="${95-p*6}" r="${canopyR*.6}" fill="#4ADE80" class="tree-sway"/>
      <circle cx="92" cy="${92-p*7}" r="${canopyR*.5}" fill="#86EFAC" class="tree-sway"/>
    `;
  } else if(level===4){
    const fruits=Math.floor(1+p*5);
    const fp=[[65,72],[95,68],[58,85],[100,82],[78,60],[88,78]];
    tree=`
      <ellipse cx="80" cy="176" rx="30" ry="5" fill="#D2B48C" opacity=".3"/>
      <rect x="70" y="95" width="20" height="80" rx="5" fill="#78350F"/>
      <rect x="56" y="140" width="12" height="30" rx="4" fill="#78350F" transform="rotate(-25 62 155)"/>
      <rect x="92" y="138" width="10" height="28" rx="4" fill="#78350F" transform="rotate(20 97 152)"/>
      <circle cx="80" cy="75" r="40" fill="#166534" class="tree-sway"/>
      <circle cx="62" cy="80" r="22" fill="#22C55E" class="tree-sway"/>
      <circle cx="98" cy="78" r="20" fill="#15803D" class="tree-sway"/>
      <circle cx="80" cy="60" r="18" fill="#4ADE80" class="tree-sway"/>
      ${fp.slice(0,fruits).map(([x,y])=>`<circle cx="${x}" cy="${y}" r="4" fill="#EF4444"><animate attributeName="r" values="3.5;4.5;3.5" dur="2s" repeatCount="indefinite"/></circle>`).join('')}
    `;
  } else {
    tree=`
      <ellipse cx="80" cy="176" rx="30" ry="5" fill="#FDE68A" opacity=".4"/>
      <rect x="70" y="90" width="20" height="85" rx="5" fill="#B45309"/>
      <rect x="55" y="135" width="12" height="30" rx="4" fill="#B45309" transform="rotate(-25 61 150)"/>
      <rect x="93" y="132" width="10" height="28" rx="4" fill="#B45309" transform="rotate(20 98 146)"/>
      <circle cx="80" cy="68" r="42" fill="#EAB308" class="tree-sway"/>
      <circle cx="62" cy="74" r="24" fill="#FACC15" class="tree-sway"/>
      <circle cx="98" cy="72" r="22" fill="#FDE68A" class="tree-sway"/>
      <circle cx="80" cy="52" r="18" fill="#FEF9C3" class="tree-sway"/>
      <circle cx="65" cy="48" r="3" fill="#FFF" class="tree-sparkle"><animate attributeName="opacity" values=".3;1;.3" dur="1.5s" repeatCount="indefinite"/></circle>
      <circle cx="95" cy="52" r="2.5" fill="#FFF" class="tree-sparkle" style="animation-delay:.3s"><animate attributeName="opacity" values=".5;1;.5" dur="1.8s" repeatCount="indefinite"/></circle>
      <circle cx="80" cy="38" r="3.5" fill="#FFF" class="tree-sparkle" style="animation-delay:.7s"><animate attributeName="opacity" values=".4;1;.4" dur="1.3s" repeatCount="indefinite"/></circle>
      <circle cx="55" cy="60" r="2" fill="#FFF" class="tree-sparkle" style="animation-delay:1s"><animate attributeName="opacity" values=".3;1;.3" dur="2s" repeatCount="indefinite"/></circle>
      <circle cx="105" cy="58" r="2" fill="#FFF" class="tree-sparkle" style="animation-delay:.5s"><animate attributeName="opacity" values=".5;1;.5" dur="1.6s" repeatCount="indefinite"/></circle>
    `;
  }

  return `<svg viewBox="0 0 160 200" class="growth-tree-svg tree-glow" xmlns="http://www.w3.org/2000/svg">
    <circle cx="80" cy="100" r="75" fill="none" stroke="#E2E8F0" stroke-width="3"/>
    <circle cx="80" cy="100" r="75" fill="none" stroke="${ringColor}" stroke-width="3"
      stroke-dasharray="${C}" stroke-dashoffset="${offset.toFixed(1)}"
      stroke-linecap="round" class="tree-xp-ring" transform="rotate(-90 80 100)"/>
    ${tree}
  </svg>`;
}

function toggleTreeInfo(){
  const popup=document.getElementById('treeInfoPopup');
  if(popup.classList.contains('show')){
    popup.classList.remove('show');
    return;
  }
  const lv=LEVELS[state.level];
  const remaining=lv.xpNeeded-state.xp;
  const sessions=Math.ceil(remaining/30);
  popup.textContent=`🌱 다음 레벨까지 ${remaining} XP 남았어요! (약 ${sessions}회 학습)`;
  popup.classList.add('show');
  setTimeout(()=>popup.classList.remove('show'),3000);
}

// ===== HOME =====
function renderHome(){
  const lv=LEVELS[state.level];
  const xpProgress=Math.min(1,state.xp/lv.xpNeeded);
  document.getElementById('growthTreeVisual').innerHTML=getTreeSVG(state.level,xpProgress);
  document.getElementById('growthLevelName').textContent=`Lv.${state.level} ${lv.name}`;
  document.getElementById('growthLevelDesc').textContent=`${lv.label} · ${lv.desc} · ${getDifficultyLabel()}`;

  // Tree stages
  const stages=document.getElementById('treeStages');
  stages.innerHTML='';
  LEVELS.forEach((l,i)=>{
    const d=document.createElement('div');
    d.className='stage'+(i<state.level?' reached':'')+(i===state.level?' current':'');
    d.textContent=l.emoji;
    stages.appendChild(d);
  });

  // Daily goal
  const today=new Date().toDateString();
  if(state.dailyDate!==today){state.dailyXp=0;state.dailyDate=today;}
  const dailyGoalMet=state.dailyXp>=50;
  document.getElementById('dailyGoalText').textContent=dailyGoalMet
    ?`🎉 목표 달성! ${state.dailyXp} XP (연속 ${state.dailyGoalStreak||0}일)`
    :`XP ${state.dailyXp} / 50`;
  document.getElementById('dailyXpBar').style.width=Math.min(100,(state.dailyXp/50)*100)+'%';
  const goalCard=document.getElementById('dailyGoalCard');
  if(goalCard){
    goalCard.style.background=dailyGoalMet?'linear-gradient(135deg,#EEF2FF,#E0E7FF)':'var(--card)';
  }
  if(dailyGoalMet) checkDailyGoalStreak();

  // Recent activity
  const recent=state.studyLog.slice(-3).reverse();
  if(recent.length>0){
    document.getElementById('recentActivity').textContent=recent.map(r=>`${r.activity} (${r.date})`).join(' · ');
  }

  // Review card
  const reviewItems = getReviewItems();
  const reviewCard = document.getElementById('reviewCard');
  if(reviewItems.length > 0){
    reviewCard.style.display = 'block';
    document.getElementById('reviewCardText').textContent = `${reviewItems.length}개 항목 복습 대기 중`;
  } else {
    reviewCard.style.display = 'none';
  }
}

// ===== ACTIVITIES =====
function renderActivities(){
  const grid=document.getElementById('activityGrid');
  grid.innerHTML='';
  ACTIVITIES.forEach(act=>{
    const locked=state.level<act.minLevel;
    const d=document.createElement('div');
    d.className='activity-card'+(locked?' locked':'');
    d.innerHTML=`<div class="act-emoji">${act.emoji}</div><h4>${act.name}</h4><p>${act.desc}</p>`;
    if(!locked) d.addEventListener('click',()=>startActivity(act.id));
    grid.appendChild(d);
  });
}

// ===== STATS =====
function renderStats(){
  document.getElementById('statTotalXp').textContent=state.totalXp+' XP';
  document.getElementById('statLevel').textContent=`Lv.${state.level} ${LEVELS[state.level].name}`;
  document.getElementById('statSessions').textContent=state.sessions+'회';
  document.getElementById('statStreak').textContent=state.streak+'일';
  const acc=state.totalCount>0?Math.round((state.correctCount/state.totalCount)*100):0;
  document.getElementById('statAccuracy').textContent=acc+'%';
  document.getElementById('statTime').textContent=Math.round(state.studyTimeMs/60000)+'분';

  // Badges
  const bg=document.getElementById('badgeGrid');
  bg.innerHTML='';
  BADGES.forEach(b=>{
    const earned=state.badges.includes(b.id);
    const d=document.createElement('div');
    d.className='badge'+(earned?' earned':'');
    d.textContent=b.emoji;
    d.title=b.name+': '+b.desc;
    bg.appendChild(d);
  });

  // Study log
  const log=document.getElementById('studyLog');
  if(state.studyLog.length>0){
    log.innerHTML=state.studyLog.slice(-10).reverse().map(r=>
      `<div style="padding:6px 0;border-bottom:1px solid #F1F5F9;">${r.date} - ${r.activity} (+${r.xp} XP)</div>`
    ).join('');
  }

  // === WEEKLY GRAPH ===
  renderWeeklyGraph();

  // === RADAR CHART ===
  renderRadarChart();

  // === LEVEL PREDICTION ===
  renderLevelPrediction();

  // === ACHIEVEMENTS ===
  renderAchievements();
}

// ===== WEEKLY GRAPH =====
function renderWeeklyGraph(){
  const container=document.getElementById('weeklyGraph');
  if(!container) return;
  const dayNames=['일','월','화','수','목','금','토'];
  const today=new Date();
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date(today);
    d.setDate(d.getDate()-i);
    days.push(d);
  }
  // Calculate XP per day from studyLog
  const xpPerDay=days.map(d=>{
    const dateStr=d.toLocaleDateString('ko-KR');
    return state.studyLog.filter(r=>r.date===dateStr).reduce((s,r)=>s+(r.xp||0),0);
  });
  const maxXp=Math.max(...xpPerDay,1);
  container.innerHTML=days.map((d,i)=>{
    const pct=Math.max(3,Math.round((xpPerDay[i]/maxXp)*100));
    const isToday=i===6;
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end;">
      <div style="font-size:10px;color:var(--primary);font-weight:600;margin-bottom:2px;">${xpPerDay[i]>0?xpPerDay[i]:''}</div>
      <div style="width:100%;background:${isToday?'var(--primary)':'#C7D2FE'};border-radius:4px 4px 0 0;min-height:4px;height:${pct}%;transition:height .5s;"></div>
      <span style="font-size:10px;color:var(--text-secondary);margin-top:4px;${isToday?'font-weight:700;color:var(--primary);':''}">${dayNames[d.getDay()]}</span>
    </div>`;
  }).join('');
}

// ===== RADAR CHART =====
function renderRadarChart(){
  const container=document.getElementById('radarChart');
  if(!container) return;
  const skills=state.skillScores||{listening:0,speaking:0,vocabulary:0,grammar:0,fluency:0};
  const labels=['듣기','말하기','어휘','문법','유창성'];
  const keys=['listening','speaking','vocabulary','grammar','fluency'];
  const maxScore=Math.max(...keys.map(k=>skills[k]||0),10);

  // 5 vertices on a pentagon, center (100,100), radius 70
  const cx=100,cy=100,R=70;
  const angles=keys.map((_,i)=> -Math.PI/2 + (2*Math.PI*i/5));
  const outerPts=angles.map(a=>({x:cx+R*Math.cos(a),y:cy+R*Math.sin(a)}));
  const dataPts=angles.map((a,i)=>{
    const r=R*Math.min(1,(skills[keys[i]]||0)/maxScore);
    return {x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)};
  });
  const labelPts=angles.map(a=>({x:cx+(R+18)*Math.cos(a),y:cy+(R+18)*Math.sin(a)}));

  // Grid lines (3 levels)
  let gridLines='';
  for(let g=1;g<=3;g++){
    const gr=R*(g/3);
    const pts=angles.map(a=>`${cx+gr*Math.cos(a)},${cy+gr*Math.sin(a)}`).join(' ');
    gridLines+=`<polygon points="${pts}" fill="none" stroke="#E2E8F0" stroke-width="1"/>`;
  }
  // Axis lines
  const axisLines=outerPts.map(p=>`<line x1="${cx}" y1="${cy}" x2="${p.x}" y2="${p.y}" stroke="#E2E8F0" stroke-width="1"/>`).join('');
  // Data polygon
  const dataPolygon=dataPts.map(p=>`${p.x},${p.y}`).join(' ');
  // Labels
  const labelEls=labels.map((l,i)=>{
    const anchor=labelPts[i].x<95?'end':labelPts[i].x>105?'start':'middle';
    const score=skills[keys[i]]||0;
    return `<text x="${labelPts[i].x}" y="${labelPts[i].y}" text-anchor="${anchor}" dominant-baseline="middle" font-size="11" fill="var(--text-secondary)" font-weight="600">${l}</text>
    <text x="${labelPts[i].x}" y="${labelPts[i].y+13}" text-anchor="${anchor}" dominant-baseline="middle" font-size="9" fill="var(--primary)" font-weight="700">${score}</text>`;
  }).join('');
  // Data dots
  const dots=dataPts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="3" fill="var(--primary)"/>`).join('');

  container.innerHTML=`<svg viewBox="0 0 200 200" width="220" height="220">
    ${gridLines}${axisLines}
    <polygon points="${dataPolygon}" fill="rgba(79,70,229,0.2)" stroke="var(--primary)" stroke-width="2"/>
    ${dots}${labelEls}
  </svg>`;
}

// ===== LEVEL PREDICTION =====
function renderLevelPrediction(){
  const el=document.getElementById('levelPrediction');
  if(!el) return;
  const today=new Date();
  const recentDays=[];
  for(let i=6;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);
    const dateStr=d.toLocaleDateString('ko-KR');
    const dayXp=state.studyLog.filter(r=>r.date===dateStr).reduce((s,r)=>s+(r.xp||0),0);
    recentDays.push(dayXp);
  }
  const avgDaily=recentDays.reduce((a,b)=>a+b,0)/7;
  if(avgDaily<=0 || state.level>=5){
    el.textContent=state.level>=5?'🌟 최고 레벨에 도달했어요!':'아직 학습 데이터가 부족해요. 학습을 시작해보세요!';
    return;
  }
  const lv=LEVELS[state.level];
  const xpRemaining=lv.xpNeeded-state.xp;
  const daysEstimate=Math.ceil(xpRemaining/avgDaily);
  el.innerHTML=`📈 최근 7일 평균: <strong>${Math.round(avgDaily)} XP/일</strong><br>🎯 다음 레벨(${LEVELS[state.level+1]?.name||'MAX'})까지: <strong>약 ${daysEstimate}일</strong> 예상<br><span style="font-size:12px;color:var(--text-secondary);">남은 XP: ${xpRemaining} XP</span>`;
}

// ===== SKILL SCORE HELPER =====
function addSkillScore(skill, amount){
  if(!state.skillScores) state.skillScores={listening:0,speaking:0,vocabulary:0,grammar:0,fluency:0};
  if(state.skillScores[skill]!==undefined){
    state.skillScores[skill]+=amount;
  }
}

// ===== DAILY GOAL STREAK =====
function checkDailyGoalStreak(){
  if(state.dailyXp>=50){
    const today=new Date().toDateString();
    if(state._lastGoalDate!==today){
      // Check if yesterday was the last goal date (consecutive)
      const yesterday=new Date();
      yesterday.setDate(yesterday.getDate()-1);
      if(state._lastGoalDate && state._lastGoalDate!==yesterday.toDateString()){
        // Missed a day - reset streak
        state.dailyGoalStreak=1;
      } else {
        state.dailyGoalStreak=(state.dailyGoalStreak||0)+1;
      }
      state._lastGoalDate=today;
      saveState();
      checkBadges();
    }
  }
}

// ===== STUDY REMINDER =====
function checkStudyReminder(){
  const banner=document.getElementById('studyReminderBanner');
  if(!banner) return;
  const today=new Date().toDateString();
  const hasStudiedToday=state.studyLog.some(r=>r.date===new Date().toLocaleDateString('ko-KR'));
  if(!hasStudiedToday && state.onboarded && state.diagnosed){
    banner.style.display='block';
    // Also try Notification API if reminder time is set
    if(state.settings.reminderTime && 'Notification' in window && Notification.permission==='granted'){
      // Only show notification-style banner; actual push needs SW
    }
  } else {
    banner.style.display='none';
  }
}

// ===== XP & REWARDS =====
function addXp(amount, activityName){
  state.xp+=amount;
  state.totalXp+=amount;
  state.dailyXp+=amount;
  state.sessions++;

  const today=new Date().toLocaleDateString('ko-KR');
  if(state.lastStudyDate!==new Date().toDateString()){
    const last=state.lastStudyDate?new Date(state.lastStudyDate):null;
    const now=new Date();
    if(last){
      const diff=Math.floor((new Date(now.toDateString())-last)/(1000*60*60*24));
      if(diff===1) state.streak++;
      else if(diff>1) state.streak=1;
    } else {
      state.streak=1;
    }
    state.lastStudyDate=now.toDateString();
  }

  state.studyLog.push({date:today,activity:activityName,xp:amount});

  // Check level up
  const lv=LEVELS[state.level];
  if(state.xp>=lv.xpNeeded && state.level<5){
    state.xp-=lv.xpNeeded;
    state.level++;
    showReward(LEVELS[state.level].emoji,`Lv.${state.level} ${LEVELS[state.level].name} 달성!`,`+${amount} XP`,'축하합니다! 새로운 레벨에 도달했어요!');
    checkBadges();
  } else {
    showReward('⭐','잘했어요!',`+${amount} XP`,'계속 성장하고 있어요!');
  }

  checkBadges();
  saveState();
  updateHeader();
  renderHome();
  checkAchievements();
}

function checkBadges(){
  const b=state.badges;
  if(state.sessions>=1 && !b.includes('first_session')) b.push('first_session');
  if(state.streak>=3 && !b.includes('streak_3')) b.push('streak_3');
  if(state.streak>=7 && !b.includes('streak_7')) b.push('streak_7');
  if(state.totalXp>=100 && !b.includes('xp_100')) b.push('xp_100');
  if(state.totalXp>=500 && !b.includes('xp_500')) b.push('xp_500');
  if(state.level>=1 && !b.includes('level_1')) b.push('level_1');
  if(state.level>=2 && !b.includes('level_2')) b.push('level_2');
  if(state.level>=3 && !b.includes('level_3')) b.push('level_3');
  const echoCnt=(state.activityCounts.echo||0);
  if(echoCnt>=10 && !b.includes('echo_10')) b.push('echo_10');
  const ftCnt=(state.activityCounts.freetalk||0);
  if(ftCnt>=5 && !b.includes('freetalk_5')) b.push('freetalk_5');
  if((state.dailyGoalStreak||0)>=3 && !b.includes('daily_goal_3')) b.push('daily_goal_3');
  saveState();
}

function showReward(emoji,title,xp,msg){
  document.getElementById('rewardEmoji').textContent=emoji;
  document.getElementById('rewardTitle').textContent=title;
  document.getElementById('rewardXp').textContent=xp;
  document.getElementById('rewardMsg').textContent=msg;
  document.getElementById('rewardPopup').classList.add('active');
}

function closeReward(){
  document.getElementById('rewardPopup').classList.remove('active');
}

// ===== TTS / STT =====

// Show STT warning banner to user
let _sttWarningTimer=null;
function showSttWarning(msg){
  // Show in multiple places depending on context
  const targets=['orbStatus','echoListenStatus','voiceTranscript','voiceStatusText'];
  let shown=false;
  targets.forEach(id=>{
    const el=document.getElementById(id);
    if(el && (el.offsetParent!==null || el.closest('.active'))){
      el.textContent=msg;
      shown=true;
    }
  });
  // Also show a floating toast if no target was visible
  if(!shown){
    let toast=document.getElementById('sttWarningToast');
    if(!toast){
      toast=document.createElement('div');
      toast.id='sttWarningToast';
      toast.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#FEF3C7;color:#92400E;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,.15);max-width:90%;text-align:center;transition:opacity .3s;';
      document.body.appendChild(toast);
    }
    toast.textContent=msg;
    toast.style.opacity='1';
    toast.style.display='block';
    if(_sttWarningTimer) clearTimeout(_sttWarningTimer);
    _sttWarningTimer=setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>{toast.style.display='none';},300);},5000);
  }
  console.warn('[STT Warning]',msg);
}

// Strip Korean text from a string for TTS (keep display unchanged)
function stripKoreanForTTS(text){
  // Remove content inside parentheses that contains Korean: (한글...)
  let cleaned=text.replace(/\([^)]*[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F][^)]*\)/g,'');
  // Remove remaining standalone Korean characters/words
  cleaned=cleaned.replace(/[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F\u3200-\u32FF\uFFA0-\uFFDC]+/g,'');
  // Remove underscores/blanks (e.g., ___ in chant fill-in patterns) 
  cleaned=cleaned.replace(/_{2,}/g,'');
  // Clean up extra spaces and punctuation
  cleaned=cleaned.replace(/\s{2,}/g,' ').trim();
  return cleaned;
}

function speak(text, lang='en-US'){
  return new Promise((resolve)=>{
    if('speechSynthesis' in window){
      window.speechSynthesis.cancel();
      // If reading in English, strip Korean text so TTS only reads English
      let ttsText=(lang==='en-US'||lang==='en-GB'||lang.startsWith('en'))
        ? stripKoreanForTTS(text) : text;
      // Remove emojis (TTS reads them aloud as English words)
      ttsText=ttsText.replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{200D}\u{20E3}\u{E0020}-\u{E007F}]/gu,'').trim();
      if(!ttsText||!ttsText.trim()){resolve();return;}
      const u=new SpeechSynthesisUtterance(ttsText);
      u.lang=lang;
      if(bestVoice && lang.startsWith('en')) u.voice=bestVoice;
      u.rate=state.settings.ttsSpeed||0.85;
      u.pitch=1.0;
      let resolved=false;
      const done=()=>{if(!resolved){resolved=true;resolve();}};
      u.onend=done;
      u.onerror=done;
      // Safety timeout: Chrome Android sometimes never fires onend
      const safetyMs=Math.max(8000, ttsText.length*120);
      setTimeout(done, safetyMs);
      window.speechSynthesis.speak(u);
      // Chrome bug workaround: resume paused synthesis
      if(window.speechSynthesis.paused) window.speechSynthesis.resume();
    } else {resolve();}
  });
}

let recognition=null;
let recognitionResolve=null;

function initRecognition(lang='en-US'){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return null;
  recognition=new SR();
  recognition.lang=lang;
  recognition.continuous=false;
  recognition.interimResults=false;
  recognition.maxAlternatives=3;
  return recognition;
}

function listenForSpeech(lang='en-US',timeout=8000){
  return new Promise((resolve)=>{
    // Stop any ongoing TTS first to prevent conflicts
    if('speechSynthesis' in window){
      window.speechSynthesis.cancel();
    }

    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){
      // SpeechRecognition not supported — notify user
      if(location.protocol!=='https:' && location.hostname!=='localhost'){
        showSttWarning('⚠️ 음성 인식은 HTTPS 환경에서만 사용 가능합니다. 배포 후 다시 시도해주세요.');
      } else {
        showSttWarning('⚠️ 이 브라우저는 음성 인식을 지원하지 않습니다. Chrome 또는 Edge를 사용해주세요.');
      }
      resolve('');return;
    }

    let done=false;
    let bestResult='';
    let mainTimer=null;
    let restartCount=0;
    const MAX_RESTARTS=4;
    const startTime=Date.now();
    let currentRec=null;

    const finish=(result)=>{
      if(done) return;
      done=true;
      if(mainTimer) clearTimeout(mainTimer);
      try{if(currentRec){currentRec.onresult=null;currentRec.onerror=null;currentRec.onend=null;currentRec.abort();}}catch(e){}
      currentRec=null;
      resolve(result||'');
    };

    function startRec(){
      if(done) return;
      const elapsed=Date.now()-startTime;
      if(elapsed >= timeout-500){
        finish(bestResult);
        return;
      }
      try{
        const rec=new SR();
        currentRec=rec;
        rec.lang=lang;
        rec.continuous=false;
        rec.interimResults=false;
        rec.maxAlternatives=3;

        rec.onresult=(e)=>{
          if(done) return;
          try{
            const text=e.results[0][0].transcript;
            if(text && text.trim()){
              bestResult=text.trim();
              finish(bestResult);
            }
          }catch(err){}
        };

        rec.onerror=(e)=>{
          if(done) return;
          if(e.error==='not-allowed' || e.error==='service-not-allowed'){
            showSttWarning('🎤 마이크 권한이 거부되었습니다. 브라우저 설정에서 마이크 접근을 허용해주세요.');
            finish('');
            return;
          }
          if(e.error==='audio-capture'){
            showSttWarning('🎤 마이크를 찾을 수 없습니다. 마이크가 연결되어 있는지 확인해주세요.');
            finish('');
            return;
          }
          if(e.error==='network'){
            // Network error: retry once, then give up
            if(restartCount < 1){
              restartCount++;
              // don't show warning on first try, let retry attempt
            } else {
              showSttWarning('🌐 음성 인식 서버에 연결할 수 없습니다. 인터넷 연결을 확인하고 다시 시도해주세요.');
              finish('');
              return;
            }
          }
          // For 'no-speech', 'aborted' - let onend restart
        };

        rec.onend=()=>{
          if(done) return;
          if(bestResult){ finish(bestResult); return; }
          // Restart if time remains
          const el=Date.now()-startTime;
          if(el < timeout-800 && restartCount<MAX_RESTARTS){
            restartCount++;
            setTimeout(()=>startRec(), 250);
          }
          // Don't finish('') here - let mainTimer handle final timeout
        };

        rec.start();
      }catch(e){
        if(done) return;
        // Retry once after delay
        if(restartCount<MAX_RESTARTS){
          restartCount++;
          setTimeout(()=>startRec(), 400);
        } else {
          finish('');
        }
      }
    }

    // Main timeout - the ONLY place that resolves empty after full wait
    mainTimer=setTimeout(()=>{
      finish(bestResult);
    },timeout+500);

    // Start after brief delay for TTS cleanup
    setTimeout(()=>startRec(), 300);
  });
}

// ===== OPENAI API =====
async function callGPT(messages, maxTokens=300){
  if(!state.apiKey){
    return {error:true,message:'API 키가 설정되지 않았습니다. 설정에서 API 키를 입력해주세요.'};
  }
  try{
    const resp=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.apiKey},
      body:JSON.stringify({model:'gpt-4o-mini',messages,max_tokens:maxTokens,temperature:0.7})
    });
    if(!resp.ok){
      const err=await resp.json().catch(()=>({}));
      return {error:true,message:err.error?.message||'API 오류가 발생했습니다.'};
    }
    const data=await resp.json();
    return {error:false,content:data.choices[0].message.content};
  }catch(e){
    return {error:true,message:'네트워크 오류: '+e.message};
  }
}

function getSystemPrompt(){
  const lv=state.level;
  
  const base=`You are "Emma", a warm and friendly English tutor having a real conversation. You speak like a real person, not a textbook.

CRITICAL RULES:
1. NEVER use emojis in your spoken responses. No emojis at all. They get read aloud by TTS and sound terrible.
2. Use natural, conversational English. Say "Hey!" not "Hello! 😊". Say "Nice!" not "Great job! 🎉".
3. When the user makes a grammar or pronunciation mistake, use Echo Coaching: naturally rephrase what they said correctly in your response WITHOUT pointing out the error directly. Then casually say the correct version like "By the way, you can say: [correct sentence]" only if the error is significant.
4. Keep responses SHORT for voice conversation. 1-2 sentences max for beginners, 2-3 for advanced.
5. Sound like a real friend, not a teacher giving a lecture.
6. If the user speaks Korean, understand it, respond in English with a brief Korean translation in parentheses, then encourage them to try in English with a specific phrase to repeat.
7. Always ask a follow-up question to keep the conversation flowing naturally.
8. Use contractions naturally: "I'm", "you're", "that's", "don't" instead of formal forms.

ECHO COACHING EXAMPLES:
- User says "I go to school yesterday" -> You say: "Oh, you went to school yesterday? What did you do there?" (naturally using the correct past tense)
- User says "I am have a dog" -> You say: "You have a dog? That's cool! What's its name?"
- For significant errors, add: "By the way, a natural way to say that is: I went to school yesterday."

`;
  
  if(lv===0) return base+`The user is a complete beginner (Pre-A1). Use single words and very short phrases. Always add Korean translation in parentheses right after English: "Hi there! (안녕!) What's your name? (이름이 뭐예요?)". Speak slowly and simply. Max 15 words per response.`;
  if(lv===1) return base+`The user is at beginner level (A1). Use very simple sentences. Add Korean translation for key phrases: "That's great! (잘했어요!) Do you like music? (음악 좋아해요?)". Be extra encouraging. Max 20 words.`;
  if(lv===2) return base+`The user is at elementary level (A2). Use short, complete sentences. Only translate new or difficult words. Ask simple follow-up questions. Max 30 words.`;
  if(lv===3) return base+`The user is at intermediate level (B1). Have natural conversations. Only translate when they seem confused. Introduce useful expressions. Challenge them slightly. Max 50 words.`;
  if(lv===4) return base+`The user is at upper-intermediate level (B2). Discuss interesting topics naturally. Use sophisticated vocabulary. Provide subtle corrections. Max 60 words.`;
  return base+`The user is advanced (C1+). Have fluent, natural conversations. Use idioms and nuanced expressions. Only correct major errors. Discuss any topic deeply. Max 80 words.`;
}

// ===== ADAPTIVE DIFFICULTY =====
function trackAnswer(isCorrect){
  if(isCorrect){
    state.consecutiveCorrect++;
    state.consecutiveWrong=0;
    if(state.consecutiveCorrect>=3 && state.difficultyOffset<2){
      state.difficultyOffset++;
      state.consecutiveCorrect=0;
      showDifficultyNotice('up');
    }
  } else {
    state.consecutiveWrong++;
    state.consecutiveCorrect=0;
    if(state.consecutiveWrong>=2 && state.difficultyOffset>-2){
      state.difficultyOffset--;
      state.consecutiveWrong=0;
      showDifficultyNotice('down');
    }
  }
  saveState();
}

function showDifficultyNotice(dir){
  const msg=dir==='up'?'🔥 잘하고 있어요! 난이도를 올릴게요!':'💪 괜찮아요! 힌트를 더 줄게요!';
  const notice=document.createElement('div');
  notice.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background:'+(dir==='up'?'var(--success)':'var(--warning)')+';color:#fff;padding:12px 24px;border-radius:20px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.15);white-space:nowrap;';
  notice.textContent=msg;
  document.body.appendChild(notice);
  setTimeout(()=>{notice.style.opacity='0';notice.style.transition='opacity .5s';},2000);
  setTimeout(()=>notice.remove(),2500);
}

function shouldShowHint(){
  return (state.difficultyOffset||0)<=-1;
}

function getDifficultyLabel(){
  const d=state.difficultyOffset||0;
  if(d>=2) return '🔥 도전';
  if(d>=1) return '⬆️ 높음';
  if(d===0) return '➡️ 보통';
  if(d===-1) return '⬇️ 쉬움';
  return '🛗 기초';
}

// ===== SESSION FLOW =====
let sessionStep=0;
let sessionActivity='';
let sessionXp=0;
let sessionStartTime=0;

function startSession(){
  runGuidedSession();
}

// ===== GUIDED SESSION MODE =====
function runGuidedSession(){
  const view=document.getElementById('activityView');
  const body=document.getElementById('actViewBody');
  document.getElementById('actViewTitle').textContent='📚 오늘의 학습';
  document.getElementById('actViewScore').textContent='0 XP';
  view.classList.add('active');

  const ses={step:1,xpPerStep:{},wrongItems:[],totalXp:0,startTime:Date.now()};
  sessionXp=0;sessionStartTime=Date.now();sessionActivity='guided_session';

  const STEP_NAMES=['','워밍업','새 단어','패턴 연습','실전','리뷰','완료'];

  function progressHTML(step){
    return `<div class="session-progress"><div class="session-progress-bar" style="width:${Math.round((step/6)*100)}%"></div><span class="session-progress-label">${step}/6 ${STEP_NAMES[step]}</span></div>`;
  }

  function addStepXp(step,xp){
    ses.xpPerStep[step]=(ses.xpPerStep[step]||0)+xp;
    ses.totalXp+=xp;
    sessionXp=ses.totalXp;
    updateActivityScore();
  }

  // === STEP 1: WARMUP ===
  function runStep1(){
    ses.step=1;
    const lvl=Math.min(state.level,1);
    const tprItems=CONTENT.tpr[lvl]||CONTENT.tpr[0];
    if(!state.studyLog.length || tprItems.length<2){
      // No previous study, skip warmup
      runStep2();
      return;
    }
    const items=[...tprItems];
    shuffle(items);
    const qs=items.slice(0,2);
    let qi=0;

    function showWarmupQ(){
      if(qi>=qs.length){ runStep2(); return; }
      const q=qs[qi];
      body.innerHTML=progressHTML(1)+`
        <div class="session-step">
          <h3>🔄 워밍업</h3>
          <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">이전에 배운 내용을 복습해봐요!</p>
          <p style="font-size:16px;font-weight:600;margin-bottom:16px;">"${q.instruction}"</p>
          <button class="btn btn-sm btn-secondary" id="sesWarmPlayBtn">🔊 다시 듣기</button>
        </div>
        <div class="tpr-grid" style="max-width:300px;margin:16px auto;">
          ${q.options.map((o,i)=>`<div class="tpr-card" data-idx="${i}" style="font-size:40px;">${o}</div>`).join('')}
        </div>`;
      document.getElementById('sesWarmPlayBtn').addEventListener('click',()=>speak(q.audio));
      if(state.settings.autoTts) speak(q.audio);
      body.querySelectorAll('.tpr-card').forEach(card=>{
        card.addEventListener('click',()=>{
          const idx=parseInt(card.dataset.idx);
          body.querySelectorAll('.tpr-card').forEach(c=>c.style.pointerEvents='none');
          if(idx===q.answer){
            card.classList.add('correct');
            addStepXp(1,5);state.correctCount++;state.totalCount++;
            trackAnswer(true);
          } else {
            card.classList.add('wrong');
            body.querySelectorAll('.tpr-card')[q.answer].classList.add('correct');
            ses.wrongItems.push({type:'tpr',data:q});
            state.totalCount++;
            trackAnswer(false);
          }
          setTimeout(()=>{qi++;showWarmupQ();},800);
        });
      });
    }
    showWarmupQ();
  }

  // === STEP 2: NEW WORDS (Echo x3) ===
  function runStep2(){
    ses.step=2;
    const lvl=Math.min(state.level,2);
    const items=[...(CONTENT.echo[lvl]||CONTENT.echo[0])];
    shuffle(items);
    const words=items.slice(0,3);
    let wi=0;

    async function showEchoWord(){
      if(wi>=words.length){ runStep3(); return; }
      const w=words[wi];
      let tries=0;const MAX=3;let best=0;let xpGiven=false;

      body.innerHTML=progressHTML(2)+`
        <div style="text-align:center;padding-top:16px;">
          <h3>📝 새 단어 ${wi+1}/${words.length}</h3>
          <div class="echo-word">${w.word}</div>
          <div class="echo-sub">${state.settings.showKorean?w.korean:''}</div>
          <button class="btn btn-secondary btn-sm" id="sesEchoPlay">🔊 듣기</button>
          <div id="sesEchoArea" style="min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;"></div>
          <div id="sesEchoStatus" style="font-size:14px;color:var(--primary);font-weight:600;margin:8px 0;min-height:24px;"></div>
          <div class="echo-tries" id="sesEchoTries">시도 0/${MAX}</div>
        </div>`;

      document.getElementById('sesEchoPlay').addEventListener('click',()=>speak(w.word));

      async function startSesListen(){
        if(tries>=MAX) return;
        const statusEl=document.getElementById('sesEchoStatus');
        if(statusEl) statusEl.textContent='🔴 듣고 있어요... 따라 말해보세요!';

        const result=await listenForSpeech('en-US',6000);
        if(!document.getElementById('sesEchoArea')) return;
        if(statusEl) statusEl.textContent='';

        if(!result || !result.trim()){
          document.getElementById('sesEchoArea').innerHTML='<p style="font-size:14px;color:var(--warning);font-weight:600;">🎤 음성을 인식하지 못했어요.</p>';
          setTimeout(()=>{
            if(document.getElementById('sesEchoArea')){
              document.getElementById('sesEchoArea').innerHTML='';
              startSesListen();
            }
          },1500);
          return;
        }
        tries++;state.totalCount++;
        const score=getSimilarity(w.word,result);
        let cls,label,xp;
        if(score>=80){cls='perfect';label='Perfect! 🎉';xp=10;}
        else if(score>=50){cls='good';label='Good try!';xp=5;}
        else{cls='retry';label='천천히 따라해봐요';xp=3;}
        if(score>best) best=score;
        if(!xpGiven){addStepXp(2,xp);xpGiven=true;state.correctCount+=(score>=50?1:0);}
        if(score<50){ses.wrongItems.push({type:'echo',data:w});speak(w.word);}
        document.getElementById('sesEchoArea').innerHTML=`
          <div class="score-circle ${cls}">${score}%</div>
          <div class="echo-feedback" style="color:var(${cls==='perfect'?'--success':cls==='good'?'--warning':'--danger'});">${label}</div>
          <div class="echo-spoken">🗣️ "${result}"</div>
          <div class="echo-btn-row">
            ${tries<MAX?'<button class="btn btn-secondary btn-sm" id="sesRetry">🔄 다시</button>':''}
            <button class="btn btn-primary btn-sm" id="sesNext">다음 →</button>
          </div>`;
        document.getElementById('sesEchoTries').textContent=`시도 ${tries}/${MAX}`;
        const rb=document.getElementById('sesRetry');
        if(rb) rb.addEventListener('click',async()=>{
          document.getElementById('sesEchoArea').innerHTML='';
          await speak(w.word);
          startSesListen();
        });
        document.getElementById('sesNext').addEventListener('click',()=>{wi++;showEchoWord();});
        if(tries>=MAX) setTimeout(()=>{wi++;showEchoWord();},2000);
      }

      // Auto-flow: play word → auto-listen
      if(state.settings.autoTts) await speak(w.word);
      startSesListen();
    }
    showEchoWord();
  }

  // === STEP 3: CHANT ===
  function runStep3(){
    ses.step=3;
    const lvl=Math.min(state.level,2);
    const chants=CONTENT.chant[lvl]||CONTENT.chant[1];
    if(!chants||chants.length===0){ runStep4(); return; }
    if(state.level===0){ runStep4(); return; } // Lv.0 has no chant
    const chant=chants[Math.floor(Math.random()*chants.length)];

    body.innerHTML=progressHTML(3)+`
      <div style="text-align:center;padding:16px;max-width:420px;margin:0 auto;">
        <h3>🎵 패턴 연습</h3>
        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 20px;">${state.settings.showKorean?chant.korean:''}</p>
        <div id="sesChantLines">${chant.lines.map((l,i)=>`<div class="chant-line" data-idx="${i}">${l}</div>`).join('')}</div>
        <button class="btn btn-primary" id="sesChantPlay" style="margin-top:20px;">▶️ 챈트 시작</button>
        <button class="btn btn-secondary btn-sm" id="sesChantSkip" style="margin-top:8px;">다음 단계로 →</button>
      </div>`;

    document.getElementById('sesChantPlay').addEventListener('click',async()=>{
      const lines=document.querySelectorAll('#sesChantLines .chant-line');
      for(let i=0;i<lines.length;i++){
        lines.forEach(l=>l.classList.remove('highlight'));
        lines[i].classList.add('highlight');
        await speak(chant.lines[i]);
        await new Promise(r=>setTimeout(r,300));
      }
      lines.forEach(l=>l.classList.remove('highlight'));
      addStepXp(3,10);
      setTimeout(()=>runStep4(),500);
    });
    document.getElementById('sesChantSkip').addEventListener('click',()=>runStep4());
  }

  // === STEP 4: PRACTICE ===
  function runStep4(){
    ses.step=4;
    if(state.level>=2 && state.apiKey){
      runStep4RolePlay();
    } else {
      runStep4TPR();
    }
  }

  function runStep4TPR(){
    const lvl=Math.min(state.level,1);
    const items=[...(CONTENT.tpr[lvl]||CONTENT.tpr[0])];
    shuffle(items);
    const qs=items.slice(0,3);
    let qi=0;

    function showQ(){
      if(qi>=qs.length){ runStep5(); return; }
      const q=qs[qi];
      body.innerHTML=progressHTML(4)+`
        <div class="session-step">
          <h3>🎯 실전 연습 ${qi+1}/${qs.length}</h3>
          <p style="font-size:16px;font-weight:600;margin:12px 0;">"${q.instruction}"</p>
          <button class="btn btn-sm btn-secondary" id="sesTPRPlay">🔊 다시 듣기</button>
        </div>
        <div class="tpr-grid" style="max-width:320px;margin:16px auto;">
          ${q.options.map((o,i)=>`<div class="tpr-card" data-idx="${i}" style="font-size:44px;">${o}</div>`).join('')}
        </div>`;
      document.getElementById('sesTPRPlay').addEventListener('click',()=>speak(q.audio));
      if(state.settings.autoTts) speak(q.audio);
      body.querySelectorAll('.tpr-card').forEach(card=>{
        card.addEventListener('click',()=>{
          const idx=parseInt(card.dataset.idx);
          body.querySelectorAll('.tpr-card').forEach(c=>c.style.pointerEvents='none');
          if(idx===q.answer){
            card.classList.add('correct');
            addStepXp(4,5);state.correctCount++;state.totalCount++;
            trackAnswer(true);
          } else {
            card.classList.add('wrong');
            body.querySelectorAll('.tpr-card')[q.answer].classList.add('correct');
            ses.wrongItems.push({type:'tpr',data:q});
            state.totalCount++;
            trackAnswer(false);
          }
          setTimeout(()=>{qi++;showQ();},800);
        });
      });
    }
    showQ();
  }

  function runStep4RolePlay(){
    const items=CONTENT.roleplay[Math.min(state.level,2)]||CONTENT.roleplay[2];
    const rp=items[Math.floor(Math.random()*items.length)];
    const messages=[{role:'system',content:getSystemPrompt()+`\n\nRole-play scenario. You are a ${rp.aiRole}. User is a ${rp.userRole}. Scenario: ${rp.scenario}. Keep responses short (1-3 sentences).`}];
    let rpTurns=0;

    body.innerHTML=progressHTML(4)+`
      <div style="width:100%;max-width:420px;padding:0 16px;">
        <div class="rp-scenario">
          <div class="rp-emoji">${rp.emoji}</div>
          <h4>${rp.scenario}</h4>
          <p>AI: ${rp.aiRole} | 나: ${rp.userRole}</p>
        </div>
        <div class="chat-messages" id="sesRPChat" style="max-height:35vh;"></div>
        <div style="margin:8px 0;"><p style="font-size:11px;color:var(--text-secondary);">💡 ${rp.hints.join(' / ')}</p></div>
        <div class="chat-input-row">
          <input type="text" id="sesRPInput" placeholder="영어로 대답하세요...">
          <button id="sesRPMic">🎤</button>
          <button id="sesRPSend">📤</button>
        </div>
        <button class="btn btn-secondary btn-sm btn-full" id="sesRPDone" style="margin-top:8px;">대화 완료 → 다음 단계</button>
      </div>`;

    function addMsg(role,text){
      const chat=document.getElementById('sesRPChat');
      if(!chat) return;
      const d=document.createElement('div');
      d.className='chat-msg '+role;
      d.textContent=text;
      chat.appendChild(d);
      chat.scrollTop=chat.scrollHeight;
    }

    addMsg('ai',rp.opening);
    if(state.settings.autoTts) speak(rp.opening);
    messages.push({role:'assistant',content:rp.opening});
    addStepXp(4,5);

    async function sendRP(text){
      if(!text.trim()) return;
      addMsg('user',text);
      messages.push({role:'user',content:text});
      rpTurns++;
      const result=await callGPT(messages,150);
      if(!result.error){
        messages.push({role:'assistant',content:result.content});
        addMsg('ai',result.content);
        if(state.settings.autoTts) speak(result.content);
        addStepXp(4,5);
      } else {
        addMsg('ai','(오류: '+result.message+')');
      }
    }

    document.getElementById('sesRPSend').addEventListener('click',()=>{
      const inp=document.getElementById('sesRPInput');
      sendRP(inp.value);inp.value='';
    });
    document.getElementById('sesRPInput').addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){const inp=document.getElementById('sesRPInput');sendRP(inp.value);inp.value='';}
    });
    document.getElementById('sesRPMic').addEventListener('click',async()=>{
      const btn=document.getElementById('sesRPMic');
      btn.textContent='🔴';
      const text=await listenForSpeech('en-US',8000);
      btn.textContent='🎤';
      if(text){document.getElementById('sesRPInput').value=text;sendRP(text);document.getElementById('sesRPInput').value='';}
    });
    document.getElementById('sesRPDone').addEventListener('click',()=>runStep5());
  }

  // === STEP 5: REVIEW ===
  function runStep5(){
    ses.step=5;
    const wrongs=ses.wrongItems;
    if(wrongs.length===0){
      body.innerHTML=progressHTML(5)+`
        <div class="session-step">
          <div style="font-size:64px;margin-bottom:16px;">🌟</div>
          <h3>완벽해요!</h3>
          <p>틀린 문제가 없어요. 대단합니다!</p>
          <button class="btn btn-primary" style="margin-top:20px;" onclick="">다음 →</button>
        </div>`;
      body.querySelector('.btn-primary').addEventListener('click',()=>runStep6());
      addStepXp(5,5);
      return;
    }

    let ri=0;
    function showReview(){
      if(ri>=wrongs.length){ runStep6(); return; }
      const item=wrongs[ri];
      if(item.type==='tpr'){
        const q=item.data;
        body.innerHTML=progressHTML(5)+`
          <div class="session-step">
            <h3>🔄 리뷰 ${ri+1}/${wrongs.length}</h3>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">틀렸던 문제를 다시 풀어봐요!</p>
            <p style="font-size:16px;font-weight:600;margin-bottom:12px;">"${q.instruction}"</p>
            <button class="btn btn-sm btn-secondary" id="sesRevPlay">🔊 듣기</button>
          </div>
          <div class="tpr-grid" style="max-width:300px;margin:16px auto;">
            ${q.options.map((o,i)=>`<div class="tpr-card" data-idx="${i}" style="font-size:40px;">${o}</div>`).join('')}
          </div>`;
        document.getElementById('sesRevPlay').addEventListener('click',()=>speak(q.audio));
        if(state.settings.autoTts) speak(q.audio);
        body.querySelectorAll('.tpr-card').forEach(card=>{
          card.addEventListener('click',()=>{
            const idx=parseInt(card.dataset.idx);
            body.querySelectorAll('.tpr-card').forEach(c=>c.style.pointerEvents='none');
            if(idx===q.answer){card.classList.add('correct');addStepXp(5,3);}
            else{card.classList.add('wrong');body.querySelectorAll('.tpr-card')[q.answer].classList.add('correct');}
            setTimeout(()=>{ri++;showReview();},800);
          });
        });
      } else if(item.type==='echo'){
        const w=item.data;
        body.innerHTML=progressHTML(5)+`
          <div style="text-align:center;padding:16px;">
            <h3>🔄 리뷰 ${ri+1}/${wrongs.length}</h3>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">다시 따라해봐요!</p>
            <div class="echo-word">${w.word}</div>
            <div class="echo-sub">${state.settings.showKorean?w.korean:''}</div>
            <button class="btn btn-secondary btn-sm" id="sesRevEchoPlay">🔊 듣기</button>
            <div id="sesRevResult" style="min-height:60px;margin:12px 0;"></div>
            <button class="btn btn-primary" id="sesRevEchoRec">🎤 따라 말하기</button>
            <button class="btn btn-secondary btn-sm" id="sesRevSkip" style="margin-top:8px;">다음 →</button>
          </div>`;
        document.getElementById('sesRevEchoPlay').addEventListener('click',()=>speak(w.word));
        if(state.settings.autoTts) speak(w.word);
        document.getElementById('sesRevEchoRec').addEventListener('click',async()=>{
          const btn=document.getElementById('sesRevEchoRec');
          btn.textContent='🎤 듣고 있어요...';btn.disabled=true;
          const result=await listenForSpeech('en-US',5000);
          if(result){
            const score=getSimilarity(w.word,result);
            const cls=score>=80?'perfect':score>=50?'good':'retry';
            document.getElementById('sesRevResult').innerHTML=`<div class="score-circle ${cls}" style="width:80px;height:80px;font-size:20px;">${score}%</div>`;
            if(score>=50) addStepXp(5,3);
          }
          btn.textContent='🎤 다시 시도';btn.disabled=false;
        });
        document.getElementById('sesRevSkip').addEventListener('click',()=>{ri++;showReview();});
      } else {
        ri++;showReview();
      }
    }
    showReview();
  }

  // === STEP 6: COMPLETE ===
  function runStep6(){
    ses.step=6;
    const bonus=50;
    ses.xpPerStep['bonus']=bonus;
    ses.totalXp+=bonus;
    sessionXp=ses.totalXp;
    updateActivityScore();

    const elapsed=Date.now()-ses.startTime;
    state.studyTimeMs+=elapsed;
    state.sessionsCompleted=(state.sessionsCompleted||0)+1;

    body.innerHTML=progressHTML(6)+`
      <div style="text-align:center;padding:24px 16px;max-width:400px;margin:0 auto;">
        <div style="font-size:72px;margin-bottom:12px;">✅</div>
        <h3 style="font-size:22px;font-weight:800;">오늘의 학습 완료!</h3>
        <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 20px;">세션 #${state.sessionsCompleted}</p>
        <div style="background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);text-align:left;">
          ${ses.xpPerStep[1]?`<div class="session-summary-row"><span class="s-label">🔄 워밍업</span><span class="s-xp">+${ses.xpPerStep[1]} XP</span></div>`:''}
          ${ses.xpPerStep[2]?`<div class="session-summary-row"><span class="s-label">📝 새 단어</span><span class="s-xp">+${ses.xpPerStep[2]} XP</span></div>`:''}
          ${ses.xpPerStep[3]?`<div class="session-summary-row"><span class="s-label">🎵 패턴 연습</span><span class="s-xp">+${ses.xpPerStep[3]} XP</span></div>`:''}
          ${ses.xpPerStep[4]?`<div class="session-summary-row"><span class="s-label">🎯 실전</span><span class="s-xp">+${ses.xpPerStep[4]} XP</span></div>`:''}
          ${ses.xpPerStep[5]?`<div class="session-summary-row"><span class="s-label">🔄 리뷰</span><span class="s-xp">+${ses.xpPerStep[5]} XP</span></div>`:''}
          <div class="session-summary-row bonus"><span class="s-label">🎁 완료 보너스</span><span class="s-xp">+${bonus} XP</span></div>
        </div>
        <div class="session-total">총 ${ses.totalXp} XP</div>
        <button class="btn btn-primary btn-full" id="sesFinishBtn">홈으로 돌아가기</button>
      </div>`;

    document.getElementById('sesFinishBtn').addEventListener('click',()=>{
      document.getElementById('activityView').classList.remove('active');
      window.speechSynthesis.cancel();
      addXp(ses.totalXp,'오늘의 학습');
    });
  }

  // Start!
  runStep1();
}

function startActivity(id){
  sessionActivity=id;
  sessionXp=0;
  sessionStartTime=Date.now();
  state.activityCounts[id]=(state.activityCounts[id]||0)+1;

  const view=document.getElementById('activityView');
  const act=ACTIVITIES.find(a=>a.id===id);
  document.getElementById('actViewTitle').textContent=act.emoji+' '+act.name;
  document.getElementById('actViewScore').textContent='0 XP';
  view.classList.add('active');

  switch(id){
    case 'tpr': runTPR(); break;
    case 'echo': runEcho(); break;
    case 'chant': runChant(); break;
    case 'story': runStory(); break;
    case 'roleplay': runRolePlay(); break;
    case 'freetalk': runFreeTalkActivity(); break;
    case 'minilesson': runMiniLesson(); break;
    case 'mission': runMission(); break;
  }
}

function closeActivity(){
  document.getElementById('activityView').classList.remove('active');
  window.speechSynthesis.cancel();
  if(sessionXp>0){
    const elapsed=Date.now()-sessionStartTime;
    state.studyTimeMs+=elapsed;
    markTopicComplete(sessionActivity);
    // Track daily sessions for achievements
    const todayStr=new Date().toDateString();
    if(state.dailySessionDate!==todayStr){state.dailySessions=0;state.dailySessionDate=todayStr;}
    state.dailySessions=(state.dailySessions||0)+1;
    saveState();
    addXp(sessionXp,ACTIVITIES.find(a=>a.id===sessionActivity)?.name||sessionActivity);
  }
}

function updateActivityScore(){
  document.getElementById('actViewScore').textContent=sessionXp+' XP';
}

// ===== TPR (Listen & Act) =====
async function runTPR(){
  const body=document.getElementById('actViewBody');
  const lvl=Math.min(state.level, 2);
  const items=[...(CONTENT.tpr[lvl]||CONTENT.tpr[0])];
  shuffle(items);
  const questions=items.slice(0,5);
  let qIdx=0;
  let correct=0;

  async function showQ(){
    if(qIdx>=questions.length){
      // Done
      body.innerHTML=`
        <div class="session-step">
          <div style="font-size:64px;margin-bottom:16px;">🎉</div>
          <h3>완료!</h3>
          <p>${correct}/${questions.length} 정답</p>
          <button class="btn btn-primary" style="margin-top:20px;" onclick="closeActivity()">돌아가기</button>
        </div>`;
      return;
    }
    const q=questions[qIdx];
    body.innerHTML=`
      <div class="session-step">
        <p style="font-size:13px;color:var(--text-secondary);">${qIdx+1} / ${questions.length}</p>
        <h3 style="font-size:18px;margin:12px 0;">"${q.instruction}"</h3>
        <button class="btn btn-sm btn-secondary" id="tprPlayBtn">🔊 다시 듣기</button>
      </div>
      <div class="tpr-grid" id="tprGrid">
        ${q.options.map((o,i)=>`<div class="tpr-card" data-idx="${i}"${shouldShowHint()&&i===q.answer?' style="border:2px dashed #10B981;"':''}>${o}</div>`).join('')}
      </div>`;

    document.getElementById('tprPlayBtn').addEventListener('click',()=>speak(q.audio));
    if(state.settings.autoTts) await speak(q.audio);

    body.querySelectorAll('.tpr-card').forEach(card=>{
      card.addEventListener('click',async()=>{
        const idx=parseInt(card.dataset.idx);
        body.querySelectorAll('.tpr-card').forEach(c=>c.style.pointerEvents='none');
        if(idx===q.answer){
          card.classList.add('correct');
          correct++;
          state.correctCount++;
          sessionXp+=5;
          updateActivityScore();
          trackAnswer(true);
          addSkillScore('listening',2);
        } else {
          card.classList.add('wrong');
          body.querySelectorAll('.tpr-card')[q.answer].classList.add('correct');
          trackAnswer(false);
          addToReview('tpr', q);
        }
        state.totalCount++;
        await new Promise(r=>setTimeout(r,800));
        qIdx++;
        showQ();
      });
    });
  }
  showQ();
}

// ===== ECHO =====
async function runEcho(){
  const body=document.getElementById('actViewBody');
  let words;

  if(state.level >= 3 && state.apiKey){
    // AI dynamic content for Lv.3+
    body.innerHTML='<div class="session-step"><div style="font-size:48px;margin-bottom:16px;">⏳</div><h3>AI가 문장을 만들고 있어요...</h3></div>';
    const lvLabel=LEVELS[state.level].label;
    const aiResult=await callGPT([{role:'system',content:`Generate 6 English sentences for ${lvLabel} speaking practice. Return ONLY a JSON array: [{"word":"full sentence","korean":"한국어 번역"}]. Level guide: B1=everyday topics with compound sentences, B2=abstract topics with complex grammar, C1+=idiomatic expressions and professional language. No markdown, no code fences, just the JSON array.`}],500);
    if(!aiResult.error){
      try{
        const parsed=JSON.parse(aiResult.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim());
        if(Array.isArray(parsed)&&parsed.length>0) words=parsed;
      }catch(e){console.error('Echo AI parse error',e);}
    }
    if(!words){
      // Fallback to hardcoded content
      const items=[...(CONTENT.echo[2]||CONTENT.echo[0])];
      shuffle(items);
      words=items.slice(0,6);
    }
  } else {
    const lvl=Math.min(state.level, 2);
    const items=[...(CONTENT.echo[lvl]||CONTENT.echo[0])];
    shuffle(items);
    words=items.slice(0,6);
  }

  let wIdx=0;
  let correct=0;
  const MAX_TRIES=3;

  async function showWord(){
    if(wIdx>=words.length){
      body.innerHTML=`
        <div class="session-step">
          <div style="font-size:64px;margin-bottom:16px;">🎉</div>
          <h3>에코 완료!</h3>
          <p>${correct}/${words.length} 성공</p>
          <button class="btn btn-primary" style="margin-top:20px;" onclick="closeActivity()">돌아가기</button>
        </div>`;
      return;
    }
    const w=words[wIdx];
    let tries=0;
    let bestScore=0;
    let bestXpAwarded=false;

    body.innerHTML=`
      <div style="text-align:center;width:100%;padding-top:24px;">
        <p style="font-size:13px;color:var(--text-secondary);">${wIdx+1} / ${words.length}</p>
        <div class="echo-word">${w.word}</div>
        <div class="echo-sub">${(state.settings.showKorean||shouldShowHint())?w.korean:''}</div>
        <button class="btn btn-secondary btn-sm" id="echoPlayBtn">🔊 듣기</button>
        <div id="echoScoreArea" style="min-height:200px;display:flex;flex-direction:column;align-items:center;justify-content:center;"></div>
        <div id="echoListenStatus" style="font-size:14px;color:var(--primary);font-weight:600;margin:8px 0;min-height:24px;"></div>
        <div class="echo-tries" id="echoTriesLabel">시도 0 / ${MAX_TRIES}</div>
      </div>`;

    document.getElementById('echoPlayBtn').addEventListener('click',()=>speak(w.word));

    async function startListening(){
      if(tries>=MAX_TRIES) return;
      const statusEl=document.getElementById('echoListenStatus');
      if(statusEl) statusEl.textContent='🔴 듣고 있어요... 따라 말해보세요!';

      const result=await listenForSpeech('en-US',6000);

      // Check if the DOM is still valid (user might have navigated away)
      if(!document.getElementById('echoScoreArea')) return;

      if(statusEl) statusEl.textContent='';
      state.totalCount++;
      tries++;

      if(result && result.trim().length>0){
        const score=getSimilarity(w.word, result);
        renderScore(score, result);
      } else {
        tries--; // don't count failed recognition
        state.totalCount--;
        document.getElementById('echoScoreArea').innerHTML='<p style="font-size:14px;color:var(--warning);margin:8px 0;font-weight:600;">🎤 음성을 인식하지 못했어요.</p>';
        document.getElementById('echoTriesLabel').textContent=`시도 ${tries} / ${MAX_TRIES}`;
        // Auto-retry listening after a brief pause
        setTimeout(()=>{
          if(document.getElementById('echoScoreArea')){
            document.getElementById('echoScoreArea').innerHTML='';
            startListening();
          }
        },1500);
      }
    }

    function renderScore(score, spoken){
      const area=document.getElementById('echoScoreArea');
      if(!area) return;
      let cls,label,xpGain;
      if(score>=80){ cls='perfect'; label='Perfect! 🎉'; xpGain=10; }
      else if(score>=50){ cls='good'; label='Good try! 다시 한번!'; xpGain=5; }
      else { cls='retry'; label='천천히 따라해봐요'; xpGain=3; }

      area.innerHTML=`
        <div class="score-circle ${cls}">${score}%</div>
        <div class="echo-feedback" style="color:var(${cls==='perfect'?'--success':cls==='good'?'--warning':'--danger'});">${label}</div>
        <div class="echo-spoken">🗣️ "${spoken}"</div>
        <div class="echo-tries">최고 점수: ${bestScore}% · 시도 ${tries}/${MAX_TRIES}</div>
        <div class="echo-btn-row">
          ${tries<MAX_TRIES?'<button class="btn btn-secondary btn-sm" id="echoRetryBtn">🔄 다시 시도</button>':''}
          <button class="btn btn-primary btn-sm" id="echoNextBtn">다음으로 →</button>
        </div>`;

      const statusEl=document.getElementById('echoListenStatus');
      if(statusEl) statusEl.textContent='';

      // Award XP only for best attempt
      if(!bestXpAwarded || score>bestScore){
        if(bestXpAwarded){
          const oldXp=bestScore>=80?10:bestScore>=50?5:3;
          sessionXp-=oldXp;
        }
        sessionXp+=xpGain;
        bestXpAwarded=true;
        updateActivityScore();
      }
      if(score>bestScore) bestScore=score;

      if(score>=80){ correct++; state.correctCount++; trackAnswer(true); addSkillScore('speaking',3); if(score>=95){state.perfectEchoCount=(state.perfectEchoCount||0)+1;saveState();} }
      else if(score>=50){ addSkillScore('speaking',1); }
      else if(score<50){ trackAnswer(false); addToReview('echo', w); }

      if(score<50){ speak(w.word); }

      const retryBtn=document.getElementById('echoRetryBtn');
      if(retryBtn){
        retryBtn.addEventListener('click',async()=>{
          area.innerHTML='';
          // Play the word first, then auto-listen
          await speak(w.word);
          startListening();
        });
      }
      const nextBtn=document.getElementById('echoNextBtn');
      if(nextBtn){
        nextBtn.addEventListener('click',()=>{ wIdx++; showWord(); });
      }

      // Auto-advance after max tries
      if(tries>=MAX_TRIES){
        setTimeout(()=>{ wIdx++; showWord(); },2000);
      }

      document.getElementById('echoTriesLabel').textContent=`시도 ${tries} / ${MAX_TRIES}`;
    }

    // Auto-flow: play word → auto-listen
    if(state.settings.autoTts){
      await speak(w.word);
    }
    startListening();
  }
  showWord();
}

// ===== CHANT =====
async function runChant(){
  const body=document.getElementById('actViewBody');
  const lvl=Math.min(state.level,2);
  const items=CONTENT.chant[lvl]||CONTENT.chant[1];
  const chant=items[Math.floor(Math.random()*items.length)];

  body.innerHTML=`
    <div style="text-align:center;width:100%;max-width:420px;padding-top:24px;">
      <h3 style="font-size:18px;font-weight:700;">🎵 Chant</h3>
      <p style="font-size:13px;color:var(--text-secondary);margin:8px 0 24px;">${state.settings.showKorean?chant.korean:''}</p>
      <div id="chantLines">${chant.lines.map((l,i)=>`<div class="chant-line" data-idx="${i}">${l}</div>`).join('')}</div>
      <button class="btn btn-primary" id="chantPlayBtn" style="margin-top:24px;">▶️ 챈트 시작</button>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="sessionXp+=10;closeActivity();">완료 →</button>
    </div>`;

  document.getElementById('chantPlayBtn').addEventListener('click',async()=>{
    const lines=document.querySelectorAll('.chant-line');
    for(let i=0;i<lines.length;i++){
      lines.forEach(l=>l.classList.remove('highlight'));
      lines[i].classList.add('highlight');
      await speak(chant.lines[i]);
      await new Promise(r=>setTimeout(r,300));
    }
    lines.forEach(l=>l.classList.remove('highlight'));
    sessionXp+=10;
    updateActivityScore();
  });
}

// ===== STORY =====
async function runStory(){
  const body=document.getElementById('actViewBody');
  let story;

  if(state.level >= 3 && state.apiKey){
    // AI dynamic story for Lv.3+
    body.innerHTML='<div class="session-step"><div style="font-size:48px;margin-bottom:16px;">⏳</div><h3>AI가 이야기를 만들고 있어요...</h3></div>';
    const lvLabel=LEVELS[state.level].label;
    const wordGuide=state.level===3?'200-400 words':state.level===4?'400-600 words':'600+ words';
    const aiResult=await callGPT([{role:'system',content:`Create an English reading story for ${lvLabel} level. Return ONLY JSON (no markdown, no code fences): {"title":"...","story":"...(${wordGuide})","korean":"한국어 번역","questions":[{"q":"...","options":["...","...","..."],"answer":0},{"q":"...","options":["...","...","..."],"answer":0},{"q":"...","options":["...","...","..."],"answer":0}]} Include 3 comprehension questions. "answer" is the 0-based index of the correct option.`}],1500);
    if(!aiResult.error){
      try{
        const parsed=JSON.parse(aiResult.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim());
        if(parsed.title && parsed.story && parsed.questions) story=parsed;
      }catch(e){console.error('Story AI parse error',e);}
    }
    if(!story){
      const items=CONTENT.story[2]||CONTENT.story[1];
      story=items[Math.floor(Math.random()*items.length)];
    }
  } else {
    const lvl=Math.min(state.level,2);
    const items=CONTENT.story[lvl]||CONTENT.story[1];
    story=items[Math.floor(Math.random()*items.length)];
  }

  let qIdx=0;
  let correct=0;

  body.innerHTML=`
    <div style="text-align:center;width:100%;max-width:420px;padding:24px 0;">
      <h3 style="font-size:18px;font-weight:700;">📖 ${story.title}</h3>
      <div style="background:#F8FAFC;border-radius:12px;padding:16px;margin:16px 0;text-align:left;line-height:1.8;font-size:15px;">
        ${story.story}
      </div>
      ${state.settings.showKorean?`<div style="background:#EEF2FF;border-radius:12px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--text-secondary);text-align:left;">${story.korean}</div>`:''}
      <button class="btn btn-secondary btn-sm" id="storyListenBtn">🔊 이야기 듣기</button>
      <div id="storyQuestions" style="margin-top:24px;"></div>
    </div>`;

  document.getElementById('storyListenBtn').addEventListener('click',()=>speak(story.story));
  if(state.settings.autoTts) speak(story.story);

  setTimeout(()=>{
    showStoryQ();
  },2000);

  function showStoryQ(){
    if(qIdx>=story.questions.length){
      if(correct===story.questions.length){if(!state.achievements)state.achievements={unlocked:[],progress:{},dates:{}};state.achievements.progress.ach_storyteller=(state.achievements.progress.ach_storyteller||0)+1;saveState();}
      document.getElementById('storyQuestions').innerHTML=`
        <div style="padding:16px;text-align:center;">
          <h3>🎉 완료! ${correct}/${story.questions.length} 정답</h3>
          <button class="btn btn-primary" style="margin-top:12px;" onclick="closeActivity()">돌아가기</button>
        </div>`;
      return;
    }
    const q=story.questions[qIdx];
    document.getElementById('storyQuestions').innerHTML=`
      <div class="diag-question">
        <div class="q-text" style="font-size:15px;">${q.q}</div>
      </div>
      <div class="diag-options">
        ${q.options.map((o,i)=>`<button class="diag-option" data-idx="${i}">${o}</button>`).join('')}
      </div>`;
    
    document.querySelectorAll('#storyQuestions .diag-option').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=parseInt(btn.dataset.idx);
        document.querySelectorAll('#storyQuestions .diag-option').forEach(b=>b.style.pointerEvents='none');
        if(idx===q.answer){
          btn.classList.add('correct');
          correct++;state.correctCount++;
          sessionXp+=5;updateActivityScore();
          trackAnswer(true);
          addSkillScore('listening',2);
          addSkillScore('vocabulary',1);
        } else {
          btn.classList.add('wrong');
          document.querySelectorAll('#storyQuestions .diag-option')[q.answer].classList.add('correct');
          trackAnswer(false);
        }
        state.totalCount++;
        setTimeout(()=>{qIdx++;showStoryQ();},800);
      });
    });
  }
}

// ===== ROLE PLAY =====
async function runRolePlay(){
  const body=document.getElementById('actViewBody');
  
  if(state.level<2){
    // Use GPT for lower levels too with simple scenarios
    body.innerHTML=`<div class="session-step"><h3>레벨 2부터 이용 가능합니다</h3><button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button></div>`;
    return;
  }

  let rp;

  if(state.level >= 3 && state.apiKey){
    // AI dynamic scenario for Lv.3+
    body.innerHTML='<div class="session-step"><div style="font-size:48px;margin-bottom:16px;">⏳</div><h3>AI가 시나리오를 준비하고 있어요...</h3></div>';
    const lvLabel=LEVELS[state.level].label;
    const scenarioGuide=state.level===3?'daily life situations like shopping, making appointments, visiting a doctor':state.level===4?'business meetings, travel situations, polite debates, job interviews':'professional negotiations, academic discussions, diplomatic conversations, complex problem-solving';
    const aiResult=await callGPT([{role:'system',content:`Create a role-play scenario for ${lvLabel} English practice. Return ONLY JSON (no markdown, no code fences): {"scenario":"시나리오 이름 (Korean)","emoji":"single emoji","aiRole":"AI역할 (Korean)","userRole":"사용자역할 (Korean)","opening":"AI's opening line in English (1-2 sentences)","korean":"opening의 한국어 번역","hints":["hint phrase 1","hint phrase 2","hint phrase 3"]} Topic ideas: ${scenarioGuide}.`}],400);
    if(!aiResult.error){
      try{
        const parsed=JSON.parse(aiResult.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim());
        if(parsed.scenario && parsed.opening && parsed.hints) rp=parsed;
      }catch(e){console.error('RolePlay AI parse error',e);}
    }
    if(!rp){
      const items=CONTENT.roleplay[2];
      rp=items[Math.floor(Math.random()*items.length)];
    }
  } else {
    const items=CONTENT.roleplay[Math.min(state.level,2)]||CONTENT.roleplay[2];
    rp=items[Math.floor(Math.random()*items.length)];
  }

  const messages=[{role:'system',content:getSystemPrompt()+`\n\nYou are playing a role-play scenario. You are a ${rp.aiRole}. The user is a ${rp.userRole}. Scenario: ${rp.scenario}. Start with your opening line and continue the conversation naturally. Keep responses short (1-3 sentences).`}];

  body.innerHTML=`
    <div style="width:100%;max-width:420px;">
      <div class="rp-scenario">
        <div class="rp-emoji">${rp.emoji}</div>
        <h4>${rp.scenario}</h4>
        <p>AI: ${rp.aiRole} | 나: ${rp.userRole}</p>
      </div>
      <div class="chat-messages" id="rpChat" style="max-height:40vh;"></div>
      <div style="margin:12px 0;">
        <p style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">💡 힌트: ${rp.hints.join(' / ')}</p>
      </div>
      <div class="chat-input-row">
        <input type="text" id="rpInput" placeholder="영어로 대답하세요...">
        <button id="rpMicBtn" onclick="rpMicInput()">🎤</button>
        <button onclick="rpSendText()">📤</button>
      </div>
      <button class="btn btn-secondary btn-sm btn-full" style="margin-top:8px;" onclick="sessionXp+=10;closeActivity();">대화 종료</button>
    </div>`;

  // Show opening
  addRpMsg('ai',rp.opening,rp.korean);
  if(state.settings.autoTts) speak(rp.opening);
  messages.push({role:'assistant',content:rp.opening});
  sessionXp+=5;updateActivityScore();

  window._rpMessages=messages;
  window._rpSendFn=async function(text){
    if(!text.trim()) return;
    addRpMsg('user',text);
    messages.push({role:'user',content:text});
    const result=await callGPT(messages,150);
    if(result.error){
      addRpMsg('ai','(Error: '+result.message+')');
    } else {
      messages.push({role:'assistant',content:result.content});
      addRpMsg('ai',result.content);
      if(state.settings.autoTts) speak(result.content);
      sessionXp+=5;updateActivityScore();
    }
  };
}

function addRpMsg(role,text,korean){
  const chat=document.getElementById('rpChat');
  if(!chat) return;
  const d=document.createElement('div');
  d.className='chat-msg '+role;
  const safe=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const styled=role==='ai'?safe.replace(/(\([^)]*[\uAC00-\uD7AF][^)]*\))/g,'<span class="ko">$1</span>'):safe;
  d.innerHTML=styled+(korean&&state.settings.showKorean?`<span class="ko">${korean}</span>`:'');
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function rpSendText(){
  const input=document.getElementById('rpInput');
  if(input&&window._rpSendFn){window._rpSendFn(input.value);input.value='';}
}

async function rpMicInput(){
  const btn=document.getElementById('rpMicBtn');
  if(btn) btn.textContent='🔴';
  const text=await listenForSpeech('en-US',8000);
  if(btn) btn.textContent='🎤';
  if(text&&window._rpSendFn){
    document.getElementById('rpInput').value=text;
    window._rpSendFn(text);
    document.getElementById('rpInput').value='';
  }
}

// ===== FREE TALK ACTIVITY (Full screen) =====
async function runFreeTalkActivity(){
  const body=document.getElementById('actViewBody');
  const messages=[{role:'system',content:getSystemPrompt()+'\n\nStart a friendly conversation with the user. Ask them how their day is going or pick an interesting topic appropriate for their level.'}];
  window._ftActMessages=messages;
  
  body.innerHTML=`
    <div style="width:100%;max-width:420px;">
      <div class="chat-messages" id="ftActChat" style="max-height:50vh;"></div>
      <div class="chat-input-row">
        <input type="text" id="ftActInput" placeholder="영어로 말해보세요...">
        <button id="ftActMicBtn">🎤</button>
        <button id="ftActSendBtn">📤</button>
      </div>
      <button class="btn btn-secondary btn-sm btn-full" style="margin-top:8px;" onclick="sessionXp+=10;analyzeConversation(window._ftActMessages||[],'freetalk_activity');closeActivity();">대화 종료</button>
    </div>`;

  // Get opening from AI
  const opening=await callGPT(messages,100);
  if(!opening.error){
    messages.push({role:'assistant',content:opening.content});
    addFtActMsg('ai',opening.content);
    if(state.settings.autoTts) speak(opening.content);
    sessionXp+=5;updateActivityScore();
  } else {
    addFtActMsg('ai','Hello! How are you today? 😊 (안녕! 오늘 어때요?)');
  }

  document.getElementById('ftActSendBtn').addEventListener('click',()=>{
    const input=document.getElementById('ftActInput');
    sendFtAct(input.value,messages);
    input.value='';
  });

  document.getElementById('ftActInput').addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      const input=document.getElementById('ftActInput');
      sendFtAct(input.value,messages);
      input.value='';
    }
  });

  document.getElementById('ftActMicBtn').addEventListener('click',async()=>{
    const btn=document.getElementById('ftActMicBtn');
    btn.textContent='🔴';
    const text=await listenForSpeech('en-US',8000);
    btn.textContent='🎤';
    if(text){
      document.getElementById('ftActInput').value=text;
      sendFtAct(text,messages);
      document.getElementById('ftActInput').value='';
    }
  });
}

async function sendFtAct(text,messages){
  if(!text.trim()) return;
  addFtActMsg('user',text);
  messages.push({role:'user',content:text});
  const result=await callGPT(messages,200);
  if(!result.error){
    messages.push({role:'assistant',content:result.content});
    addFtActMsg('ai',result.content);
    if(state.settings.autoTts) speak(result.content);
    sessionXp+=5;updateActivityScore();
  } else {
    addFtActMsg('ai','(API 오류: '+result.message+')');
  }
}

function addFtActMsg(role,text){
  const chat=document.getElementById('ftActChat');
  if(!chat) return;
  const d=document.createElement('div');
  d.className='chat-msg '+role;
  if(role==='ai'){
    const safe=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    d.innerHTML=safe.replace(/(\([^)]*[\uAC00-\uD7AF][^)]*\))/g,'<span class="ko">$1</span>');
  } else {
    d.textContent=text;
  }
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

// ===== MINI LESSON (CLIL) =====
async function runMiniLesson(){
  const body=document.getElementById('actViewBody');
  if(!state.apiKey){
    body.innerHTML=`<div class="session-step"><h3>API 키가 필요합니다</h3><p>설정에서 OpenAI API 키를 입력해주세요.</p><button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button></div>`;
    return;
  }

  body.innerHTML=`<div class="session-step"><div style="font-size:48px;">⏳</div><h3>미니 레슨 준비 중...</h3></div>`;

  const topics=['Science: Water Cycle','Geography: Continents','History: Ancient Egypt','Nature: Rainforests','Space: The Solar System','Health: Healthy Eating'];
  const topic=topics[Math.floor(Math.random()*topics.length)];

  const result=await callGPT([
    {role:'system',content:getSystemPrompt()+`\n\nCreate a short CLIL (Content and Language Integrated Learning) mini-lesson about "${topic}". Format:\n1. Title\n2. Key vocabulary (3-5 words with simple definitions)\n3. Short passage (3-5 sentences appropriate for the user's level)\n4. 2 comprehension questions with 3 options each (mark correct with *)\n\nUse this JSON format:\n{"title":"...","vocab":[{"word":"...","def":"...","korean":"..."}],"passage":"...","questions":[{"q":"...","options":["...","...","..."],"answer":0}]}`},
    {role:'user',content:`Create a mini-lesson about ${topic}`}
  ],500);

  if(result.error){
    body.innerHTML=`<div class="session-step"><h3>오류</h3><p>${result.message}</p><button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button></div>`;
    return;
  }

  try{
    const jsonStr=result.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim();
    const lesson=JSON.parse(jsonStr);
    let qIdx=0;let correct=0;

    body.innerHTML=`
      <div style="width:100%;max-width:420px;padding:16px 0;">
        <h3 style="font-size:18px;font-weight:700;text-align:center;">🧪 ${lesson.title}</h3>
        <div style="margin:16px 0;">
          <h4 style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">📝 Key Vocabulary</h4>
          ${lesson.vocab.map(v=>`<div style="padding:6px 0;border-bottom:1px solid #F1F5F9;font-size:14px;"><strong>${v.word}</strong>: ${v.def} ${v.korean?'('+v.korean+')':''}</div>`).join('')}
        </div>
        <div style="background:#F8FAFC;border-radius:12px;padding:16px;margin:16px 0;line-height:1.8;font-size:14px;">
          ${lesson.passage}
        </div>
        <button class="btn btn-secondary btn-sm" onclick="speak(\`${lesson.passage.replace(/`/g,"'")}\`)">🔊 듣기</button>
        <div id="miniLessonQ" style="margin-top:20px;"></div>
      </div>`;

    function showQ(){
      if(qIdx>=lesson.questions.length){
        document.getElementById('miniLessonQ').innerHTML=`
          <div style="text-align:center;padding:16px;">
            <h3>🎉 레슨 완료! ${correct}/${lesson.questions.length} 정답</h3>
            <button class="btn btn-primary" style="margin-top:12px;" onclick="closeActivity()">돌아가기</button>
          </div>`;
        return;
      }
      const q=lesson.questions[qIdx];
      document.getElementById('miniLessonQ').innerHTML=`
        <div class="diag-question"><div class="q-text" style="font-size:15px;">${q.q}</div></div>
        <div class="diag-options">${q.options.map((o,i)=>`<button class="diag-option" data-idx="${i}">${o}</button>`).join('')}</div>`;
      document.querySelectorAll('#miniLessonQ .diag-option').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const idx=parseInt(btn.dataset.idx);
          document.querySelectorAll('#miniLessonQ .diag-option').forEach(b=>b.style.pointerEvents='none');
          if(idx===q.answer){btn.classList.add('correct');correct++;state.correctCount++;sessionXp+=5;updateActivityScore();addSkillScore('grammar',2);addSkillScore('vocabulary',2);}
          else{btn.classList.add('wrong');document.querySelectorAll('#miniLessonQ .diag-option')[q.answer].classList.add('correct');}
          state.totalCount++;
          setTimeout(()=>{qIdx++;showQ();},800);
        });
      });
    }
    showQ();
  }catch(e){
    body.innerHTML=`<div style="width:100%;max-width:420px;padding:16px;">
      <h3 style="font-size:16px;font-weight:700;">🧪 Mini Lesson</h3>
      <div style="background:#F8FAFC;border-radius:12px;padding:16px;margin:16px 0;line-height:1.8;font-size:14px;white-space:pre-wrap;">${result.content}</div>
      <button class="btn btn-primary btn-full" onclick="sessionXp+=10;closeActivity();">완료</button>
    </div>`;
  }
}

// ===== MISSION =====
async function runMission(){
  const body=document.getElementById('actViewBody');
  const lvl=Math.min(state.level,1);
  const missions=CONTENT.mission[lvl]||CONTENT.mission[1];
  const mission=missions[Math.floor(Math.random()*missions.length)];

  if(mission.type==='echo_sprint'){
    runEchoSprintMission(body,mission);
  } else if(mission.type==='sentence_build'){
    runSentenceBuildMission(body,mission);
  } else {
    runListenQuizMission(body,mission);
  }
}

async function runEchoSprintMission(body,mission){
  let wIdx=0;let correct=0;let timeLeft=mission.timeLimit;

  body.innerHTML=`
    <div style="text-align:center;width:100%;padding-top:16px;">
      <h3>⚡ ${mission.title}</h3>
      <p style="font-size:13px;color:var(--text-secondary);">${mission.desc}</p>
      <div class="mission-timer" id="mTimer">${timeLeft}</div>
      <div id="missionContent"></div>
    </div>`;

  const timer=setInterval(()=>{
    timeLeft--;
    const el=document.getElementById('mTimer');
    if(el){
      el.textContent=timeLeft;
      if(timeLeft<=5) el.classList.add('urgent');
    }
    if(timeLeft<=0){
      clearInterval(timer);
      endMission();
    }
  },1000);

  function endMission(){
    body.innerHTML=`
      <div class="session-step">
        <div style="font-size:64px;margin-bottom:16px;">${correct>=3?'🏆':'💪'}</div>
        <h3>미션 완료!</h3>
        <p>${correct}/${mission.words.length} 성공</p>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button>
      </div>`;
  }

  function showWord(){
    if(wIdx>=mission.words.length){clearInterval(timer);endMission();return;}
    const w=mission.words[wIdx];
    document.getElementById('missionContent').innerHTML=`
      <div class="echo-word">${w}</div>
      <div id="mListenStatus" style="font-size:14px;color:var(--primary);font-weight:600;min-height:24px;margin:8px 0;"></div>
      <div class="echo-result" id="mResult"></div>`;
    
    async function autoListen(){
      await speak(w);
      if(!document.getElementById('mListenStatus')) return;
      document.getElementById('mListenStatus').textContent='🔴 듣고 있어요...';
      const result=await listenForSpeech('en-US',4000);
      if(!document.getElementById('mResult')) return;
      document.getElementById('mListenStatus').textContent='';
      if(result&&compareWords(w.toLowerCase(),result.toLowerCase())>0.5){
        document.getElementById('mResult').className='echo-result good';
        document.getElementById('mResult').textContent='✅ 정답!';
        correct++;sessionXp+=5;updateActivityScore();
      } else {
        document.getElementById('mResult').className='echo-result retry';
        document.getElementById('mResult').textContent='❌ '+(result||'인식 실패');
      }
      state.totalCount++;
      setTimeout(()=>{wIdx++;showWord();},600);
    }
    autoListen();
  }
  showWord();
}

async function runListenQuizMission(body,mission){
  let qIdx=0;let correct=0;let timeLeft=mission.timeLimit;

  body.innerHTML=`
    <div style="text-align:center;width:100%;padding-top:16px;">
      <h3>⚡ ${mission.title}</h3>
      <p style="font-size:13px;color:var(--text-secondary);">${mission.desc}</p>
      <div class="mission-timer" id="mTimer">${timeLeft}</div>
      <div id="missionContent"></div>
    </div>`;

  const timer=setInterval(()=>{
    timeLeft--;
    const el=document.getElementById('mTimer');
    if(el){el.textContent=timeLeft;if(timeLeft<=5)el.classList.add('urgent');}
    if(timeLeft<=0){clearInterval(timer);endMission();}
  },1000);

  function endMission(){
    body.innerHTML=`
      <div class="session-step">
        <div style="font-size:64px;margin-bottom:16px;">${correct>=2?'🏆':'💪'}</div>
        <h3>미션 완료!</h3>
        <p>${correct}/${mission.questions.length} 정답</p>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button>
      </div>`;
  }

  function showQ(){
    if(qIdx>=mission.questions.length){clearInterval(timer);endMission();return;}
    const q=mission.questions[qIdx];
    document.getElementById('missionContent').innerHTML=`
      <button class="btn btn-secondary btn-sm" onclick="speak('${q.audio}')">🔊 듣기</button>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:16px;">
        ${q.options.map((o,i)=>`<div class="tpr-card" style="width:80px;height:80px;font-size:36px;" data-idx="${i}">${o}</div>`).join('')}
      </div>`;
    speak(q.audio);
    document.querySelectorAll('#missionContent .tpr-card').forEach(card=>{
      card.addEventListener('click',()=>{
        const idx=parseInt(card.dataset.idx);
        if(idx===q.answer){
          card.classList.add('correct');correct++;state.correctCount++;sessionXp+=5;updateActivityScore();
          trackAnswer(true);
        } else {card.classList.add('wrong');trackAnswer(false);}
        state.totalCount++;
        setTimeout(()=>{qIdx++;showQ();},500);
      });
    });
  }
  showQ();
}

async function runSentenceBuildMission(body,mission){
  let timeLeft=mission.timeLimit;
  const words=[...mission.words];
  const answer=words.join(' ');
  const shuffled=[...words];
  shuffle(shuffled);

  body.innerHTML=`
    <div style="text-align:center;width:100%;padding-top:16px;">
      <h3>⚡ ${mission.title}</h3>
      <p style="font-size:13px;color:var(--text-secondary);">${mission.desc}</p>
      <div class="mission-timer" id="mTimer">${timeLeft}</div>
      <div id="sentenceArea" style="min-height:50px;padding:12px;margin:16px auto;background:var(--card);border-radius:12px;border:2px dashed #CBD5E1;max-width:360px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;">
        <span style="color:var(--text-secondary);font-size:14px;">여기에 단어를 배치하세요</span>
      </div>
      <div id="wordBank" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:16px auto;max-width:360px;">
        ${shuffled.map((w,i)=>`<button class="btn btn-secondary btn-sm word-chip" data-word="${w}" data-idx="${i}" style="font-size:15px;padding:8px 16px;">${w}</button>`).join('')}
      </div>
      <div id="sentenceResult" style="min-height:40px;margin-top:12px;"></div>
      <button class="btn btn-sm" id="sentenceReset" style="margin-top:8px;color:var(--text-secondary);">🔄 다시 하기</button>
    </div>`;

  const timer=setInterval(()=>{
    timeLeft--;
    const el=document.getElementById('mTimer');
    if(el){el.textContent=timeLeft;if(timeLeft<=5)el.classList.add('urgent');}
    if(timeLeft<=0){clearInterval(timer);endMission(false);}
  },1000);

  let selected=[];

  function updateArea(){
    const area=document.getElementById('sentenceArea');
    if(!area) return;
    if(selected.length===0){
      area.innerHTML='<span style="color:var(--text-secondary);font-size:14px;">여기에 단어를 배치하세요</span>';
    } else {
      area.innerHTML=selected.map((w,i)=>`<button class="btn btn-primary btn-sm" data-pos="${i}" style="font-size:15px;padding:8px 16px;">${w}</button>`).join('');
      area.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const pos=parseInt(btn.dataset.pos);
          const removed=selected.splice(pos,1)[0];
          // re-enable in word bank
          const chips=document.querySelectorAll('.word-chip');
          for(const c of chips){
            if(c.dataset.word===removed && c.disabled){
              c.disabled=false;
              c.style.opacity='1';
              break;
            }
          }
          updateArea();
          checkAnswer();
        });
      });
    }
  }

  function checkAnswer(){
    const result=document.getElementById('sentenceResult');
    if(!result) return;
    if(selected.length===words.length){
      const userAnswer=selected.join(' ');
      if(userAnswer===answer){
        clearInterval(timer);
        result.innerHTML='<div style="color:var(--success);font-weight:700;font-size:16px;">🎉 Perfect! 정답이에요!</div>';
        state.correctCount++;
        state.totalCount++;
        sessionXp+=15;
        updateActivityScore();
        trackAnswer(true);
        setTimeout(()=>endMission(true),1500);
      } else {
        result.innerHTML='<div style="color:var(--danger);font-weight:600;font-size:14px;">순서가 달라요. 다시 해보세요!</div>';
      }
    } else {
      result.innerHTML='';
    }
  }

  document.querySelectorAll('.word-chip').forEach(chip=>{
    chip.addEventListener('click',()=>{
      if(chip.disabled) return;
      selected.push(chip.dataset.word);
      chip.disabled=true;
      chip.style.opacity='0.3';
      updateArea();
      checkAnswer();
    });
  });

  document.getElementById('sentenceReset').addEventListener('click',()=>{
    selected=[];
    document.querySelectorAll('.word-chip').forEach(c=>{c.disabled=false;c.style.opacity='1';});
    updateArea();
    document.getElementById('sentenceResult').innerHTML='';
  });

  function endMission(success){
    body.innerHTML=`
      <div class="session-step">
        <div style="font-size:64px;margin-bottom:16px;">${success?'🏆':'💪'}</div>
        <h3>미션 ${success?'성공':'종료'}!</h3>
        <p>정답: "${answer}"</p>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="closeActivity()">돌아가기</button>
      </div>`;
  }
}

// ===== FREE TALK PAGE (Tab) =====
let ftMessages=[];
let ftInited=false;

function initFreeTalk(){
  if(ftInited) return;
  ftInited=true;
  ftMessages=[{role:'system',content:getSystemPrompt()+'\n\nYou are having a casual conversation. Start by greeting the user warmly.'}];
  
  const chat=document.getElementById('chatMessages');
  chat.innerHTML='';
  addChatMsg('ai','안녕하세요! 영어로 대화해볼까요? 😊\nHello! Shall we chat in English?');
}

function addChatMsg(role,text){
  const chat=document.getElementById('chatMessages');
  const d=document.createElement('div');
  d.className='chat-msg '+role;
  if(role==='ai'){
    // Highlight Korean parenthetical translations in a subtle style
    const safe=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    d.innerHTML=safe.replace(/(\([^)]*[\uAC00-\uD7AF][^)]*\))/g,'<span class="ko">$1</span>');
  } else {
    d.textContent=text;
  }
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

let isListening=false;
let orbState='idle';

async function toggleListening(){
  if(orbState==='listening' || orbState==='thinking'){
    return;
  }
  if(orbState==='speaking'){
    window.speechSynthesis.cancel();
    setOrbState('idle');
    return;
  }
  
  setOrbState('listening');
  const text=await listenForSpeech('ko-KR',10000);
  
  if(text){
    addChatMsg('user',text);
    const hasKo=/[\uAC00-\uD7AF]/.test(text);
    const msgContent=hasKo
      ? `[User spoke in Korean] ${text}\n(Please respond in English with Korean translation. Encourage them to try in English.)`
      : text;
    ftMessages.push({role:'user',content:msgContent});
    
    setOrbState('thinking');
    const [result, grammarResult]=await Promise.all([
      callGPT(ftMessages,200),
      checkGrammar(text)
    ]);
    
    if(!result.error){
      ftMessages.push({role:'assistant',content:result.content});
      addChatMsg('ai',result.content);
      // Show grammar correction card if error found
      const grammarCard=createGrammarCard(grammarResult);
      if(grammarCard){
        document.getElementById('chatMessages').appendChild(grammarCard);
        document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;
      }
      setOrbState('speaking');
      await speak(result.content);
      setOrbState('idle');
      
      // Add some XP for chatting
      state.dailyXp+=2;
      state.totalXp+=2;
      addSkillScore('fluency',2);
      addSkillScore('speaking',1);
      saveState();
      updateHeader();
    } else {
      addChatMsg('ai','(Error: '+result.message+')');
      setOrbState('idle');
    }
  } else {
    setOrbState('idle');
    document.getElementById('orbStatus').textContent='음성을 인식하지 못했어요. 다시 탭해주세요';
  }
}

function setOrbState(s){
  orbState=s;
  const orb=document.getElementById('talkOrb');
  const status=document.getElementById('orbStatus');
  orb.className='orb';
  switch(s){
    case 'idle':orb.classList.add('orb-idle');status.textContent='탭하여 대화 시작';break;
    case 'listening':orb.classList.add('orb-listening');status.textContent='🎤 듣고 있어요...';break;
    case 'thinking':orb.classList.add('orb-thinking');status.textContent='🤔 생각 중...';break;
    case 'speaking':orb.classList.add('orb-speaking');status.textContent='🔊 말하고 있어요...';break;
  }
}

async function sendTextMessage(){
  const input=document.getElementById('chatTextInput');
  const text=input.value.trim();
  if(!text) return;
  input.value='';
  
  addChatMsg('user',text);
  const hasKo=/[\uAC00-\uD7AF]/.test(text);
  const msgContent=hasKo
    ? `[User typed in Korean] ${text}\n(Please respond in English with Korean translation. Encourage them to try in English.)`
    : text;
  ftMessages.push({role:'user',content:msgContent});
  
  setOrbState('thinking');
  const [result, grammarResult]=await Promise.all([
    callGPT(ftMessages,200),
    checkGrammar(text)
  ]);
  
  if(!result.error){
    ftMessages.push({role:'assistant',content:result.content});
    addChatMsg('ai',result.content);
    // Show grammar correction card if error found
    const grammarCard=createGrammarCard(grammarResult);
    if(grammarCard){
      document.getElementById('chatMessages').appendChild(grammarCard);
      document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;
    }
    if(state.settings.autoTts){
      setOrbState('speaking');
      await speak(result.content);
    }
    setOrbState('idle');
    state.dailyXp+=2;state.totalXp+=2;addSkillScore('fluency',2);addSkillScore('speaking',1);saveState();updateHeader();
  } else {
    addChatMsg('ai','(Error: '+result.message+')');
    setOrbState('idle');
  }
}

document.getElementById('chatTextInput').addEventListener('keydown',(e)=>{
  if(e.key==='Enter') sendTextMessage();
});

// Orb touch/click handlers (prevent long-press text selection on mobile)
(function(){
  let tOrbTouched=false;
  const talkOrb=document.getElementById('talkOrb');
  talkOrb.addEventListener('touchend',(e)=>{
    e.preventDefault();
    tOrbTouched=true;
    toggleListening();
  },{passive:false});
  talkOrb.addEventListener('click',(e)=>{
    if(tOrbTouched){tOrbTouched=false;return;}
    toggleListening();
  });
})();

// ===== VOICE CONVERSATION MODE =====
let voiceMessages=[];
let voiceActive=false;
let voiceListening=false;
let voiceOrbState='idle';
let voiceAutoLoop=false; // auto turn-switching flag
let voiceSttLang='ko-KR'; // STT language for voice mode (ko-KR recognizes both Korean and English well)

function toggleVoiceLang(){
  const btn=document.getElementById('voiceLangToggle');
  if(voiceSttLang==='ko-KR'){
    voiceSttLang='en-US';
    btn.textContent='🌐 English only';
    btn.style.background='rgba(255,255,255,.15)';
  } else {
    voiceSttLang='ko-KR';
    btn.textContent='🌐 한국어+영어';
    btn.style.background='rgba(129,140,248,.3)';
  }
}

function openVoiceMode(){
  if(!state.apiKey){
    alert('음성 대화 모드를 사용하려면 설정에서 OpenAI API 키를 입력해주세요.');
    return;
  }
  const overlay=document.getElementById('voiceModeOverlay');
  overlay.classList.add('active');
  voiceActive=true;
  voiceAutoLoop=false;

  // Set level badge
  const lv=LEVELS[state.level];
  document.getElementById('voiceLevelBadge').textContent=`Lv.${state.level} ${lv.name}`;

  // Init system prompt
  voiceMessages=[{role:'system',content:getSystemPrompt()+'\n\nThis is a VOICE conversation. Rules: Keep every response under 2 sentences. Be warm and natural. Ask one simple question at the end. Never use emojis. Sound like chatting with a friend.'}];

  // Reset history
  document.getElementById('voiceHistory').innerHTML='';
  document.getElementById('voiceTranscript').textContent='';

  setVoiceOrbState('idle');

  // Reset language toggle
  voiceSttLang='ko-KR';
  const langBtn=document.getElementById('voiceLangToggle');
  if(langBtn){langBtn.textContent='🌐 한국어+영어';langBtn.style.background='rgba(129,140,248,.3)';}

  // 자동 첫 인사
  setTimeout(async()=>{
    if(!voiceActive) return;
    setVoiceOrbState('thinking');
    const greetings=[
      {en:"Hey! Nice to see you. How's your day going?",ko:"(안녕! 반가워요. 오늘 하루 어때요?)"},
      {en:"Hi there! Ready to practice some English? What's on your mind?",ko:"(안녕! 영어 연습할 준비 됐어요? 무슨 생각해요?)"},
      {en:"Hey! Good to see you again. What did you do today?",ko:"(안녕! 또 만나서 반가워요. 오늘 뭐 했어요?)"}
    ];
    const g=greetings[Math.floor(Math.random()*greetings.length)];
    const fullGreeting=state.level<=1?g.en+' '+g.ko:g.en;
    voiceMessages.push({role:'assistant',content:fullGreeting});
    addVoiceMsg('ai',fullGreeting);
    setVoiceOrbState('speaking');
    if(window.speakWithAvatar){await window.speakWithAvatar(fullGreeting,'en-US');}else{await speak(fullGreeting);}
    if(voiceActive){setVoiceOrbState('idle');document.getElementById('voiceTranscript').textContent='';}
  },800);
}

function closeVoiceMode(){
  const overlay=document.getElementById('voiceModeOverlay');
  // Trigger conversation analysis before closing if enough messages
  const msgsCopy=[...voiceMessages];
  overlay.classList.remove('active');
  voiceActive=false;
  voiceListening=false;
  voiceAutoLoop=false;
  window.speechSynthesis.cancel();
  setVoiceOrbState('idle');
  // Analyze conversation quality asynchronously
  analyzeConversation(msgsCopy,'voice');
}

function setVoiceOrbState(s){
  voiceOrbState=s;
  const orb=document.getElementById('voiceOrb');
  const statusEl=document.getElementById('voiceStatusText');
  const subtitleEl=document.getElementById('voiceSubtitle');

  orb.className='voice-orb';
  switch(s){
    case 'idle':
      orb.classList.add('v-idle');
      statusEl.textContent='탭하여 대화 시작';
      subtitleEl.textContent='한 번 탭하면 자동으로 대화가 이어집니다';
      break;
    case 'listening':
      orb.classList.add('v-listening');
      statusEl.textContent='🎤 듣고 있어요...';
      subtitleEl.textContent='영어로 말해보세요';
      break;
    case 'thinking':
      orb.classList.add('v-thinking');
      statusEl.textContent='🤔 생각 중...';
      subtitleEl.textContent='답변을 준비하고 있어요';
      break;
    case 'speaking':
      orb.classList.add('v-speaking');
      statusEl.textContent='🔊 말하고 있어요...';
      subtitleEl.textContent='잘 들어보세요';
      break;
  }
}

function addVoiceMsg(role,text){
  const hist=document.getElementById('voiceHistory');
  const d=document.createElement('div');
  d.className='v-msg '+role;
  if(role==='ai'){
    const safe=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    d.innerHTML=safe.replace(/(\([^)]*[\uAC00-\uD7AF][^)]*\))/g,'<span class="ko">$1</span>');
  } else {
    d.textContent=text;
  }
  hist.appendChild(d);
  hist.scrollTop=hist.scrollHeight;
}

async function handleOrbTap(){
  if(!voiceActive) return;

  // If speaking, cancel speech and stop auto-loop
  if(voiceOrbState==='speaking'){
    voiceAutoLoop=false;
    window.speechSynthesis.cancel();
    setVoiceOrbState('idle');
    document.getElementById('voiceTranscript').textContent='탭하여 다시 시작';
    return;
  }

  // If already listening or thinking, ignore
  if(voiceOrbState==='listening' || voiceOrbState==='thinking') return;

  // Start the conversation loop
  voiceAutoLoop=true;
  await voiceConversationTurn();
}

async function voiceConversationTurn(){
  if(!voiceActive || !voiceAutoLoop) return;

  // === LISTEN ===
  setVoiceOrbState('listening');
  document.getElementById('voiceTranscript').textContent='';

  const text=await listenForSpeech(voiceSttLang,8000);

  if(!voiceActive || !voiceAutoLoop) return;

  if(!text){
    // No speech detected - pause auto-loop, return to idle
    voiceAutoLoop=false;
    setVoiceOrbState('idle');
    document.getElementById('voiceTranscript').textContent='음성을 인식하지 못했어요. 탭하여 다시 시작';
    return;
  }

  // Show user transcript
  document.getElementById('voiceTranscript').textContent=`"${text}"`;
  addVoiceMsg('user',text);

  // If user spoke Korean, add hint for GPT to respond in English
  const hasKorean=/[\uAC00-\uD7AF]/.test(text);
  const msgContent=hasKorean
    ? `[User spoke in Korean] ${text}\n(Please respond in English with Korean translation. Encourage them to try in English.)`
    : text;
  voiceMessages.push({role:'user',content:msgContent});

  // === THINK ===
  setVoiceOrbState('thinking');
  const [result, grammarResult]=await Promise.all([
    callGPT(voiceMessages,200),
    checkGrammar(text)
  ]);

  if(!voiceActive || !voiceAutoLoop) return;

  if(!result.error){
    voiceMessages.push({role:'assistant',content:result.content});
    addVoiceMsg('ai',result.content);
    // Show grammar correction card in voice history if error found
    const grammarCard=createGrammarCard(grammarResult);
    if(grammarCard){
      document.getElementById('voiceHistory').appendChild(grammarCard);
      document.getElementById('voiceHistory').scrollTop=document.getElementById('voiceHistory').scrollHeight;
    }

    // === SPEAK ===
    setVoiceOrbState('speaking');
    if(window.speakWithAvatar){await window.speakWithAvatar(result.content,'en-US');}else{await speak(result.content);}

    if(!voiceActive || !voiceAutoLoop) return;

    // Award XP
    state.dailyXp+=2;
    state.totalXp+=2;
    addSkillScore('fluency',2);
    addSkillScore('speaking',1);
    if(!state.activityCounts.freetalk) state.activityCounts.freetalk=0;
    state.activityCounts.freetalk++;
    saveState();
    updateHeader();

    // === AUTO NEXT TURN === (brief pause then listen again)
    document.getElementById('voiceTranscript').textContent='';
    setTimeout(()=>{
      if(voiceActive && voiceAutoLoop){
        voiceConversationTurn();
      }
    },400);

  } else {
    addVoiceMsg('ai','(Error: '+result.message+')');
    voiceAutoLoop=false;
    setVoiceOrbState('idle');
  }
}

// Voice orb touch/click handler (prevent long-press text selection on mobile)
(function(){
  let vOrbTouched=false;
  const voiceOrbW=document.getElementById('voiceOrbWrapper');
  voiceOrbW.addEventListener('touchend',(e)=>{
    e.preventDefault();
    vOrbTouched=true;
    handleOrbTap();
  },{passive:false});
  voiceOrbW.addEventListener('click',(e)=>{
    if(vOrbTouched){vOrbTouched=false;return;}
    handleOrbTap();
  });
})();

// ===== GRAMMAR CHECK =====
async function checkGrammar(userText){
  if(!state.apiKey || userText.split(' ').length < 3) return null;
  // Skip if text is mostly Korean
  if(/[\uAC00-\uD7AF]/.test(userText) && userText.replace(/[\uAC00-\uD7AF\s]/g,'').length < 5) return null;

  const result=await callGPT([
    {role:'system',content:'You are a grammar checker. Analyze the English sentence. If there are errors, return JSON: {"hasError":true,"original":"user text","corrected":"corrected text","explanation":"간단한 한국어 설명","errorType":"grammar|vocabulary|expression"}. If correct, return {"hasError":false}. Be lenient with minor issues. Only flag clear errors. No markdown, no code fences, just JSON.'},
    {role:'user',content:userText}
  ],150);

  if(result.error) return null;
  try{
    return JSON.parse(result.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim());
  }catch(e){return null;}
}

function createGrammarCard(grammarResult){
  if(!grammarResult || !grammarResult.hasError) return null;
  const card=document.createElement('div');
  card.style.cssText='background:#FEF3C7;border-radius:8px;padding:8px 12px;margin:4px 0;font-size:12px;';
  card.innerHTML=`✏️ <s>${grammarResult.original}</s> → <strong>${grammarResult.corrected}</strong><br><span style="color:var(--text-secondary);">${grammarResult.explanation}</span>`;
  return card;
}

// ===== SPACED REPETITION (SM-2) =====
function addToReview(type, data){
  // Avoid duplicates: check if same type+key already exists
  const key = type === 'echo' ? data.word : (data.instruction || data.audio || JSON.stringify(data));
  const exists = state.reviewQueue.find(item => item.type === type && item.key === key);
  if(exists) return; // already queued

  state.reviewQueue.push({
    type: type,          // 'echo' or 'tpr'
    data: data,          // original item data
    key: key,            // unique identifier
    nextReview: Date.now(), // review immediately available
    interval: 1,         // days until next review (starts at 1)
    easeFactor: 2.5      // SM-2 ease factor
  });
  saveState();
}

function getReviewItems(){
  const now = Date.now();
  return state.reviewQueue.filter(item => item.nextReview <= now);
}

function updateReviewItem(item, quality){
  // SM-2 algorithm: quality 0-5 (0=total blackout, 5=perfect)
  // quality >= 3 means correct recall
  const idx = state.reviewQueue.findIndex(r => r.key === item.key && r.type === item.type);
  if(idx === -1) return;

  const review = state.reviewQueue[idx];

  if(quality >= 3){
    // Correct response
    if(review.interval === 1){
      review.interval = 1;
    } else if(review.interval <= 1){
      review.interval = 6;
    } else {
      review.interval = Math.round(review.interval * review.easeFactor);
    }
    // Update ease factor
    review.easeFactor = review.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
    if(review.easeFactor < 1.3) review.easeFactor = 1.3;
  } else {
    // Incorrect response: reset
    review.interval = 1;
  }

  review.nextReview = Date.now() + review.interval * 24 * 60 * 60 * 1000;

  // If quality is 5 (perfect) and interval > 30 days, remove from queue
  if(quality === 5 && review.interval > 30){
    state.reviewQueue.splice(idx, 1);
  }

  saveState();
}

function startReviewSession(){
  const items = getReviewItems();
  if(items.length === 0){
    alert('복습할 항목이 없어요! 🎉');
    return;
  }

  // Open activity view for review
  const actView = document.getElementById('activityView');
  actView.classList.add('active');
  document.getElementById('actViewTitle').textContent = '📖 복습 세션';
  const body = document.getElementById('actViewBody');

  let rIdx = 0;
  const reviewItems = items.slice(0, 10); // max 10 per session
  let sessionCorrect = 0;

  async function showReviewItem(){
    if(rIdx >= reviewItems.length){
      body.innerHTML = `
        <div class="session-step">
          <div style="font-size:64px;margin-bottom:16px;">🎉</div>
          <h3>복습 완료!</h3>
          <p>${sessionCorrect}/${reviewItems.length} 정답</p>
          <button class="btn btn-primary" style="margin-top:20px;" onclick="closeActivity()">돌아가기</button>
        </div>`;
      renderHome();
      return;
    }

    const ri = reviewItems[rIdx];

    if(ri.type === 'echo'){
      // Echo review: listen and repeat
      const w = ri.data;
      body.innerHTML = `
        <div style="text-align:center;width:100%;padding-top:24px;">
          <p style="font-size:13px;color:var(--text-secondary);">복습 ${rIdx+1} / ${reviewItems.length}</p>
          <div class="echo-word">${w.word}</div>
          <div class="echo-sub">${w.korean||''}</div>
          <button class="btn btn-secondary btn-sm" id="reviewPlayBtn">🔊 듣기</button>
          <div id="reviewScoreArea" style="min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;"></div>
          <div id="reviewListenStatus" style="font-size:14px;color:var(--primary);font-weight:600;margin:8px 0;min-height:24px;"></div>
        </div>`;

      document.getElementById('reviewPlayBtn').addEventListener('click',()=>speak(w.word));

      // Auto-play then listen
      if(state.settings.autoTts) await speak(w.word);

      const statusEl = document.getElementById('reviewListenStatus');
      if(statusEl) statusEl.textContent = '🔴 듣고 있어요...';

      const result = await listenForSpeech('en-US', 6000);
      if(statusEl) statusEl.textContent = '';

      if(!document.getElementById('reviewScoreArea')) return;

      if(result && result.trim().length > 0){
        const score = getSimilarity(w.word, result);
        const area = document.getElementById('reviewScoreArea');
        let quality, cls, label;
        if(score >= 80){ quality = 5; cls = 'perfect'; label = 'Perfect! 🎉'; sessionCorrect++; }
        else if(score >= 50){ quality = 3; cls = 'good'; label = 'Good! 👍'; sessionCorrect++; }
        else { quality = 1; cls = 'retry'; label = '다시 연습해봐요'; }

        area.innerHTML = `
          <div class="score-circle ${cls}">${score}%</div>
          <div style="color:var(${cls==='perfect'?'--success':cls==='good'?'--warning':'--danger'});font-weight:600;margin:8px 0;">${label}</div>
          <div style="font-size:13px;color:var(--text-secondary);">🗣️ "${result}"</div>`;

        updateReviewItem(ri, quality);
      } else {
        const area = document.getElementById('reviewScoreArea');
        area.innerHTML = '<p style="color:var(--warning);font-weight:600;">🎤 인식 실패 - 건너뜁니다</p>';
      }

      await new Promise(r => setTimeout(r, 1500));
      rIdx++;
      showReviewItem();

    } else if(ri.type === 'tpr'){
      // TPR review: show question
      const q = ri.data;
      body.innerHTML = `
        <div class="session-step">
          <p style="font-size:13px;color:var(--text-secondary);">복습 ${rIdx+1} / ${reviewItems.length}</p>
          <h3 style="font-size:18px;margin:12px 0;">"${q.instruction}"</h3>
          <button class="btn btn-sm btn-secondary" id="reviewTprPlay">🔊 다시 듣기</button>
        </div>
        <div class="tpr-grid" id="reviewTprGrid">
          ${q.options.map((o,i)=>`<div class="tpr-card" data-idx="${i}">${o}</div>`).join('')}
        </div>`;

      document.getElementById('reviewTprPlay').addEventListener('click',()=>speak(q.audio||q.instruction));
      if(state.settings.autoTts) await speak(q.audio||q.instruction);

      body.querySelectorAll('.tpr-card').forEach(card=>{
        card.addEventListener('click',async()=>{
          const idx = parseInt(card.dataset.idx);
          body.querySelectorAll('.tpr-card').forEach(c=>c.style.pointerEvents='none');

          let quality;
          if(idx === q.answer){
            card.classList.add('correct');
            quality = 5;
            sessionCorrect++;
          } else {
            card.classList.add('wrong');
            body.querySelectorAll('.tpr-card')[q.answer].classList.add('correct');
            quality = 1;
          }
          updateReviewItem(ri, quality);

          await new Promise(r=>setTimeout(r,800));
          rIdx++;
          showReviewItem();
        });
      });
    }
  }
  showReviewItem();
}

// ===== SETTINGS =====
function openSettings(){
  document.getElementById('settingsApiKey').value=state.apiKey;
  document.getElementById('settingsTtsSpeed').value=state.settings.ttsSpeed;
  document.getElementById('settingsLevel').value=state.level;
  document.getElementById('toggleAutoTts').classList.toggle('on',state.settings.autoTts);
  document.getElementById('toggleKorean').classList.toggle('on',state.settings.showKorean);
  document.getElementById('settingsReminder').value=state.settings.reminderTime||'';
  document.getElementById('settingsModal').classList.add('active');
}

function closeSettings(){
  document.getElementById('settingsModal').classList.remove('active');
}

function saveSettings(){
  state.apiKey=document.getElementById('settingsApiKey').value.trim();
  state.settings.ttsSpeed=parseFloat(document.getElementById('settingsTtsSpeed').value);
  state.settings.autoTts=document.getElementById('toggleAutoTts').classList.contains('on');
  state.settings.showKorean=document.getElementById('toggleKorean').classList.contains('on');
  const reminderVal=document.getElementById('settingsReminder').value;
  state.settings.reminderTime=reminderVal;
  // Request Notification permission if reminder is set
  if(reminderVal && 'Notification' in window && Notification.permission==='default'){
    Notification.requestPermission();
  }
  saveState();
  closeSettings();
}

function toggleSetting(el){
  el.classList.toggle('on');
}

function manualLevelChange(val){
  state.level=parseInt(val);
  saveState();
  updateHeader();
  renderHome();
  renderActivities();
}

function resetAllData(){
  if(confirm('정말 모든 데이터를 초기화하시겠습니까?')){
    localStorage.removeItem('myEnglishCoach');
    location.reload();
  }
}

// ===== UTILITIES =====
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function compareWords(a,b){
  a=a.trim().toLowerCase();b=b.trim().toLowerCase();
  if(a===b) return 1;
  // Simple similarity check
  const aWords=a.split(/\s+/);
  const bWords=b.split(/\s+/);
  let matches=0;
  aWords.forEach(w=>{if(bWords.some(bw=>bw.includes(w)||w.includes(bw))) matches++;});
  const score=matches/Math.max(aWords.length,bWords.length);
  // Also check Levenshtein for single words
  if(aWords.length===1&&bWords.length===1){
    return 1-levenshtein(a,b)/Math.max(a.length,b.length);
  }
  return score;
}

function levenshtein(a,b){
  const m=a.length,n=b.length;
  const d=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) d[i][0]=i;
  for(let j=0;j<=n;j++) d[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+cost);
    }
  }
  return d[m][n];
}

// ===== ADAPTIVE DIFFICULTY =====
// Adjusts content selection based on accuracy
function getAdaptiveLevel(){
  if(state.totalCount<5) return state.level;
  const acc=state.correctCount/state.totalCount;
  if(acc>0.85 && state.totalCount>10) return Math.min(5,state.level+1);
  if(acc<0.4 && state.totalCount>10) return Math.max(0,state.level-1);
  return state.level;
}

// ===== CURRICULUM ROADMAP =====
const CURRICULUM_TOPICS = {
  0: [
    {id:'lv0_greetings',name:'인사하기',activities:['tpr','echo']},
    {id:'lv0_feelings',name:'감정 표현',activities:['tpr','echo']},
    {id:'lv0_colors',name:'색깔과 숫자',activities:['tpr']},
    {id:'lv0_animals',name:'동물',activities:['tpr','echo']},
    {id:'lv0_body',name:'신체 부위',activities:['tpr']}
  ],
  1: [
    {id:'lv1_daily',name:'일상 표현',activities:['echo','chant']},
    {id:'lv1_food',name:'음식과 주문',activities:['echo','chant']},
    {id:'lv1_stories',name:'짧은 이야기',activities:['story']},
    {id:'lv1_patterns',name:'패턴 문장',activities:['chant','mission']},
    {id:'lv1_listening',name:'듣기 연습',activities:['tpr','mission']}
  ],
  2: [
    {id:'lv2_conversation',name:'기본 대화',activities:['echo','roleplay']},
    {id:'lv2_travel',name:'여행 영어',activities:['roleplay']},
    {id:'lv2_reading',name:'읽기와 이해',activities:['story']},
    {id:'lv2_roleplay',name:'상황극',activities:['roleplay']},
    {id:'lv2_challenge',name:'미션 도전',activities:['mission']}
  ],
  3: [
    {id:'lv3_opinion',name:'의견 표현',activities:['freetalk','roleplay']},
    {id:'lv3_complex',name:'복합 문장',activities:['echo','freetalk']},
    {id:'lv3_clil',name:'주제 학습',activities:['minilesson']},
    {id:'lv3_advanced_rp',name:'심화 역할극',activities:['roleplay']},
    {id:'lv3_fluency',name:'유창성 훈련',activities:['freetalk']}
  ],
  4: [
    {id:'lv4_debate',name:'토론과 논쟁',activities:['freetalk','roleplay']},
    {id:'lv4_academic',name:'학술 주제',activities:['minilesson']},
    {id:'lv4_idioms',name:'관용어와 표현',activities:['echo','freetalk']},
    {id:'lv4_business',name:'비즈니스 영어',activities:['roleplay']},
    {id:'lv4_presentation',name:'프레젠테이션',activities:['freetalk']}
  ],
  5: [
    {id:'lv5_professional',name:'전문 영어',activities:['freetalk','roleplay']},
    {id:'lv5_nuance',name:'뉘앙스와 어감',activities:['echo','freetalk']},
    {id:'lv5_culture',name:'문화와 시사',activities:['minilesson','freetalk']},
    {id:'lv5_negotiation',name:'협상과 설득',activities:['roleplay']},
    {id:'lv5_mastery',name:'완전 자유 대화',activities:['freetalk']}
  ]
};

function toggleRoadmap(){
  const container=document.getElementById('roadmapContainer');
  const arrow=document.getElementById('roadmapArrow');
  container.classList.toggle('open');
  arrow.classList.toggle('open');
  if(container.classList.contains('open')) renderRoadmap();
}

function renderRoadmap(){
  const tl=document.getElementById('roadmapTimeline');
  if(!tl) return;
  if(!state.completedTopics) state.completedTopics=[];
  tl.innerHTML='';
  for(let lv=0;lv<=5;lv++){
    const lvData=LEVELS[lv];
    const topics=CURRICULUM_TOPICS[lv];
    const isCompleted=lv<state.level;
    const isCurrent=lv===state.level;
    const isLocked=lv>state.level;
    const dotClass=isCompleted?'completed':isCurrent?'current':'locked';
    const labelClass=isCompleted?'completed':isCurrent?'current':'locked';
    const dotIcon=isCompleted?'✓':isLocked?'🔒':lvData.emoji;
    const node=document.createElement('div');
    node.className='roadmap-node';
    node.innerHTML=`
      <div class="roadmap-dot ${dotClass}">${dotIcon}</div>
      <div class="roadmap-label ${labelClass}" onclick="toggleRoadmapTopics(${lv})">
        ${lvData.emoji} Lv.${lv} ${lvData.name} <span style="font-size:11px;font-weight:400;color:var(--text-secondary);">${lvData.label}</span>
      </div>
      <div class="roadmap-topics" id="roadmapTopics${lv}">
        ${topics.map(t=>{
          const done=state.completedTopics.includes(t.id);
          return `<div class="topic-item ${done?'done':'pending'}">
            ${done?'✅':'⬜'} ${t.name}
            <span style="margin-left:auto;font-size:10px;opacity:.6;">${t.activities.map(a=>{const act=ACTIVITIES.find(x=>x.id===a);return act?act.emoji:'';}).join('')}</span>
          </div>`;
        }).join('')}
      </div>`;
    tl.appendChild(node);
  }
}

function toggleRoadmapTopics(lv){
  const el=document.getElementById('roadmapTopics'+lv);
  if(el) el.classList.toggle('open');
}

function markTopicComplete(activityId){
  if(!state.completedTopics) state.completedTopics=[];
  const lvTopics=CURRICULUM_TOPICS[state.level]||[];
  for(const topic of lvTopics){
    if(topic.activities.includes(activityId) && !state.completedTopics.includes(topic.id)){
      state.completedTopics.push(topic.id);
      break;
    }
  }
  saveState();
}

// ===== CONVERSATION QUALITY ANALYSIS =====
async function analyzeConversation(messages, source){
  if(!state.apiKey || !messages || messages.length<4) return;
  const userMsgs=messages.filter(m=>m.role==='user');
  if(userMsgs.length<2) return;

  const convText=messages.filter(m=>m.role!=='system').map(m=>`${m.role==='user'?'User':'AI'}: ${m.content}`).join('\n');

  const overlay=document.getElementById('convReportOverlay');
  const card=document.getElementById('convReportCard');
  card.innerHTML='<div style="text-align:center;padding:32px;"><div style="font-size:48px;">⏳</div><p style="margin-top:8px;font-size:14px;color:var(--text-secondary);">대화를 분석하고 있어요...</p></div>';
  overlay.classList.add('active');

  const result=await callGPT([{role:'system',content:'Analyze this English conversation by a Korean learner. Return ONLY JSON (no markdown, no code fences): {"fluency":1-10,"vocabulary":1-10,"grammar":1-10,"pronunciation_effort":1-10,"pragmatics":1-10,"overall":1-10,"strengths":["strength1 in Korean","strength2 in Korean"],"improvements":["improvement1 in Korean","improvement2 in Korean"],"example_correction":{"original":"user sentence with error","corrected":"corrected version","explanation":"한국어 설명"}}'},{role:'user',content:convText}],600);

  if(result.error){
    card.innerHTML=`<div style="text-align:center;padding:24px;"><p>분석 실패: ${result.message}</p><button class="btn btn-primary" style="margin-top:12px;" onclick="document.getElementById('convReportOverlay').classList.remove('active')">닫기</button></div>`;
    return;
  }

  let report;
  try{
    report=JSON.parse(result.content.replace(/```json?\n?/g,'').replace(/```/g,'').trim());
  }catch(e){
    card.innerHTML=`<div style="text-align:center;padding:24px;"><p>분석 결과 파싱 실패</p><button class="btn btn-primary" style="margin-top:12px;" onclick="document.getElementById('convReportOverlay').classList.remove('active')">닫기</button></div>`;
    return;
  }

  if(!state.conversationScores) state.conversationScores=[];
  state.conversationScores.push({
    date:new Date().toLocaleDateString('ko-KR'),
    source:source,
    ...report
  });

  const bonusXp=(report.overall||5)*5;
  state.totalXp+=bonusXp;
  state.dailyXp+=bonusXp;

  if(report.grammar>=7 && report.vocabulary>=6){
    state.noGrammarErrorConvCount=(state.noGrammarErrorConvCount||0)+1;
  }

  const skills=state.skillScores;
  skills.speaking+=Math.round((report.fluency||5)/2);
  skills.grammar+=Math.round((report.grammar||5)/2);
  skills.vocabulary+=Math.round((report.vocabulary||5)/2);
  skills.fluency+=Math.round((report.fluency||5)/2);
  skills.listening+=Math.round((report.pragmatics||5)/3);

  saveState();
  updateHeader();

  const scoreLabels=[{key:'fluency',label:'유창성'},{key:'vocabulary',label:'어휘력'},{key:'grammar',label:'문법'},{key:'pronunciation_effort',label:'발음 노력'},{key:'pragmatics',label:'화용론'},{key:'overall',label:'종합'}];

  function barColor(v){
    if(v>=8) return 'var(--success)';
    if(v>=5) return 'var(--warning)';
    return 'var(--danger)';
  }

  card.innerHTML=`
    <div class="conv-report-title">📊 대화 분석 리포트</div>
    ${scoreLabels.map(s=>{
      const v=report[s.key]||0;
      return `<div class="conv-score-row">
        <span class="conv-score-label">${s.label}</span>
        <div class="conv-score-bar-bg"><div class="conv-score-bar" style="width:${v*10}%;background:${barColor(v)}"></div></div>
        <span class="conv-score-val">${v}/10</span>
      </div>`;
    }).join('')}
    <div class="conv-section">
      <h4 style="color:var(--success);">💚 잘한 점</h4>
      ${(report.strengths||[]).map(s=>`<div class="conv-strength">${s}</div>`).join('')||'<div class="conv-strength">분석 결과 없음</div>'}
    </div>
    <div class="conv-section">
      <h4 style="color:var(--warning);">💛 개선할 점</h4>
      ${(report.improvements||[]).map(s=>`<div class="conv-improve">${s}</div>`).join('')||'<div class="conv-improve">분석 결과 없음</div>'}
    </div>
    ${report.example_correction?`
    <div class="conv-section">
      <h4>✏️ 교정 예시</h4>
      <div class="conv-correction">
        <s>${report.example_correction.original||''}</s><br>
        → <strong>${report.example_correction.corrected||''}</strong><br>
        <span style="color:var(--text-secondary);">${report.example_correction.explanation||''}</span>
      </div>
    </div>`:''}
    <div style="text-align:center;margin-top:16px;">
      <div class="xp-gain">+${bonusXp} XP</div>
      <button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="document.getElementById('convReportOverlay').classList.remove('active')">확인</button>
    </div>`;

  checkAchievements();
}

// ===== ACHIEVEMENT SYSTEM =====
const ACHIEVEMENTS=[
  {id:'ach_chatterer',emoji:'🗣️',name:'수다쟁이',desc:'Free Talk 10회 완료',reward:50,
    check:()=>(state.activityCounts.freetalk||0)>=10,progress:()=>({cur:state.activityCounts.freetalk||0,max:10})},
  {id:'ach_storyteller',emoji:'📖',name:'이야기꾼',desc:'Story 퀴즈 전부 정답 5회',reward:50,
    check:()=>(state.achievements.progress.ach_storyteller||0)>=5,progress:()=>({cur:state.achievements.progress.ach_storyteller||0,max:5})},
  {id:'ach_flame',emoji:'🔥',name:'불꽃 학습자',desc:'7일 연속 스트릭',reward:100,
    check:()=>state.streak>=7,progress:()=>({cur:Math.min(state.streak,7),max:7})},
  {id:'ach_perfectionist',emoji:'🎯',name:'완벽주의자',desc:'Echo 100% 점수 10회',reward:80,
    check:()=>(state.perfectEchoCount||0)>=10,progress:()=>({cur:state.perfectEchoCount||0,max:10})},
  {id:'ach_global',emoji:'🌍',name:'세계 시민',desc:'Lv.3 도달',reward:100,
    check:()=>state.level>=3,progress:()=>({cur:Math.min(state.level,3),max:3})},
  {id:'ach_master',emoji:'🏆',name:'마스터',desc:'Lv.5 도달',reward:200,
    check:()=>state.level>=5,progress:()=>({cur:Math.min(state.level,5),max:5})},
  {id:'ach_grammar_king',emoji:'📝',name:'문법왕',desc:'문법 교정 없이 대화 5회',reward:60,
    check:()=>(state.noGrammarErrorConvCount||0)>=5,progress:()=>({cur:state.noGrammarErrorConvCount||0,max:5})},
  {id:'ach_actor',emoji:'🎭',name:'배우',desc:'RolePlay 15회 완료',reward:80,
    check:()=>(state.activityCounts.roleplay||0)>=15,progress:()=>({cur:state.activityCounts.roleplay||0,max:15})},
  {id:'ach_speed',emoji:'⚡',name:'스피드 러너',desc:'하루에 세션 3회',reward:40,
    check:()=>(state.dailySessions||0)>=3,progress:()=>({cur:Math.min(state.dailySessions||0,3),max:3})},
  {id:'ach_persistence',emoji:'🌱',name:'꾸준함의 힘',desc:'총 XP 10000 달성',reward:200,
    check:()=>state.totalXp>=10000,progress:()=>({cur:Math.min(state.totalXp,10000),max:10000})}
];

function checkAchievements(){
  if(!state.achievements) state.achievements={unlocked:[],progress:{},dates:{}};
  if(!state.achievements.dates) state.achievements.dates={};
  let newlyUnlocked=null;
  for(const ach of ACHIEVEMENTS){
    if(state.achievements.unlocked.includes(ach.id)) continue;
    if(ach.check()){
      state.achievements.unlocked.push(ach.id);
      state.achievements.dates[ach.id]=new Date().toLocaleDateString('ko-KR');
      state.totalXp+=ach.reward;
      state.dailyXp+=ach.reward;
      if(!newlyUnlocked) newlyUnlocked=ach;
    }
  }
  saveState();
  if(newlyUnlocked) showAchievementPopup(newlyUnlocked);
}

function showAchievementPopup(ach){
  document.getElementById('achieveEmoji').textContent=ach.emoji;
  document.getElementById('achieveName').textContent=ach.name+' 달성!';
  document.getElementById('achieveDesc').textContent=ach.desc;
  document.getElementById('achieveXp').textContent='+'+ach.reward+' XP';
  const cc=document.getElementById('confettiContainer');
  cc.innerHTML='';
  const colors=['#EF4444','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899'];
  for(let i=0;i<20;i++){
    const p=document.createElement('div');
    p.className='confetti-piece';
    p.style.left=Math.random()*100+'%';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDelay=(Math.random()*1)+'s';
    p.style.animationDuration=(1.5+Math.random()*1)+'s';
    p.style.width=(4+Math.random()*6)+'px';
    p.style.height=(4+Math.random()*6)+'px';
    p.style.borderRadius=Math.random()>.5?'50%':'2px';
    cc.appendChild(p);
  }
  document.getElementById('achievePopupOverlay').classList.add('active');
  updateHeader();
}

function closeAchievementPopup(){
  document.getElementById('achievePopupOverlay').classList.remove('active');
}

function renderAchievements(){
  const grid=document.getElementById('achievementGrid');
  if(!grid) return;
  if(!state.achievements) state.achievements={unlocked:[],progress:{},dates:{}};
  grid.innerHTML='';
  for(const ach of ACHIEVEMENTS){
    const unlocked=state.achievements.unlocked.includes(ach.id);
    const prog=ach.progress();
    const pct=Math.min(100,Math.round((prog.cur/prog.max)*100));
    const d=document.createElement('div');
    d.className='ach-card'+(unlocked?'':' locked');
    d.innerHTML=`
      <div class="ach-emoji">${ach.emoji}</div>
      <div class="ach-info">
        <h4>${ach.name}</h4>
        <p>${ach.desc}</p>
        ${unlocked
          ?`<div class="ach-date">✅ ${state.achievements.dates[ach.id]||'달성'} · +${ach.reward} XP</div>`
          :`<div class="ach-progress-bar"><div class="ach-fill" style="width:${pct}%"></div></div>
           <p style="font-size:10px;margin-top:2px;">${prog.cur} / ${prog.max}</p>`
        }
      </div>`;
    grid.appendChild(d);
  }
}

// ===== START =====
init();
</script>

<!-- 3D Avatar Module (TalkingHead) -->
<script type="module">
import { TalkingHead } from "talkinghead";

// ===== AVATAR OPTIONS =====
const AVATAR_OPTIONS = [
  {
    id: 'emma',
    name: 'Emma',
    desc: '친절한 여성 코치',
    emoji: '👩‍🏫',
    url: 'https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?morphTargets=ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown&textureSizeLimit=1024&textureFormat=png',
    body: 'F',
    ttsVoice: 'nova'
  },
  {
    id: 'james',
    name: 'James',
    desc: '차분한 남성 코치',
    emoji: '👨‍🏫',
    url: 'https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?morphTargets=ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown&textureSizeLimit=1024&textureFormat=png',
    body: 'M',
    ttsVoice: 'onyx'
  }
];

let avatarAudioCtx = null;
function getAvatarAudioCtx() {
  if (!avatarAudioCtx || avatarAudioCtx.state === 'closed') {
    avatarAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return avatarAudioCtx;
}

function getSelectedAvatar() {
  const id = localStorage.getItem('selectedAvatar') || 'emma';
  return AVATAR_OPTIONS.find(a => a.id === id) || AVATAR_OPTIONS[0];
}

let talkingHead = null;
let avatarReady = false;

// ===== INIT AVATAR =====
async function initAvatar() {
  const container = document.getElementById('avatarContainer');
  if (!container || talkingHead) return;

  container.innerHTML = '<div class="avatar-loading">아바타 로딩중...</div>';

  const selected = getSelectedAvatar();

  try {
    talkingHead = new TalkingHead(container, {
      ttsEndpoint: null,
      ttsApikey: null,
      lipsyncModules: ["en"],
      cameraView: "head",
      cameraDistance: 0,
      lightAmbientIntensity: 2.5,
      lightDirectIntensity: 15,
      modelFPS: 30,
      avatarMood: "happy",
      avatarIdleEyeContact: 0.7,
      avatarSpeakingEyeContact: 0.8,
      avatarSpeakingHeadMove: 0.6
    });

    await talkingHead.showAvatar({
      url: selected.url,
      body: selected.body,
      avatarMood: 'neutral',
      lipsyncLang: 'en'
    }, (ev) => {
      if (ev.lengthComputable) {
        let pct = Math.round(ev.loaded / ev.total * 100);
        let loadDiv = container.querySelector('.avatar-loading');
        if (loadDiv) loadDiv.textContent = '아바타 로딩중... ' + pct + '%';
      }
    });

    let loadDiv = container.querySelector('.avatar-loading');
    if (loadDiv) loadDiv.remove();

    avatarReady = true;
    console.log('3D Avatar loaded successfully');

  } catch (error) {
    console.error('Avatar load error:', error);
    container.innerHTML = '<div class="avatar-loading">아바타 로딩 실패</div>';
    const orbWrapper = document.getElementById('voiceOrbWrapper');
    if (orbWrapper) orbWrapper.style.display = 'flex';
  }
}

// ===== MOOD DETECTION =====
window.detectMoodFromText = function(text) {
  const t = text.toLowerCase();
  if (/great|excellent|perfect|awesome|wonderful|fantastic|well done|good job|amazing|brilliant|congratulations|proud/i.test(t)) return 'happy';
  if (/sorry|sad|unfortunately|difficult|hard time|don't worry|it's okay/i.test(t)) return 'sad';
  if (/wow|really|oh my|incredible|unbelievable|no way|surprised/i.test(t)) return 'happy';
  if (/hmm|let me think|interesting|i wonder|what do you think|how about/i.test(t)) return 'neutral';
  if (/love|heart|sweet|kind|beautiful|lovely/i.test(t)) return 'love';
  return 'neutral';
};

// ===== GESTURE =====
window.triggerAvatarGesture = function(text) {
  const head = talkingHead;
  if (!head || !avatarReady) return;
  const t = text.toLowerCase();
  try {
    if (/great|perfect|awesome|good job|well done|excellent/i.test(t)) {
      head.playGesture('thumbup', 3, false, 800);
    } else if (/hello|hi |hey|welcome|nice to meet/i.test(t)) {
      head.playGesture('handup', 2, false, 800);
    } else if (/for example|let me explain|the point is|remember|important/i.test(t)) {
      head.playGesture('index', 3, false, 800);
    } else if (/exactly|that's right|correct|of course|sure/i.test(t)) {
      head.playGesture('ok', 2, false, 800);
    } else if (/i'm not sure|maybe|it depends|hard to say/i.test(t)) {
      head.playGesture('shrug', 2, false, 800);
    }
  } catch(e) {
    console.log('Gesture not available:', e.message);
  }
};

// ===== OPEN/CLOSE VOICE MODE =====
const originalOpenVoiceMode = window.openVoiceMode;
window.openVoiceMode = function() {
  if (originalOpenVoiceMode) originalOpenVoiceMode();
  if (!talkingHead) {
    initAvatar();
  } else {
    talkingHead.start();
    if (avatarReady) talkingHead.setMood('happy');
  }
};

const originalCloseVoiceMode = window.closeVoiceMode;
window.closeVoiceMode = function() {
  if (originalCloseVoiceMode) originalCloseVoiceMode();
  if (talkingHead) talkingHead.stop();
};

// ===== SET VOICE ORB STATE (extended) =====
const originalSetVoiceOrbState = window.setVoiceOrbState;
window.setVoiceOrbState = function(s) {
  if (originalSetVoiceOrbState) originalSetVoiceOrbState(s);

  // 아바타 mood + 눈맞춤 연동
  const head = talkingHead;
  const ready = avatarReady;
  if (head && ready) {
    try {
      switch(s) {
        case 'listening':
          head.setMood('neutral');
          try { head.makeEyeContact(30000); } catch(e) {}
          break;
        case 'thinking':
          head.setMood('neutral');
          break;
        case 'speaking':
          head.setMood('happy');
          break;
        case 'idle':
          head.setMood('neutral');
          try { head.lookAtCamera(5000); } catch(e) {}
          break;
      }
    } catch(e) {}
  }

  // 탭 버튼 상태 동기화
  const btn = document.getElementById('avatarTapBtn');
  if (!btn) return;
  btn.className = '';
  switch(s) {
    case 'idle':
      btn.innerHTML = '<span style="font-size:20px;">🎤</span> 탭하여 대화 시작';
      break;
    case 'listening':
      btn.classList.add('listening');
      btn.innerHTML = '<span style="font-size:20px;">🔴</span> 듣고 있어요...';
      break;
    case 'thinking':
      btn.classList.add('thinking');
      btn.innerHTML = '<span style="font-size:20px;">🤔</span> 생각 중...';
      break;
    case 'speaking':
      btn.classList.add('speaking');
      btn.innerHTML = '<span style="font-size:20px;">🔊</span> 말하고 있어요...';
      break;
  }
};

// ===== VISIBILITY CHANGE =====
document.addEventListener("visibilitychange", function() {
  if (!talkingHead) return;
  if (document.visibilityState === "visible") {
    talkingHead.start();
  } else {
    talkingHead.stop();
  }
});

// ===== SPEAK WITH AVATAR (OpenAI TTS + lipsync) =====
window.speakWithAvatar = async function(text, lang) {
  const head = talkingHead;
  const ready = avatarReady;

  if (!head || !ready || !window.state || !window.state.apiKey) {
    return window.speak(text, lang);
  }

  let ttsText = window.stripKoreanForTTS ? window.stripKoreanForTTS(text) : text;
  // Remove emojis (TTS reads them aloud as English words)
  ttsText = ttsText.replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{200D}\u{20E3}\u{E0020}-\u{E007F}]/gu, '').trim();
  if (!ttsText || !ttsText.trim()) return;

  try {
    // 감정 분석 후 mood 설정
    const detectedMood = window.detectMoodFromText(text);
    head.setMood(detectedMood);

    // 아바타에 맞는 TTS 음성 선택
    const selected = getSelectedAvatar();
    const ttsVoice = selected.ttsVoice || 'nova';

    // OpenAI TTS API로 음성 생성
    const ttsResponse = await fetch('https://api.openai.com/v1/audio/speech', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + window.state.apiKey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'tts-1',
        input: ttsText,
        voice: ttsVoice,
        response_format: 'wav',
        speed: (window.state.settings && window.state.settings.ttsSpeed) || 0.85
      })
    });

    if (!ttsResponse.ok) {
      throw new Error('TTS API error: ' + ttsResponse.status);
    }

    const audioBlob = await ttsResponse.blob();
    const audioCtx = getAvatarAudioCtx();
    const arrayBuf = await audioBlob.arrayBuffer();
    const decodedAudio = await audioCtx.decodeAudioData(arrayBuf);

    const words = ttsText.split(/\s+/).filter(w => w.length > 0);
    const duration = decodedAudio.duration * 1000;
    const avgWordDuration = words.length > 0 ? duration / words.length : duration;
    const wtimes = words.map((_, i) => Math.round(i * avgWordDuration));
    const wdurations = words.map(() => Math.round(avgWordDuration * 0.9));

    // 립싱크 재생 (올바른 객체 형식)
    head.speakAudio({
      audio: decodedAudio,
      words: words,
      wtimes: wtimes,
      wdurations: wdurations
    }, { lipsyncLang: 'en' });

    // 제스처 트리거
    window.triggerAvatarGesture(text);

    await new Promise(r => setTimeout(r, duration + 500));

    head.setMood('neutral');

  } catch (error) {
    console.warn('Avatar speak fallback:', error.message);
    try { head.setMood('neutral'); } catch(e) {}
    return window.speak(text, lang);
  }
};

// ===== AVATAR SELECTOR =====
function renderAvatarSelector() {
  const container = document.getElementById('avatarSelector');
  if (!container) return;

  const currentId = localStorage.getItem('selectedAvatar') || 'emma';

  container.innerHTML = AVATAR_OPTIONS.map(av => `
    <div onclick="window.selectAvatar('${av.id}')"
         style="flex:1;padding:12px;border-radius:12px;text-align:center;cursor:pointer;transition:all .2s;
                border:2px solid ${av.id === currentId ? 'var(--primary)' : '#E2E8F0'};
                background:${av.id === currentId ? '#EEF2FF' : 'var(--card)'};">
      <div style="font-size:28px;">${av.emoji}</div>
      <div style="font-size:13px;font-weight:600;margin-top:4px;">${av.name}</div>
      <div style="font-size:11px;color:var(--text-secondary);">${av.desc}</div>
    </div>
  `).join('');
}

window.selectAvatar = async function(avatarId) {
  localStorage.setItem('selectedAvatar', avatarId);
  renderAvatarSelector();

  const head = talkingHead;
  if (head && avatarReady) {
    const avatar = AVATAR_OPTIONS.find(a => a.id === avatarId);
    if (avatar) {
      try {
        const container = document.getElementById('avatarContainer');
        if (container) {
          const loadDiv = document.createElement('div');
          loadDiv.className = 'avatar-loading';
          loadDiv.textContent = '아바타 변경중...';
          container.appendChild(loadDiv);
        }

        await head.showAvatar({
          url: avatar.url,
          body: avatar.body,
          avatarMood: 'neutral',
          lipsyncLang: 'en'
        });

        if (container) {
          const ld = container.querySelector('.avatar-loading');
          if (ld) ld.remove();
        }
      } catch(e) {
        console.error('Avatar switch error:', e);
      }
    }
  }
};

// openSettings 확장: 아바타 선택 UI 렌더링
const originalOpenSettings = window.openSettings;
window.openSettings = function() {
  if (originalOpenSettings) originalOpenSettings();
  setTimeout(renderAvatarSelector, 100);
};

// ===== GLOBAL ACCESS =====
window.talkingHead = null;
window.avatarReady = false;
window.getTalkingHead = () => talkingHead;
window.isAvatarReady = () => avatarReady;
</script>
</body>
</html>
